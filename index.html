<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­è¯ç­”é¢˜ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .login-title {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input-group {
            text-align: left;
        }

        .login-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .login-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .login-error.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-left: 10px;
        }

        .navbar-menu-icon {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 5px;
        }

        .navbar-menu-icon span {
            display: block;
            height: 3px;
            background: #667eea;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .navbar-menu-icon.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .navbar-menu-icon.active span:nth-child(2) {
            opacity: 0;
        }

        .navbar-menu-icon.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            position: fixed;
            top: 60px;
            left: -280px;
            width: 280px;
            height: calc(100vh - 60px);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-menu-item a {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            gap: 12px;
        }

        .sidebar-menu-item a:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        .sidebar-menu-item.active a {
            background: #667eea;
            color: white;
        }

        .menu-icon {
            font-size: 20px;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            margin-top: 80px;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .question-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .question-type {
            display: inline-block;
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .question-title {
            font-size: 18px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .sub-question {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .sub-question-title {
            font-size: 16px;
            color: #555;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .options {
            margin: 15px 0;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .option input[type="radio"] {
            margin-right: 12px;
            margin-top: 3px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .option-label {
            flex: 1;
            cursor: pointer;
            line-height: 1.6;
            color: #333;
        }

        .option.selected {
            /* ç§»é™¤é€‰ä¸­æ ·å¼ï¼Œä¸å†æ˜¾ç¤ºè“è‰²è¾¹æ¡† */
            /* border-color: #667eea;
            background: #f0f3ff; */

            /* å¼ºåˆ¶ç§»é™¤ä»»ä½•å¯èƒ½çš„é€‰ä¸­æ ·å¼ï¼Œç¡®ä¿ç§»åŠ¨ç«¯ä¹Ÿä¸ä¼šæ˜¾ç¤º */
            border-color: #e0e0e0 !important;
            background: white !important;
            box-shadow: none !important;
        }

        .option.correct {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .option.wrong {
            border-color: #f44336;
            background: #ffebee;
        }

        .explanation {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .explanation.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-title {
            font-weight: bold;
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .explanation-content {
            color: #555;
            line-height: 1.8;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
        }

        .btn-small {
            font-size: 14px;
            padding: 10px 20px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .reimport-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .reimport-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .result-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            display: none;
        }

        .result-summary.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .quiz-navigation-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-quiz-nav {
            padding: 10px 25px;
            font-size: 14px;
            border-radius: 20px;
            white-space: nowrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-title {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .result-score {
            font-size: 48px;
            font-weight: bold;
            color: #4caf50;
            margin: 20px 0;
        }

        .result-details {
            font-size: 18px;
            color: #666;
            margin: 10px 0;
        }

        .answer-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .answer-indicator.correct {
            background: #4caf50;
            color: white;
        }

        .answer-indicator.wrong {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 18px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .category-item {
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .category-count {
            font-size: 14px;
            color: #666;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
            border-radius: 20px;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        /* é€‰é¢˜å¡æ ·å¼ */
        .question-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .question-selector-overlay.show {
            display: flex;
        }

        .question-selector-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .question-selector-title {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .question-selector-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .question-selector-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .question-selector-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
        }

        .legend-color.unanswered {
            background: #e0e0e0;
            border-color: #ccc;
        }

        .legend-color.correct {
            background: #4caf50;
        }

        .legend-color.wrong {
            background: #f44336;
        }

        .question-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .question-selector-item {
            aspect-ratio: 1;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-selector-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .question-selector-item.unanswered {
            background: #e0e0e0;
            color: #666;
            border: 2px solid #ccc;
        }

        .question-selector-item.correct {
            background: #4caf50;
        }

        .question-selector-item.wrong {
            background: #f44336;
        }

        .question-selector-item.current {
            box-shadow: 0 0 0 3px #667eea;
        }

        /* ä¿®æ”¹ç­”æ¡ˆå¼¹çª—æ ·å¼ */
        .edit-answer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2001;
            animation: fadeIn 0.3s ease;
        }

        .edit-answer-overlay.show {
            display: flex;
        }

        .edit-answer-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .edit-answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .edit-answer-title {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .edit-answer-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .edit-answer-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .edit-answer-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .edit-answer-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .edit-answer-option.selected {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .edit-answer-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #4caf50;
        }

        .edit-answer-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .sub-question-edit {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .sub-question-edit-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .sub-question-explanation-edit {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .sub-question-explanation-edit textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .add-option-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ccc;
        }

        .add-option-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-option-inputs input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .add-option-inputs input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-option-inputs input[type="text"]:first-child {
            flex: 0 0 60px;
            text-align: center;
            text-transform: uppercase;
        }

        .btn-add-option {
            background: #4caf50;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-add-option:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .new-option-indicator {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .explanation-edit-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .explanation-edit-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-top: 10px;
        }

        .explanation-edit-section textarea:focus {
            outline: none;
            border-color: #ffc107;
        }

        .explanation-label {
            font-weight: 600;
            color: #f57c00;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .char-count {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }

        .question-edit-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
        }

        .question-edit-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-top: 10px;
        }

        .question-edit-section textarea:focus {
            outline: none;
            border-color: #2196f3;
        }

        .question-label {
            font-weight: 600;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-question-text-edit {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .sub-question-text-edit input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .sub-question-text-edit input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ç»„åˆç­”é¢˜æ ·å¼ */
        .combined-category-item {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .combined-category-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .combined-category-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .combined-category-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .combined-category-name {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .combined-category-count {
            font-size: 14px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 15px;
        }

        .combined-category-controls {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .combined-category-item.selected .combined-category-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ratio-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .ratio-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .ratio-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-count-preview {
            background: #f0f3ff;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #667eea;
            font-weight: 500;
        }

        .combined-history-item {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .combined-history-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .combined-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .combined-history-date {
            font-size: 14px;
            color: #666;
        }

        .combined-history-score {
            font-size: 18px;
            font-weight: bold;
            color: #4caf50;
        }

        .combined-history-categories {
            font-size: 13px;
            color: #999;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 22px;
            }

            .question-card {
                padding: 20px;
            }

            /* ç§»åŠ¨ç«¯å¯¼èˆªæŒ‰é’®ä¼˜åŒ– */
            .quiz-navigation-buttons {
                gap: 10px;
                margin: 15px 0;
            }

            .btn-quiz-nav {
                padding: 8px 20px;
                font-size: 12px;
                border-radius: 15px;
                flex: 1;
                min-width: 80px;
            }

            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin: 10px 0;
            }

            .reimport-btn {
                bottom: 10px;
                right: 10px;
                font-size: 14px;
                padding: 8px 16px;
            }

            .question-selector-panel {
                width: 95%;
                padding: 20px;
            }

            .question-selector-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }

            .question-selector-legend {
                flex-direction: column;
                gap: 10px;
            }

            .edit-answer-panel {
                width: 95%;
                padding: 20px;
            }

            .add-option-inputs {
                flex-direction: column;
            }

            /* ç§»åŠ¨ç«¯å¼ºåˆ¶ç§»é™¤é€‰é¡¹é€‰ä¸­æ ·å¼ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°é€‰ä¸­è¾¹æ¡† */
            .option.selected {
                border-color: #e0e0e0 !important;
                background: white !important;
                box-shadow: none !important;
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            .option:focus {
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            #category-actions {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            #category-actions .btn {
                margin: 0 !important;
                width: 90%;
                max-width: 400px;
            }

            /* ç§»åŠ¨ç«¯é…ç½®åˆ†ç±»é€‰æ‹©å™¨ä¼˜åŒ– */
            .config-category-selector {
                flex-wrap: wrap !important;
            }

            .config-category-selector select {
                min-width: 150px !important;
                flex: 1 1 auto;
            }

            .config-category-selector input[type="number"] {
                min-width: 80px !important;
                flex: 0 1 auto;
            }

            .config-category-selector .btn {
                margin: 5px 0 !important;
                width: auto;
            }

            /* ç»„åˆé…ç½®ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
            #config-list-select {
                min-width: 150px !important;
            }

            #saved-combinations-select {
                min-width: 150px !important;
            }

            /* ç»„åˆé…ç½®çš„flexå®¹å™¨ä¼˜åŒ– */
            #saved-combinations-select {
                flex: 1 1 150px !important;
            }

            /* è‡ªå®šä¹‰é…ç½®çš„åˆ†ç±»ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
            .category-dropdown {
                min-width: 150px !important;
                flex: 1 1 150px !important;
            }

            /* ç­”é¢˜å†å²è®°å½•ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
            #quiz-history-select {
                min-width: 150px !important;
                flex: 1 1 150px !important;
            }

            /* æ™ºèƒ½é€‰é¢˜ç»Ÿè®¡ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
            #selection-stats-history-select {
                min-width: 150px !important;
                flex: 1 1 150px !important;
            }
        }

        /* é™åˆ¶ä¸‹æ‹‰æ¡†é€‰é¡¹æ•°é‡å’Œé«˜åº¦ */
        select {
            /* åŸºç¡€æ ·å¼ä¼˜åŒ– */
            max-height: 400px;
            overflow-y: auto;
        }

        /* ç‰¹å®šä¸‹æ‹‰æ¡†çš„ä¼˜åŒ– */
        #quiz-history-select,
        #selection-stats-history-select,
        #config-list-select,
        #saved-combinations-select,
        #category-select,
        #progress-category-select {
            /* ä½¿ç”¨sizeå±æ€§æ§åˆ¶æ˜¾ç¤ºçš„é€‰é¡¹æ•°é‡ */
            max-height: 300px;
        }

        /* ç¾åŒ–selectæ»šåŠ¨æ¡ */
        select::-webkit-scrollbar {
            width: 8px;
        }

        select::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        select::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        select::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå½“é€‰é¡¹è¿‡å¤šæ—¶æ˜¾ç¤ºæç¤º */
        select option:first-child {
            font-weight: 600;
            color: #667eea;
        }

        /* ä¼˜åŒ–é€‰é¡¹çš„æ˜¾ç¤º */
        select option {
            padding: 8px 12px;
            line-height: 1.5;
        }

        select option:hover {
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2 class="login-title">ç™»å½•ç³»ç»Ÿ</h2>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="login-input-group">
                    <label class="login-label" for="username">ç”¨æˆ·å</label>
                    <input type="text" class="login-input" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="login-input-group">
                    <label class="login-label" for="password">å¯†ç </label>
                    <input type="password" class="login-input" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="login-btn">ç™»å½•</button>
                <div class="login-error" id="loginError">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</div>
            </form>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-menu-icon" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="navbar-brand">ä¸­è¯ç­”é¢˜ç³»ç»Ÿ</div>
    </nav>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item active">
                <a href="#" onclick="navigateTo('home', event); return false;">
                    <span class="menu-icon">ğŸ“š</span>
                    <span>é¢˜åº“åˆ—è¡¨</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('import', event); return false;">
                    <span class="menu-icon">â•</span>
                    <span>å¯¼å…¥æ–°é¢˜åº“</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('export', event); return false;">
                    <span class="menu-icon">ğŸ“¤</span>
                    <span>å¯¼å‡ºæ‰€æœ‰æ•°æ®</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('import-data', event); return false;">
                    <span class="menu-icon">ğŸ“¥</span>
                    <span>å¯¼å…¥æ•°æ®</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('wrong-questions', event); return false;">
                    <span class="menu-icon">ğŸ“</span>
                    <span>é”™é¢˜ç»ƒä¹ </span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('combined-quiz', event); return false;">
                    <span class="menu-icon">ğŸ¯</span>
                    <span>ç»„åˆç­”é¢˜</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('combination-config', event); return false;">
                    <span class="menu-icon">âš™ï¸</span>
                    <span>ç»„åˆé…ç½®</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('selection-stats', event); return false;">
                    <span class="menu-icon">ğŸ“ˆ</span>
                    <span>é€‰é¢˜ç»Ÿè®¡</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('statistics', event); return false;">
                    <span class="menu-icon">ğŸ“Š</span>
                    <span>å­¦ä¹ ç»Ÿè®¡</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" onclick="navigateTo('combo-records', event); return false;">
                    <span class="menu-icon">ğŸ¯ğŸ“‹</span>
                    <span>150é¢˜è®°å½•</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¢˜åº“åˆ—è¡¨é¡µé¢ -->
        <div id="page-home" class="page active">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">é€‰æ‹©é¢˜åº“åˆ†ç±»</h2>

                    <div style="margin: 30px 0;">
                        <label style="display: block; margin-bottom: 12px; color: #333; font-weight: 500; font-size: 16px;">
                            è¯·é€‰æ‹©é¢˜åº“ï¼š
                        </label>
                        <select id="category-select"
                                style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer; color: #333; transition: all 0.3s ease;"
                                onchange="handleCategorySelect()"
                                onfocus="this.style.borderColor='#667eea'"
                                onblur="this.style.borderColor='#e0e0e0'">
                            <option value="">-- è¯·é€‰æ‹©é¢˜åº“åˆ†ç±» --</option>
                        </select>
                    </div>

                    <div id="category-actions" style="text-align: center; margin-top: 20px; display: none;">
                        <button class="btn btn-primary" onclick="startSelectedCategory()" style="min-width: 200px; font-size: 18px;">
                            å¼€å§‹ç­”é¢˜
                        </button>
                        <button class="btn btn-delete" onclick="confirmDeleteSelectedCategory()" style="margin-left: 15px; min-width: 200px; font-size: 18px;">
                            åˆ é™¤æ­¤é¢˜åº“
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æ–°é¢˜åº“é¡µé¢ -->
        <div id="page-import" class="page">
            <div class="container">
                <div class="question-card" style="text-align: center;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">å¯¼å…¥é¢˜åº“</h2>
                    <p style="color: #666; margin-bottom: 20px;">è¯·é€‰æ‹© JSON æ–‡ä»¶å¯¼å…¥é¢˜ç›®</p>

                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; color: #333; font-weight: 500;">åˆ†ç±»åç§°ï¼š</label>
                        <input type="text" id="category-input" placeholder="ä¾‹å¦‚ï¼šä¸­è¯å­¦ã€æ–¹å‰‚å­¦"
                               style="width: 60%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                    </div>

                    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div id="upload-status" style="margin-top: 15px; color: #666;"></div>
                </div>
            </div>
        </div>

        <!-- å¯¼å‡ºæ•°æ®é¡µé¢ -->
        <div id="page-export" class="page">
            <div class="container">
                <div class="question-card" style="text-align: center;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">å¯¼å‡ºæ‰€æœ‰æ•°æ®</h2>
                    <p style="color: #666; margin-bottom: 30px;">å¯¼å‡ºåŒ…å«æ‰€æœ‰é¢˜åº“å’Œé”™é¢˜çš„å¤‡ä»½æ–‡ä»¶</p>

                    <button class="btn btn-primary" onclick="exportAllData()" style="padding: 15px 40px; font-size: 18px;">
                        ğŸ“¤ å¯¼å‡ºæ•°æ®
                    </button>

                    <button class="btn btn-danger" onclick="confirmClearAllData()" style="padding: 15px 40px; font-size: 18px; background-color: #f44336; margin-top: 15px;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                    </button>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                        <h3 style="color: #333; margin-bottom: 15px;">å¯¼å‡ºè¯´æ˜ï¼š</h3>
                        <ul style="color: #666; line-height: 1.8; padding-left: 20px;">
                            <li>å¯¼å‡ºæ–‡ä»¶ä¸º JSON æ ¼å¼</li>
                            <li>åŒ…å«æ‰€æœ‰é¢˜åº“åˆ†ç±»å’Œé¢˜ç›®</li>
                            <li>åŒ…å«æ‰€æœ‰é”™é¢˜è®°å½•</li>
                            <li>å¯ç”¨äºæ•°æ®å¤‡ä»½å’Œè¿ç§»</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æ•°æ®é¡µé¢ -->
        <div id="page-import-data" class="page">
            <div class="container">
                <div class="question-card" style="text-align: center;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">å¯¼å…¥æ•°æ®</h2>
                    <p style="color: #666; margin-bottom: 30px;">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</p>

                    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="importAllData(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('import-file-input').click()" style="padding: 15px 40px; font-size: 18px;">
                        ğŸ“¥ é€‰æ‹©å¤‡ä»½æ–‡ä»¶
                    </button>

                    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107; text-align: left;">
                        <h3 style="color: #f57c00; margin-bottom: 15px;">âš ï¸ é‡è¦æç¤ºï¼š</h3>
                        <ul style="color: #666; line-height: 1.8; padding-left: 20px;">
                            <li>å¯¼å…¥æ—¶ä¼šè¯¢é—®æ˜¯å¦åˆå¹¶æˆ–è¦†ç›–ç°æœ‰æ•°æ®</li>
                            <li>åˆå¹¶ï¼šä¿ç•™ç°æœ‰æ•°æ®ï¼Œæ·»åŠ æ–°æ•°æ®</li>
                            <li>è¦†ç›–ï¼šåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œä»…ä¿ç•™å¯¼å…¥çš„æ•°æ®</li>
                            <li>å»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- é”™é¢˜ç»ƒä¹ é¡µé¢ -->
        <div id="page-wrong-questions" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #f44336; margin-bottom: 20px; text-align: center;">é”™é¢˜æœ¬ - é€‰æ‹©åˆ†ç±»</h2>
                    <div id="wrong-question-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- é”™é¢˜åˆ†ç±»åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å­¦ä¹ ç»Ÿè®¡é¡µé¢ -->
        <div id="page-statistics" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡åˆ†æ</h2>

                    <!-- åˆ†ç±»é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <div style="margin-bottom: 30px; text-align: center;">
                        <label style="display: block; margin-bottom: 12px; color: #333; font-weight: 500; font-size: 18px;">
                            é€‰æ‹©åˆ†ç±»æŸ¥çœ‹è¿›æ­¥æ•°æ®ï¼š
                        </label>
                        <select id="progress-category-select"
                                style="width: 300px; max-width: 90%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer; color: #333; transition: all 0.3s ease;"
                                onchange="showProgressData()"
                                onfocus="this.style.borderColor='#667eea'"
                                onblur="this.style.borderColor='#e0e0e0'">
                            <option value="">-- è¯·é€‰æ‹©åˆ†ç±» --</option>
                        </select>
                    </div>

                    <!-- è¿›æ­¥æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                    <div id="progress-data-display" style="margin-top: 20px;">
                        <!-- è¿›æ­¥æ•°æ®å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- æ€»ä½“ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div id="overall-stats" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <!-- æ€»ä½“ç»Ÿè®¡æ•°æ® -->
                    </div>
                </div>
            </div>
        </div>

        <!-- é€‰é¢˜ç»Ÿè®¡é¡µé¢ -->
        <div id="page-selection-stats" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">ğŸ“ˆ æ™ºèƒ½é€‰é¢˜ç»Ÿè®¡</h2>

                    <!-- ç»Ÿè®¡é€‰æ‹©åŒºåŸŸ -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">é€‰æ‹©æŸ¥çœ‹å†å²é€‰é¢˜ç»Ÿè®¡ï¼š</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="selection-stats-history-select"
                                    style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; background: white;"
                                    onchange="showSelectionStats()">
                                <option value="">-- é€‰æ‹©ç­”é¢˜è®°å½•æŸ¥çœ‹é€‰é¢˜ç»Ÿè®¡ --</option>
                            </select>
                            <button class="btn btn-delete btn-small"
                                    onclick="deleteSelectedSelectionStats()"
                                    id="delete-selection-stats-btn"
                                    disabled
                                    style="padding: 12px 20px;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡è¯¦æƒ…æ˜¾ç¤º -->
                    <div id="selection-stats-details" style="display: none;">
                        <!-- æ€»ä½“ç»Ÿè®¡ -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white;">
                            <h3 style="margin: 0 0 20px 0; text-align: center;">ğŸ“Š æ€»ä½“ç»Ÿè®¡</h3>
                            <div id="stats-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 20px; text-align: center;">
                                <!-- ç»Ÿè®¡æ•°æ®å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- åˆ†ç±»è¯¦æƒ… -->
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“‚ åˆ†ç±»è¯¦æƒ…</h3>
                            <div id="stats-categories">
                                <!-- åˆ†ç±»è¯¦æƒ…å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡æ±‡æ€» -->
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š ç­”é¢˜è¿›åº¦æ€»è§ˆ</h3>
                        <div id="overall-progress">
                            <!-- æ€»ä½“è¿›åº¦å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»„åˆé…ç½®é¡µé¢ -->
        <div id="page-combination-config" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">âš™ï¸ ç»„åˆé…ç½®ç®¡ç†</h2>

                    <!-- ä¿å­˜çš„ç»„åˆé…ç½®ç®¡ç† -->
                    <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 20px; font-size: 20px;">ğŸ“š å·²ä¿å­˜çš„ç»„åˆé…ç½®</h3>

                        <div style="margin-bottom: 20px;">
                            <select id="config-list-select"
                                    style="width: 100%; min-width: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; background: white;"
                                    onchange="showConfigDetails()">
                                <option value="">-- é€‰æ‹©é…ç½®æŸ¥çœ‹è¯¦æƒ… --</option>
                            </select>
                        </div>

                        <!-- é…ç½®è¯¦æƒ…æ˜¾ç¤ºåŒº -->
                        <div id="config-details" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-top: 20px;">
                            <!-- è¯¦æƒ…å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="loadConfigToQuiz()" id="load-config-btn" disabled>
                                åº”ç”¨åˆ°ç­”é¢˜
                            </button>
                            <button class="btn btn-delete" onclick="deleteSelectedConfig()" id="delete-config-btn" disabled>
                                åˆ é™¤é…ç½®
                            </button>
                        </div>
                    </div>

                    <!-- åˆ›å»ºæ–°é…ç½® -->
                    <div style="background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 20px; font-size: 20px;">âœ¨ åˆ›å»ºæ–°é…ç½®</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">é…ç½®åç§°ï¼š</label>
                            <input type="text" id="new-config-name"
                                   placeholder="è¾“å…¥é…ç½®åç§°ï¼Œå¦‚ï¼šä¸€å•å…ƒã€é‡ç‚¹ç« èŠ‚ç­‰"
                                   style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;"
                                   onkeyup="checkNewConfigName()">
                        </div>

                        <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500; color: #555;">é€‰æ‹©é¢˜åº“åˆ†ç±»ï¼š</label>
                            <div id="config-category-selection" style="min-height: 100px; padding: 15px; border: 2px dashed #e0e0e0; border-radius: 8px;">
                                <!-- åˆ†ç±»é€‰æ‹©å™¨å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn btn-secondary" onclick="addConfigCategorySelector()">
                                    + æ·»åŠ åˆ†ç±»
                                </button>
                                <button class="btn btn-success" onclick="autoDistributeConfigQuestionCounts(); updateConfigDistribution(); checkNewConfigName();" style="background: #4caf50;">
                                    ğŸ”„ è‡ªåŠ¨åˆ†é…æ¯”ä¾‹
                                </button>
                            </div>
                        </div>

                        <!-- é¢˜ç›®åˆ†é…é¢„è§ˆ -->
                        <div id="config-distribution-preview" style="display: none; padding: 20px; background: #f0f3ff; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">é¢˜ç›®åˆ†é…é¢„è§ˆ</h4>
                            <div id="config-distribution-content">
                                <!-- åˆ†é…é¢„è§ˆå°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- ä¿å­˜æŒ‰é’® -->
                        <div style="text-align: center;">
                            <button class="btn btn-primary" onclick="saveNewConfig()" id="save-new-config-btn" disabled style="min-width: 200px; font-size: 18px;">
                                ä¿å­˜é…ç½®
                            </button>
                        </div>
                    </div>

                    <!-- å†å²è®°å½•ç®¡ç† -->
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 20px; font-size: 20px;">ğŸ“Š ç­”é¢˜å†å²è®°å½•</h3>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <select id="quiz-history-select"
                                    style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; background: white;"
                                    onchange="showSelectedQuizHistory()">
                                <option value="">-- é€‰æ‹©å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ… --</option>
                            </select>
                            <button class="btn btn-delete btn-small"
                                    onclick="deleteSelectedQuizHistory()"
                                    id="delete-history-btn"
                                    disabled
                                    style="padding: 12px 20px;">
                                åˆ é™¤
                            </button>
                        </div>

                        <!-- é€‰ä¸­è®°å½•çš„è¯¦æƒ…æ˜¾ç¤º -->
                        <div id="selected-history-details" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <!-- è¯¦æƒ…å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                        <div id="quiz-history-stats" style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
                            <!-- ç»Ÿè®¡ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»„åˆç­”é¢˜é¡µé¢ -->
        <div id="page-combined-quiz" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">ğŸ¯ ç»„åˆç­”é¢˜æ¨¡å¼</h2>

                    <div style="background: #f0f3ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <p style="color: #333; font-size: 16px; line-height: 1.6; margin: 0;">
                            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                            1. ä½¿ç”¨å¿«é€Ÿé…ç½®æˆ–è‡ªå®šä¹‰é€‰æ‹©é¢˜åº“åˆ†ç±»<br>
                            2. ä¸ºæ¯ä¸ªåˆ†ç±»è®¾ç½®é¢˜ç›®æ•°é‡<br>
                            3. ç³»ç»Ÿå°†è‡ªåŠ¨ç»„åˆæˆ150é¢˜è¿›è¡Œç­”é¢˜<br>
                            4. å¯ä¿å­˜å¸¸ç”¨ç»„åˆé…ç½®ä¾›ä¸‹æ¬¡ä½¿ç”¨
                        </p>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="smart-select-enabled" checked
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="color: #667eea; font-weight: 500;">
                                    ğŸ¯ æ™ºèƒ½é€‰é¢˜ï¼šä¼˜å…ˆé€‰æ‹©æœªç­”è¿‡çš„é¢˜ç›®
                                </span>
                            </label>
                            <p style="margin: 5px 0 0 28px; color: #666; font-size: 14px;">
                                å¼€å¯åç³»ç»Ÿä¼šä¼˜å…ˆé€‰æ‹©æ‚¨æœªç­”è¿‡çš„é¢˜ç›®ï¼Œå¸®åŠ©æ‚¨æ›´å…¨é¢åœ°å­¦ä¹ 
                            </p>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿé…ç½®åŒºåŸŸ -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">âš¡ å¿«é€Ÿé…ç½®</h3>

                        <!-- å·²ä¿å­˜çš„ç»„åˆé…ç½® -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">é€‰æ‹©å·²ä¿å­˜çš„ç»„åˆï¼š</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="saved-combinations-select"
                                        style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; background: white;"
                                        onchange="loadSavedCombination()">
                                    <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ç»„åˆ --</option>
                                </select>
                                <button class="btn btn-delete btn-small"
                                        onclick="deleteSelectedCombination()"
                                        id="delete-combination-btn"
                                        disabled
                                        style="padding: 12px 20px;">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
					<!-- æ“ä½œæŒ‰é’® -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="resetCombinedQuizSelection()" style="margin-right: 15px;">
                            é‡ç½®é€‰æ‹©
                        </button>
                        <button class="btn btn-primary" onclick="startCombinedQuiz()" id="start-combined-quiz-btn" disabled style="min-width: 200px; font-size: 18px;">
                            å¼€å§‹ç»„åˆç­”é¢˜
                        </button>
                    </div>
                    </div>

                    <!-- è‡ªå®šä¹‰é…ç½®åŒºåŸŸ -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“ è‡ªå®šä¹‰é…ç½®</h3>

                        <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
                        <div id="category-selection-area">
                            <!-- åŠ¨æ€æ·»åŠ çš„åˆ†ç±»é€‰æ‹©å™¨ -->
                        </div>

                        <!-- æ·»åŠ åˆ†ç±»å’Œè‡ªåŠ¨åˆ†é…æŒ‰é’® -->
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="addCategorySelector()" style="flex: 1;">
                                â• æ·»åŠ åˆ†ç±»
                            </button>
                            <button class="btn btn-success" onclick="autoDistributeRatios()" style="flex: 1; background: #4caf50;">
                                ğŸ”„ è‡ªåŠ¨åˆ†é…æ¯”ä¾‹
                            </button>
                        </div>
                    </div>

                    <!-- é¢˜ç›®åˆ†é…æ˜¾ç¤º -->
                    <div id="question-distribution" style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š é¢˜ç›®åˆ†é…é¢„è§ˆ</h3>
                        <div id="distribution-details">
                            <!-- åˆ†é…è¯¦æƒ…å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                            <strong style="color: #667eea;">æ€»é¢˜æ•°ï¼š<span id="total-combined-questions">0</span> / 150é¢˜</strong>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 150é¢˜è®°å½•é¡µé¢ -->
        <div id="page-combo-records" class="page">
            <div class="container">
                <div class="question-card">
                    <h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">ğŸ¯ğŸ“‹ 150é¢˜ç­”é¢˜è®°å½•</h2>

                    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                    <div id="combo-records-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="total-combo-quizzes">0</div>
                            <div style="font-size: 12px; margin-top: 5px;">æ€»ç­”é¢˜æ¬¡æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 10px; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="avg-combo-score">0%</div>
                            <div style="font-size: 12px; margin-top: 5px;">å¹³å‡åˆ†</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 10px; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="best-combo-score">0%</div>
                            <div style="font-size: 12px; margin-top: 5px;">æœ€é«˜åˆ†</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border-radius: 10px; color: white;">
                            <div style="font-size: 28px; font-weight: bold;" id="latest-combo-score">--</div>
                            <div style="font-size: 12px; margin-top: 5px;">æœ€æ–°æˆç»©</div>
                        </div>
                    </div>

                    <!-- æˆç»©å¯¹æ¯”åˆ†æ -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“ˆ æˆç»©å¢é•¿è¶‹åŠ¿</h3>
                        <div id="score-trend-chart" style="width: 100%; height: 300px; position: relative; background: #f8f9fa; border-radius: 8px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px 0; gap: 8px; overflow-x: auto;">
                            <!-- è¶‹åŠ¿å›¾è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- æˆç»©å¢é•¿å¯¹æ¯” -->
                    <div style="background: #f0f3ff; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“Š æˆç»©å¢é•¿åˆ†æ</h3>
                        <div id="score-growth-analysis" style="color: #666; line-height: 1.8;">
                            <!-- å¢é•¿åˆ†ææ•°æ®å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- æˆç»©è®°å½•åˆ—è¡¨ -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">ğŸ“ å®Œæ•´è®°å½•</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; text-align: center;">
                                <thead>
                                    <tr style="background: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                        <th style="padding: 12px; text-align: left;">ç­”é¢˜æ—¶é—´</th>
                                        <th style="padding: 12px;">æˆç»©</th>
                                        <th style="padding: 12px;">æ­£ç¡®ç‡</th>
                                        <th style="padding: 12px;">ç­”å¯¹é¢˜æ•°</th>
                                        <th style="padding: 12px;">ç”¨æ—¶</th>
                                        <th style="padding: 12px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="combo-records-table-body">
                                    <!-- æˆç»©è®°å½•å°†åŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-records-message" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— 150é¢˜ç­”é¢˜è®°å½•
                        </div>

                        <!-- åˆ†é¡µæ§åˆ¶ -->
                        <div id="combo-records-pagination" style="margin-top: 20px; text-align: center; display: none;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <button onclick="goToComboRecordsPage(1)" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">é¦–é¡µ</button>
                                <button onclick="previousComboRecordsPage()" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¸Šä¸€é¡µ</button>

                                <div style="display: flex; gap: 5px;" id="combo-pagination-numbers">
                                    <!-- é¡µç å°†åŠ¨æ€ç”Ÿæˆ -->
                                </div>

                                <button onclick="nextComboRecordsPage()" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¸‹ä¸€é¡µ</button>
                                <button onclick="goToComboRecordsPage('last')" style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">æœ«é¡µ</button>

                                <span style="color: #666; margin-left: 10px;">ç¬¬ <span id="combo-current-page">1</span> / <span id="combo-total-pages">1</span> é¡µ</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- åŸæœ‰çš„ç­”é¢˜åŒºåŸŸç­‰ -->
        <div class="container">
        <div class="header" id="quiz-header" style="display: none;">
            <h1>ä¸­è¯ç­”é¢˜ç³»ç»Ÿ</h1>
            <div class="progress-info">
                <span>é¢˜ç›®: <span id="current-question">0</span> / <span id="total-questions">0</span></span>
                <span>å·²ç­”: <span id="answered-count">0</span></span>
                <span>æ­£ç¡®ç‡: <span id="accuracy">0%</span></span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- å¯¼èˆªæŒ‰é’®åŒºåŸŸï¼šä¸Šä¸€é¢˜ã€ä¸‹ä¸€é¢˜ã€é€‰é¢˜ -->
        <div id="quiz-navigation" style="display: none;">
            <div class="quiz-navigation-buttons">
                <button class="btn btn-secondary btn-quiz-nav" onclick="openQuestionSelector()">é€‰é¢˜</button>
                <button class="btn btn-secondary btn-quiz-nav" onclick="previousQuestion()" id="prev-btn" style="display: none;">ä¸Šä¸€é¢˜</button>
                <button class="btn btn-primary btn-quiz-nav" onclick="nextQuestion()" id="next-btn">ä¸‹ä¸€é¢˜</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            æ­£åœ¨åŠ è½½é¢˜ç›®...
        </div>

        <div id="error" class="error" style="display: none;">
            åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡æ–°å¯¼å…¥æ–‡ä»¶
        </div>

        <div id="question-container" style="display: none;">
        </div>

        <div id="result-summary" class="result-summary">
            <div class="result-title">ç­”é¢˜å®Œæˆï¼</div>
            <div class="result-score"><span id="final-score">0</span>%</div>
            <div class="result-details">
                <p>æ€»é¢˜æ•°: <span id="result-total">0</span></p>
                <p>æ­£ç¡®: <span id="result-correct">0</span></p>
                <p>é”™è¯¯: <span id="result-wrong">0</span></p>
            </div>
            <div class="buttons">
                <button class="btn btn-primary" onclick="restartQuiz()">é‡æ–°ç­”é¢˜</button>
                <button class="btn btn-secondary" onclick="reviewAnswers()">æŸ¥çœ‹ç­”æ¡ˆ</button>
                <button class="btn btn-secondary" onclick="backToCategoryList()">è¿”å›åˆ†ç±»</button>
            </div>
        </div>

        <button id="reimport-btn" class="reimport-btn" onclick="backToCategoryList()" style="display: none;">
            ğŸ“š è¿”å›åˆ†ç±»
        </button>
    </div>

    <!-- é€‰é¢˜å¡å¼¹çª— -->
    <div id="question-selector-overlay" class="question-selector-overlay" onclick="closeQuestionSelector(event)">
        <div class="question-selector-panel" onclick="event.stopPropagation()">
            <div class="question-selector-header">
                <div class="question-selector-title">ç­”é¢˜å¡</div>
                <button class="question-selector-close" onclick="closeQuestionSelector()">&times;</button>
            </div>

            <div class="question-selector-legend">
                <div class="legend-item">
                    <div class="legend-color unanswered"></div>
                    <span>æœªç­”</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color correct"></div>
                    <span>ç­”å¯¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color wrong"></div>
                    <span>ç­”é”™</span>
                </div>
            </div>

            <div id="question-selector-grid" class="question-selector-grid">
                <!-- é¢˜ç›®ç¼–å·å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç­”æ¡ˆå¼¹çª— -->
    <div id="edit-answer-overlay" class="edit-answer-overlay" onclick="closeEditAnswer(event)">
        <div class="edit-answer-panel" onclick="event.stopPropagation()">
            <div class="edit-answer-header">
                <div class="edit-answer-title">ä¿®æ”¹æ­£ç¡®ç­”æ¡ˆ</div>
                <button class="edit-answer-close" onclick="closeEditAnswer()">&times;</button>
            </div>

            <div id="edit-answer-content">
                <!-- ä¿®æ”¹ç­”æ¡ˆå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="edit-answer-buttons">
                <button class="btn btn-secondary" onclick="closeEditAnswer()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEditedAnswer()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // å¯¼èˆªå’Œä¾§è¾¹æ æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const menuIcon = document.querySelector('.navbar-menu-icon');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            menuIcon.classList.toggle('active');
        }

        function navigateTo(pageName, event) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // éšè—ç­”é¢˜è¿›åº¦æ¡ï¼ˆåˆ‡æ¢é¡µé¢æ—¶é»˜è®¤éšè—ï¼‰
            const quizHeader = document.getElementById('quiz-header');
            if (quizHeader) {
                quizHeader.style.display = 'none';
            }

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const targetPage = document.getElementById('page-' + pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // æ›´æ–°ä¾§è¾¹æ èœå•é¡¹çŠ¶æ€
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // è®¾ç½®å½“å‰èœå•é¡¹ä¸ºæ¿€æ´»çŠ¶æ€ï¼ˆå¦‚æœæœ‰eventï¼‰
            if (event && event.target) {
                const menuItem = event.target.closest('.sidebar-menu-item');
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            } else {
                // å¦‚æœæ²¡æœ‰eventï¼Œæ ¹æ®pageNameè®¾ç½®æ¿€æ´»çŠ¶æ€
                const menuItems = document.querySelectorAll('.sidebar-menu-item a');
                menuItems.forEach(item => {
                    if (item.getAttribute('onclick').includes(`'${pageName}'`)) {
                        item.closest('.sidebar-menu-item').classList.add('active');
                    }
                });
            }

            // å…³é—­ä¾§è¾¹æ ï¼ˆå¦‚æœæ˜¯é€šè¿‡ç‚¹å‡»èœå•è§¦å‘çš„ï¼‰
            if (event) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const menuIcon = document.querySelector('.navbar-menu-icon');

                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                menuIcon.classList.remove('active');
            }

            // æ ¹æ®é¡µé¢æ‰§è¡Œç‰¹å®šé€»è¾‘
            if (pageName === 'home') {
                showCategoryList();
            } else if (pageName === 'wrong-questions') {
                showWrongQuestionCategories();
            } else if (pageName === 'statistics') {
                showStatisticsPage();
            } else if (pageName === 'combined-quiz') {
                showCombinedQuizPage();
            } else if (pageName === 'selection-stats') {
                showSelectionStatsPage();
            } else if (pageName === 'combination-config') {
                showCombinationConfigPage();
            } else if (pageName === 'combo-records') {
                showComboRecordsPage();
            }

            return false; // é˜»æ­¢é“¾æ¥é»˜è®¤è¡Œä¸º
        }

        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let showingResults = false;
        let db;
        let currentCategory = null;
        let optionMappings = []; // å­˜å‚¨æ¯é“é¢˜çš„é€‰é¡¹æ˜ å°„å…³ç³»
        let permanentMappings = {}; // ä½¿ç”¨å¯¹è±¡å­˜å‚¨æ°¸ä¹…çš„é¢˜ç›®æ˜ å°„ï¼Œé”®ä¸ºé¢˜ç›®IDæˆ–å†…å®¹hashï¼Œé˜²æ­¢é‡æ–°åˆå§‹åŒ–æ—¶ä¸¢å¤±æ˜ å°„
        let wrongQuestionIds = []; // å­˜å‚¨é”™é¢˜çš„æ•°æ®åº“IDï¼Œç”¨äºç­”å¯¹ååˆ é™¤
        let isRestoringAnswer = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ¢å¤ç­”æ¡ˆï¼ˆé¿å…é‡å¤è§¦å‘è‡ªåŠ¨è·³è½¬ï¼‰

        // 150é¢˜è®°å½•åˆ†é¡µç›¸å…³å…¨å±€å˜é‡
        let comboRecordsData = []; // å­˜å‚¨æ‰€æœ‰150é¢˜è®°å½•
        let currentComboRecordsPage = 1; // å½“å‰é¡µç 
        let comboRecordsPageSize = 5; // æ¯é¡µ5æ¡è®°å½•

        // åˆå§‹åŒ– IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('QuizDB', 5); // å‡çº§ç‰ˆæœ¬å·åˆ°5

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // åˆ›å»ºåˆ†ç±»å­˜å‚¨
                    if (!db.objectStoreNames.contains('categories')) {
                        const categoryStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                        categoryStore.createIndex('name', 'name', { unique: false });
                    }

                    // åˆ›å»ºé”™é¢˜å­˜å‚¨
                    if (!db.objectStoreNames.contains('wrongQuestions')) {
                        const wrongQuestionsStore = db.createObjectStore('wrongQuestions', { keyPath: 'id', autoIncrement: true });
                        wrongQuestionsStore.createIndex('categoryId', 'categoryId', { unique: false });
                        wrongQuestionsStore.createIndex('categoryName', 'categoryName', { unique: false });
                    }

                    // åˆ›å»ºç­”é¢˜è®°å½•å­˜å‚¨
                    if (!db.objectStoreNames.contains('quizRecords')) {
                        const quizRecordsStore = db.createObjectStore('quizRecords', { keyPath: 'id', autoIncrement: true });
                        quizRecordsStore.createIndex('categoryId', 'categoryId', { unique: false });
                        quizRecordsStore.createIndex('categoryName', 'categoryName', { unique: false });
                        quizRecordsStore.createIndex('quizDate', 'quizDate', { unique: false });
                    }

                    // åˆ›å»ºé¢˜ç›®å†å²è®°å½•å­˜å‚¨ï¼ˆæ–°å¢ï¼‰
                    if (!db.objectStoreNames.contains('questionHistory')) {
                        const historyStore = db.createObjectStore('questionHistory', { keyPath: 'id', autoIncrement: true });
                        historyStore.createIndex('categoryId', 'categoryId', { unique: false });
                        historyStore.createIndex('questionHash', 'questionHash', { unique: false });
                        historyStore.createIndex('lastAnswered', 'lastAnswered', { unique: false });
                        // åˆ›å»ºå¤åˆç´¢å¼•ç”¨äºå¿«é€ŸæŸ¥è¯¢
                        historyStore.createIndex('categoryId_questionHash', ['categoryId', 'questionHash'], { unique: true });
                    }
                };
            });
        }

        // ç”Ÿæˆé¢˜ç›®çš„å”¯ä¸€æ ‡è¯†å“ˆå¸Œ
        function generateQuestionHash(question) {
            // ä½¿ç”¨é¢˜ç›®æ–‡æœ¬å’Œç±»å‹ç”Ÿæˆå”¯ä¸€æ ‡è¯†
            const text = question.question + (question.type || '');
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }

        // è®°å½•é¢˜ç›®ç­”é¢˜å†å²
        async function recordQuestionHistory(categoryId, questions) {
            if (!questions || questions.length === 0) return;

            const transaction = db.transaction(['questionHistory'], 'readwrite');
            const store = transaction.objectStore('questionHistory');
            const now = new Date().toISOString();

            for (let question of questions) {
                const questionHash = generateQuestionHash(question);

                // å…ˆæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨
                const index = store.index('categoryId_questionHash');
                const request = index.get([categoryId, questionHash]);

                await new Promise((resolve, reject) => {
                    request.onsuccess = async () => {
                        const existing = request.result;

                        if (existing) {
                            // æ›´æ–°ç°æœ‰è®°å½•
                            existing.lastAnswered = now;
                            existing.answerCount = (existing.answerCount || 0) + 1;
                            await store.put(existing);
                        } else {
                            // åˆ›å»ºæ–°è®°å½•
                            await store.add({
                                categoryId: categoryId,
                                questionHash: questionHash,
                                questionText: question.question.substring(0, 100), // ä¿å­˜å‰100å­—ç¬¦ç”¨äºè°ƒè¯•
                                lastAnswered: now,
                                answerCount: 1
                            });
                        }
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // è·å–åˆ†ç±»ä¸­æœªç­”è¿‡çš„é¢˜ç›®
        async function getUnansweredQuestions(categoryId, allQuestions) {
            const transaction = db.transaction(['questionHistory'], 'readonly');
            const store = transaction.objectStore('questionHistory');
            const index = store.index('categoryId');

            return new Promise((resolve, reject) => {
                const request = index.getAll(categoryId);

                request.onsuccess = () => {
                    const history = request.result || [];
                    const answeredHashes = new Set(history.map(h => h.questionHash));

                    // åˆ†ç¦»æœªç­”è¿‡å’Œå·²ç­”è¿‡çš„é¢˜ç›®
                    const unanswered = [];
                    const answered = [];

                    for (let question of allQuestions) {
                        const hash = generateQuestionHash(question);
                        if (answeredHashes.has(hash)) {
                            answered.push(question);
                        } else {
                            unanswered.push(question);
                        }
                    }

                    resolve({ unanswered, answered });
                };

                request.onerror = () => reject(request.error);
            });
        }

        // æ™ºèƒ½é€‰æ‹©é¢˜ç›®ï¼ˆä¼˜å…ˆæœªç­”è¿‡çš„ï¼‰
        async function smartSelectQuestions(categoryId, allQuestions, targetCount) {
            try {
                const { unanswered, answered } = await getUnansweredQuestions(categoryId, allQuestions);

                console.log(`åˆ†ç±»${categoryId}: æœªç­”è¿‡${unanswered.length}é¢˜, å·²ç­”è¿‡${answered.length}é¢˜`);

                // æ‰“ä¹±é¢˜ç›®é¡ºåº
                const shuffleArray = (arr) => [...arr].sort(() => Math.random() - 0.5);

                const shuffledUnanswered = shuffleArray(unanswered);
                const shuffledAnswered = shuffleArray(answered);

                const selected = [];

                // ä¼˜å…ˆé€‰æ‹©æœªç­”è¿‡çš„é¢˜ç›®
                const unansweredToTake = Math.min(targetCount, shuffledUnanswered.length);
                selected.push(...shuffledUnanswered.slice(0, unansweredToTake));

                // å¦‚æœæœªç­”è¿‡çš„ä¸å¤Ÿï¼Œä»å·²ç­”è¿‡çš„è¡¥å……
                const remaining = targetCount - selected.length;
                if (remaining > 0 && shuffledAnswered.length > 0) {
                    selected.push(...shuffledAnswered.slice(0, remaining));
                }

                const answeredCount = selected.length - unansweredToTake;
                console.log(`æœ€ç»ˆé€‰æ‹©äº†${selected.length}é¢˜: ${unansweredToTake}é¢˜æœªç­”è¿‡, ${answeredCount}é¢˜å·²ç­”è¿‡`);

                // è¿”å›é€‰é¢˜ä¿¡æ¯ä¾›æ˜¾ç¤º
                selected._selectionInfo = {
                    total: selected.length,
                    unanswered: unansweredToTake,
                    answered: answeredCount,
                    unansweredTotal: unanswered.length,
                    answeredTotal: answered.length
                };

                return selected;
            } catch (error) {
                console.error('æ™ºèƒ½é€‰é¢˜å¤±è´¥ï¼Œä½¿ç”¨éšæœºé€‰æ‹©:', error);
                // å‡ºé”™æ—¶å›é€€åˆ°éšæœºé€‰æ‹©
                const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, targetCount);
            }
        }

        // ä¿å­˜é€‰é¢˜ç»Ÿè®¡ä¿¡æ¯
        function saveSelectionStats(type, info, categoryName) {
            if (!info) return;

            const stats = {
                id: Date.now().toString(),
                type: type, // 'single' or 'combined'
                categoryName: categoryName,
                date: new Date().toISOString(),
                info: info
            };

            // è·å–å·²ä¿å­˜çš„ç»Ÿè®¡
            let savedStats = JSON.parse(localStorage.getItem('selectionStats') || '[]');

            // æ·»åŠ æ–°ç»Ÿè®¡
            savedStats.unshift(stats);

            // æœ€å¤šä¿å­˜50æ¡è®°å½•
            if (savedStats.length > 50) {
                savedStats = savedStats.slice(0, 50);
            }

            localStorage.setItem('selectionStats', JSON.stringify(savedStats));
        }

        // åˆ é™¤é€‰ä¸­çš„é€‰é¢˜ç»Ÿè®¡
        async function deleteSelectedSelectionStats() {
            const selectElement = document.getElementById('selection-stats-history-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                return;
            }

            const stat = JSON.parse(selectedOption.dataset.stat);
            const dateStr = new Date(stat.date).toLocaleString('zh-CN');

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${dateStr} çš„é€‰é¢˜ç»Ÿè®¡è®°å½•å—ï¼Ÿ`)) {
                return;
            }

            // è·å–å·²ä¿å­˜çš„ç»Ÿè®¡
            let savedStats = JSON.parse(localStorage.getItem('selectionStats') || '[]');

            // åˆ é™¤é€‰ä¸­çš„è®°å½•
            savedStats = savedStats.filter(s => s.id !== selectedOption.value);

            // ä¿å­˜æ›´æ–°åçš„ç»Ÿè®¡
            localStorage.setItem('selectionStats', JSON.stringify(savedStats));

            alert('é€‰é¢˜ç»Ÿè®¡è®°å½•å·²åˆ é™¤');

            // é‡æ–°åŠ è½½é¡µé¢
            await showSelectionStatsPage();
        }

        // æ˜¾ç¤ºé€‰é¢˜ç»Ÿè®¡é¡µé¢
        async function showSelectionStatsPage() {
            const savedStats = JSON.parse(localStorage.getItem('selectionStats') || '[]');
            const selectElement = document.getElementById('selection-stats-history-select');

            // æ¸…ç©ºä¸‹æ‹‰æ¡†
            selectElement.innerHTML = '<option value="">-- é€‰æ‹©ç­”é¢˜è®°å½•æŸ¥çœ‹é€‰é¢˜ç»Ÿè®¡ --</option>';

            if (savedStats.length === 0) {
                document.getElementById('overall-progress').innerHTML =
                    '<p style="text-align: center; color: #999;">æš‚æ— é€‰é¢˜ç»Ÿè®¡è®°å½•</p>';
                return;
            }

            // æ·»åŠ é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
            savedStats.forEach(stat => {
                const date = new Date(stat.date);
                const dateStr = date.toLocaleDateString('zh-CN');
                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

                const option = document.createElement('option');
                option.value = stat.id;
                option.dataset.stat = JSON.stringify(stat);

                // æ™ºèƒ½è¯†åˆ«æ˜¾ç¤ºå†…å®¹
                let displayText = stat.categoryName;

                // å¦‚æœæ˜¯ç»„åˆç­”é¢˜ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ç±»å‹æ ‡è¯†
                if (stat.type === 'combined') {
                    // å¦‚æœcategoryNameåŒ…å«é€—å·ï¼Œè¯´æ˜æ˜¯åˆ†ç±»åˆ—è¡¨ï¼Œæ·»åŠ "ç»„åˆç­”é¢˜"å‰ç¼€
                    if (displayText.includes(',') || displayText.includes('ã€')) {
                        // åˆ†å‰²åˆ†ç±»åç§°
                        const categories = displayText.split(/[,ã€]/);
                        const totalCount = categories.length;

                        // é™åˆ¶æ˜¾ç¤ºå‰3ä¸ªåˆ†ç±»
                        if (totalCount > 3) {
                            const firstThree = categories.slice(0, 3).map(c => c.trim()).join(', ');
                            displayText = `ç»„åˆç­”é¢˜ - ${firstThree}ç­‰${totalCount}ä¸ªåˆ†ç±»`;
                        } else {
                            displayText = `ç»„åˆç­”é¢˜ - ${displayText}`;
                        }
                    }
                    // å¦åˆ™ï¼Œå‡å®šæ˜¯ç»„åˆåç§°ï¼Œç›´æ¥æ˜¾ç¤º
                }

                option.textContent = `${dateStr} ${timeStr} - ${displayText}`;

                selectElement.appendChild(option);
            });

            // æ˜¾ç¤ºæ€»ä½“è¿›åº¦
            await showOverallProgress();
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„ç»Ÿè®¡è¯¦æƒ…
        async function showSelectionStats() {
            const selectElement = document.getElementById('selection-stats-history-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const deleteBtn = document.getElementById('delete-selection-stats-btn');

            if (!selectedOption || !selectedOption.value) {
                document.getElementById('selection-stats-details').style.display = 'none';
                deleteBtn.disabled = true;
                // æ¢å¤æ˜¾ç¤ºæ•´ä½“è¿›åº¦
                await showOverallProgress();
                return;
            }

            deleteBtn.disabled = false;

            const stat = JSON.parse(selectedOption.dataset.stat);
            const info = stat.info;

            // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
            document.getElementById('selection-stats-details').style.display = 'block';

            // æ›´æ–°è¿›åº¦æ€»è§ˆï¼Œæ˜¾ç¤ºé€‰ä¸­è®°å½•çš„åˆ†ç±»è¿›åº¦
            let categoryNames = [];
            if (stat.type === 'combined') {
                // ç»„åˆç­”é¢˜
                if (info.combinationName) {
                    // å¦‚æœæœ‰ç»„åˆåç§°ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–å¯¹åº”çš„åˆ†ç±»
                    const savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');
                    const matchedCombination = savedCombinations.find(c => c.name === info.combinationName);
                    if (matchedCombination && matchedCombination.selection) {
                        // ä»ä¿å­˜çš„ç»„åˆé…ç½®ä¸­è·å–åˆ†ç±»IDï¼Œç„¶åè½¬æ¢ä¸ºåˆ†ç±»åç§°
                        const categories = await getAllCategories();
                        for (let catId in matchedCombination.selection) {
                            const cat = categories.find(c => c.id === parseInt(catId));
                            if (cat) {
                                categoryNames.push(cat.name);
                            }
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»„åˆæˆ–æ²¡æœ‰ç»„åˆåç§°ï¼Œä»categoriesä¸­æå–åˆ†ç±»åç§°
                if (categoryNames.length === 0 && info.categories && info.categories.length > 0) {
                    categoryNames = info.categories.map(cat => cat.name);
                }
            } else {
                // å•ç§‘ç­”é¢˜ï¼Œä½¿ç”¨categoryName
                categoryNames = [stat.categoryName];
            }

            // æ›´æ–°è¿›åº¦æ˜¾ç¤ºä¸ºé€‰ä¸­åˆ†ç±»çš„è¿›åº¦
            await showOverallProgress(categoryNames);

            if (stat.type === 'combined') {
                // ç»„åˆç­”é¢˜ç»Ÿè®¡
                const totalRatio = info.selectedUnanswered + info.selectedAnswered > 0
                    ? Math.round((info.selectedUnanswered / (info.selectedUnanswered + info.selectedAnswered)) * 100)
                    : 0;

                // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
                document.getElementById('stats-summary').innerHTML = `
                    <div>
                        <div style="font-size: 32px; font-weight: bold; color: #90EE90;">${info.selectedUnanswered}</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ–°é¢˜ç›®</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold; color: #FFD700;">${info.selectedAnswered}</div>
                        <div style="font-size: 14px; margin-top: 5px;">å¤ä¹ é¢˜</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold;">${info.selectedUnanswered + info.selectedAnswered}</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ€»é¢˜æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold;">${totalRatio}%</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ–°é¢˜ç‡</div>
                    </div>
                `;

                // æ˜¾ç¤ºåˆ†ç±»è¯¦æƒ…
                let categoriesHtml = '';
                if (info.categories && info.categories.length > 0) {
                    info.categories.forEach(cat => {
                        const ratio = cat.total > 0 ? Math.round((cat.unanswered / cat.total) * 100) : 0;
                        const progressBar = `
                            <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 5px 0;">
                                <div style="width: ${ratio}%; height: 100%; background: linear-gradient(90deg, #90EE90, #4caf50); transition: width 0.5s;"></div>
                            </div>
                        `;

                        categoriesHtml += `
                            <div style="padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333;">
                                    ${cat.name}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>é¢˜åº“æ€»é‡ï¼š${cat.unansweredTotal + cat.answeredTotal} é¢˜</div>
                                    <div>æœ¬æ¬¡é€‰æ‹©ï¼š${cat.total} é¢˜</div>
                                    <div>æœªç­”è¿‡ï¼š<span style="color: #4caf50; font-weight: bold;">${cat.unansweredTotal}</span> é¢˜</div>
                                    <div>å·²ç­”è¿‡ï¼š<span style="color: #ff9800; font-weight: bold;">${cat.answeredTotal}</span> é¢˜</div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>æœ¬æ¬¡é€‰é¢˜åˆ†å¸ƒ</span>
                                        <span>${ratio}% æ–°é¢˜</span>
                                    </div>
                                    ${progressBar}
                                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 14px; color: #666;">
                                        <span>æ–°é¢˜ï¼š${cat.unanswered} é¢˜</span>
                                        <span>å¤ä¹ ï¼š${cat.answered} é¢˜</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                document.getElementById('stats-categories').innerHTML = categoriesHtml ||
                    '<p style="text-align: center; color: #999;">æ— åˆ†ç±»è¯¦æƒ…</p>';

            } else {
                // å•ç§‘ç­”é¢˜ç»Ÿè®¡
                const ratio = info.total > 0 ? Math.round((info.unanswered / info.total) * 100) : 0;

                // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
                document.getElementById('stats-summary').innerHTML = `
                    <div>
                        <div style="font-size: 32px; font-weight: bold; color: #90EE90;">${info.unanswered}</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ–°é¢˜ç›®</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold; color: #FFD700;">${info.answered}</div>
                        <div style="font-size: 14px; margin-top: 5px;">å¤ä¹ é¢˜</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold;">${info.total}</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ€»é¢˜æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 32px; font-weight: bold;">${ratio}%</div>
                        <div style="font-size: 14px; margin-top: 5px;">æ–°é¢˜ç‡</div>
                    </div>
                `;

                // æ˜¾ç¤ºé¢˜åº“è¯¦æƒ…
                const progressBar = `
                    <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 10px 0;">
                        <div style="width: ${ratio}%; height: 100%; background: linear-gradient(90deg, #90EE90, #4caf50); transition: width 0.5s;"></div>
                    </div>
                `;

                document.getElementById('stats-categories').innerHTML = `
                    <div style="padding: 20px;">
                        <div style="font-weight: bold; font-size: 18px; margin-bottom: 15px; color: #333;">
                            ${stat.categoryName}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 10px; background: #f0fff4; border-radius: 8px;">
                                <div style="color: #666; font-size: 14px;">é¢˜åº“æœªç­”è¿‡</div>
                                <div style="color: #4caf50; font-size: 24px; font-weight: bold;">${info.unansweredTotal} é¢˜</div>
                            </div>
                            <div style="padding: 10px; background: #fff8e1; border-radius: 8px;">
                                <div style="color: #666; font-size: 14px;">é¢˜åº“å·²ç­”è¿‡</div>
                                <div style="color: #ff9800; font-size: 24px; font-weight: bold;">${info.answeredTotal} é¢˜</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>æœ¬æ¬¡é€‰é¢˜æ–°é¢˜ç‡</span>
                                <span style="font-weight: bold;">${ratio}%</span>
                            </div>
                            ${progressBar}
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 14px; color: #666;">
                                <span>é€‰æ‹©æ–°é¢˜ï¼š${info.unanswered} é¢˜</span>
                                <span>é€‰æ‹©å¤ä¹ ï¼š${info.answered} é¢˜</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ€»ä½“è¿›åº¦ï¼ˆæ”¯æŒæŒ‡å®šåˆ†ç±»ï¼‰
        async function showOverallProgress(specificCategories = null) {
            try {
                const categories = await getAllCategories();
                let totalQuestions = 0;
                let totalAnswered = 0;
                let displayTitle = 'æ•´ä½“å­¦ä¹ è¿›åº¦';

                if (specificCategories && specificCategories.length > 0) {
                    // æ˜¾ç¤ºç‰¹å®šåˆ†ç±»çš„è¿›åº¦
                    displayTitle = 'é€‰ä¸­åˆ†ç±»è¿›åº¦';
                    for (let categoryName of specificCategories) {
                        const category = categories.find(c => c.name === categoryName);
                        if (category) {
                            const { unanswered, answered } = await getUnansweredQuestions(category.id, category.questions);
                            totalQuestions += unanswered.length + answered.length;
                            totalAnswered += answered.length;
                        }
                    }
                } else {
                    // æ˜¾ç¤ºæ‰€æœ‰åˆ†ç±»çš„æ€»ä½“è¿›åº¦
                    for (let category of categories) {
                        const { unanswered, answered } = await getUnansweredQuestions(category.id, category.questions);
                        totalQuestions += unanswered.length + answered.length;
                        totalAnswered += answered.length;
                    }
                }

                const progressPercent = totalQuestions > 0 ? Math.round((totalAnswered / totalQuestions) * 100) : 0;

                document.getElementById('overall-progress').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;">${totalQuestions}</div>
                            <div style="font-size: 14px; color: #666;">é¢˜åº“æ€»é‡</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #4caf50;">${totalAnswered}</div>
                            <div style="font-size: 14px; color: #666;">å·²ç­”é¢˜ç›®</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #ff9800;">${totalQuestions - totalAnswered}</div>
                            <div style="font-size: 14px; color: #666;">æœªç­”é¢˜ç›®</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${displayTitle}</span>
                            <span style="font-weight: bold; color: #667eea;">${progressPercent}%</span>
                        </div>
                        <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                            <div style="width: ${progressPercent}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 1s ease;"></div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error showing overall progress:', error);
                document.getElementById('overall-progress').innerHTML =
                    '<p style="text-align: center; color: #f44336;">åŠ è½½è¿›åº¦å¤±è´¥</p>';
            }
        }

        // æ˜¾ç¤ºæ™ºèƒ½é€‰é¢˜ç»Ÿè®¡ä¿¡æ¯
        function showSelectionInfo(selectionInfo, categoryName) {
            if (!selectionInfo) return;

            // ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
            saveSelectionStats('single', selectionInfo, categoryName);

            // åªåœ¨æ§åˆ¶å°è¾“å‡ºç®€è¦ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºè§†è§‰æ•ˆæœ
            console.log(`æ™ºèƒ½é€‰é¢˜å®Œæˆ - ${categoryName}: æ–°é¢˜${selectionInfo.unanswered}é¢˜, å¤ä¹ ${selectionInfo.answered}é¢˜`);
        }

        // æ˜¾ç¤ºç»„åˆç­”é¢˜é€‰é¢˜ç»Ÿè®¡ä¿¡æ¯
        function showCombinedSelectionInfo(info) {
            if (!info || info.categories.length === 0) return;

            // ä¿å­˜ç»„åˆç­”é¢˜ç»Ÿè®¡ä¿¡æ¯
            // ä¼˜å…ˆä½¿ç”¨ç»„åˆåç§°ï¼Œå¦åˆ™ä½¿ç”¨åˆ†ç±»åˆ—è¡¨
            let displayName;
            if (currentCombinationName) {
                displayName = currentCombinationName;
            } else {
                // å¦‚æœåˆ†ç±»å¤ªå¤šï¼Œé™åˆ¶æ˜¾ç¤º
                const categoryNames = info.categories.map(cat => cat.name);
                if (categoryNames.length > 5) {
                    displayName = categoryNames.slice(0, 5).join(', ') + `ç­‰${categoryNames.length}ä¸ªåˆ†ç±»`;
                } else {
                    displayName = categoryNames.join(', ');
                }
            }

            // åœ¨infoä¸­æ·»åŠ ç»„åˆåç§°ï¼Œæ–¹ä¾¿åç»­æ˜¾ç¤º
            info.combinationName = currentCombinationName;

            saveSelectionStats('combined', info, displayName);

            // åªåœ¨æ§åˆ¶å°è¾“å‡ºç®€è¦ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºè§†è§‰æ•ˆæœ
            console.log(`ç»„åˆç­”é¢˜æ™ºèƒ½é€‰é¢˜å®Œæˆ: æ–°é¢˜${info.selectedUnanswered}é¢˜, å¤ä¹ ${info.selectedAnswered}é¢˜`);
        }

        // ä¿å­˜åˆ†ç±»å’Œé¢˜ç›®åˆ° IndexedDB
        async function saveCategoryToDB(categoryName, questionsData) {
            const transaction = db.transaction(['categories'], 'readwrite');
            const store = transaction.objectStore('categories');

            const category = {
                name: categoryName,
                questions: questionsData,
                createdAt: new Date().toISOString(),
                count: questionsData.length
            };

            await store.add(category);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // è·å–æ‰€æœ‰åˆ†ç±»
        async function getAllCategories() {
            const transaction = db.transaction(['categories'], 'readonly');
            const store = transaction.objectStore('categories');
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // æ ¹æ®IDè·å–åˆ†ç±»
        async function getCategoryById(id) {
            const transaction = db.transaction(['categories'], 'readonly');
            const store = transaction.objectStore('categories');
            const request = store.get(id);

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(id) {
            const transaction = db.transaction(['categories'], 'readwrite');
            const store = transaction.objectStore('categories');
            await store.delete(id);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ä¿å­˜é”™é¢˜åˆ° IndexedDB
        async function saveWrongQuestionToDB(categoryId, categoryName, question, questionIndex) {
            try {
                // å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„é”™é¢˜ï¼ˆæ ¹æ®é¢˜ç›®å†…å®¹åˆ¤æ–­ï¼‰
                const allWrongQuestions = await getAllWrongQuestionsByCategory(categoryId);
                const exists = allWrongQuestions.some(wq => wq.question.question === question.question);

                if (exists) {
                    console.log('Wrong question already exists, skipping...');
                    return;
                }

                // åˆ›å»ºæ–°çš„transactionæ¥ä¿å­˜æ•°æ®
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['wrongQuestions'], 'readwrite');
                    const store = transaction.objectStore('wrongQuestions');

                    // æ¸…ç†ç»„åˆç­”é¢˜æ¨¡å¼æ·»åŠ çš„é¢å¤–å±æ€§
                    const cleanQuestion = { ...question };
                    delete cleanQuestion._categoryId;
                    delete cleanQuestion._categoryName;

                    const wrongQuestion = {
                        categoryId,
                        categoryName,
                        question: cleanQuestion,
                        questionIndex,
                        addedAt: new Date().toISOString()
                    };

                    const request = store.add(wrongQuestion);

                    request.onsuccess = () => {
                        console.log('Wrong question saved successfully');
                        resolve();
                    };

                    request.onerror = (event) => {
                        console.error('Error saving wrong question:', event.target.error);
                        reject(event.target.error);
                    };

                    transaction.oncomplete = () => {
                        console.log('Transaction completed');
                    };

                    transaction.onerror = (event) => {
                        console.error('Transaction error:', event.target.error);
                        reject(event.target.error);
                    };
                });
            } catch (error) {
                console.error('Error in saveWrongQuestionToDB:', error);
                throw error;
            }
        }

        // è·å–æ‰€æœ‰é”™é¢˜ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
        async function getAllWrongQuestionsGrouped() {
            const transaction = db.transaction(['wrongQuestions'], 'readonly');
            const store = transaction.objectStore('wrongQuestions');
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    const wrongQuestions = request.result;

                    // æŒ‰åˆ†ç±»åˆ†ç»„
                    const grouped = {};
                    wrongQuestions.forEach(wq => {
                        if (!grouped[wq.categoryId]) {
                            grouped[wq.categoryId] = {
                                categoryId: wq.categoryId,
                                categoryName: wq.categoryName,
                                questions: [],
                                count: 0
                            };
                        }
                        grouped[wq.categoryId].questions.push(wq);
                        grouped[wq.categoryId].count++;
                    });

                    resolve(Object.values(grouped));
                };
                request.onerror = () => reject(request.error);
            });
        }

        // æ ¹æ®åˆ†ç±»è·å–é”™é¢˜
        async function getAllWrongQuestionsByCategory(categoryId) {
            const transaction = db.transaction(['wrongQuestions'], 'readonly');
            const store = transaction.objectStore('wrongQuestions');
            const index = store.index('categoryId');
            const request = index.getAll(categoryId);

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // åˆ é™¤é”™é¢˜
        async function deleteWrongQuestion(id) {
            const transaction = db.transaction(['wrongQuestions'], 'readwrite');
            const store = transaction.objectStore('wrongQuestions');
            await store.delete(id);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // æ¸…ç©ºæŸä¸ªåˆ†ç±»çš„æ‰€æœ‰é”™é¢˜
        async function clearWrongQuestionsByCategory(categoryId) {
            const wrongQuestions = await getAllWrongQuestionsByCategory(categoryId);
            const transaction = db.transaction(['wrongQuestions'], 'readwrite');
            const store = transaction.objectStore('wrongQuestions');

            wrongQuestions.forEach(wq => {
                store.delete(wq.id);
            });

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ä¿å­˜ç­”é¢˜è®°å½•åˆ° IndexedDB
        async function saveQuizRecordToDB(categoryId, categoryName, totalQuestions, correctAnswers, score, timeSpent) {
            const transaction = db.transaction(['quizRecords'], 'readwrite');
            const store = transaction.objectStore('quizRecords');

            // æ„å»ºè¯¦ç»†ç­”é¢˜ä¿¡æ¯
            const userAnswersDetail = userAnswers.map((answer, index) => {
                const mapping = optionMappings[index];
                let shuffledAnswer = null;
                let originalAnswer = null;
                let shuffledOptions = questions[index]?.options || [];
                let originalOptions = questions[index]?.options || [];

                // å¦‚æœæœ‰æ˜ å°„ä¿¡æ¯ï¼Œè·å–æ‰“ä¹±åçš„é€‰é¡¹å’ŒåŸå§‹é€‰é¡¹
                if (mapping) {
                    // è·å–æ‰“ä¹±åçš„é€‰é¡¹
                    if (mapping.newOptions) {
                        shuffledOptions = mapping.newOptions;
                    }

                    // è·å–åŸå§‹é€‰é¡¹ï¼ˆé¢˜åº“ä¸­çš„å›ºå®šé€‰é¡¹ï¼‰
                    if (mapping.originalOptions) {
                        originalOptions = mapping.originalOptions;
                    }

                    // è·å–åŸå§‹ç­”æ¡ˆ
                    if (mapping.originalAnswer) {
                        originalAnswer = mapping.originalAnswer;
                    }
                }

                // è·å–æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                if (mapping && questions[index]?.answer) {
                    if (mapping.type === 'å•é€‰é¢˜' || mapping.type === 'å…¶ä»–é¢˜å‹') {
                        for (const [newKey, originalKey] of Object.entries(mapping.mapping || {})) {
                            if (originalKey === questions[index].answer) {
                                shuffledAnswer = newKey;
                                break;
                            }
                        }
                    } else if (mapping.type === 'é…ä¼é€‰æ‹©é¢˜' && questions[index]?.sub_questions) {
                        shuffledAnswer = questions[index].sub_questions.map((subQ, subIdx) => {
                            const originalAns = subQ.answer;
                            for (const [newKey, originalKey] of Object.entries(mapping.mapping || {})) {
                                if (originalKey === originalAns) {
                                    return newKey;
                                }
                            }
                            return originalAns;
                        });
                    }
                }

                return {
                    questionIndex: index,
                    userAnswer: answer,
                    // æ‰“ä¹±åçš„ç­”æ¡ˆï¼ˆç”¨äºæ¯”å¯¹ï¼Œå†³å®šå¯¹é”™ï¼‰
                    shuffledAnswer: shuffledAnswer || questions[index]?.answer,
                    // åŸå§‹ç­”æ¡ˆï¼ˆé¢˜åº“ä¸­çš„å›ºå®šç­”æ¡ˆï¼‰
                    originalAnswer: originalAnswer || questions[index]?.answer,
                    question: {
                        id: questions[index]?.id,
                        text: questions[index]?.question,
                        type: questions[index]?.type,
                        // ä¿å­˜æ‰“ä¹±åçš„é€‰é¡¹ï¼ˆç­”é¢˜æ—¶çš„é€‰é¡¹é¡ºåºï¼‰
                        shuffledOptions: typeof shuffledOptions === 'object' ? Object.values(shuffledOptions) : shuffledOptions,
                        // ä¿å­˜åŸå§‹é€‰é¡¹ï¼ˆé¢˜åº“ä¸­çš„æ ‡å‡†é€‰é¡¹é¡ºåºï¼‰
                        originalOptions: typeof originalOptions === 'object' ? Object.values(originalOptions) : originalOptions,
                        // ä¿å­˜ä¸¤ä¸ªç­”æ¡ˆç‰ˆæœ¬ï¼Œæ¸…æ¥šåœ°æ ‡è¯†å„è‡ªçš„å«ä¹‰
                        answer: shuffledAnswer || questions[index]?.answer,
                        sub_questions: questions[index]?.sub_questions,
                        categoryName: questions[index]?._categoryName || categoryName
                    }
                };
            });

            const quizRecord = {
                categoryId,
                categoryName,
                totalQuestions,
                correctAnswers,
                score,
                timeSpent,
                quizDate: new Date().toISOString(),
                // ä¿å­˜è¯¦ç»†ç­”é¢˜ä¿¡æ¯
                userAnswers: userAnswersDetail
            };

            await store.add(quizRecord);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // è·å–æ‰€æœ‰ç­”é¢˜è®°å½•
        async function getAllQuizRecords() {
            const transaction = db.transaction(['quizRecords'], 'readonly');
            const store = transaction.objectStore('quizRecords');
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // æ ¹æ®åˆ†ç±»è·å–ç­”é¢˜è®°å½•
        async function getQuizRecordsByCategory(categoryId) {
            const transaction = db.transaction(['quizRecords'], 'readonly');
            const store = transaction.objectStore('quizRecords');
            const index = store.index('categoryId');
            const request = index.getAll(categoryId);

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // åˆ†æåˆ†ç±»å¢é•¿ç‡
        async function analyzeCategoryProgress(categoryId) {
            try {
                const records = await getQuizRecordsByCategory(categoryId);

                if (records.length < 2) {
                    return {
                        trend: 'insufficient_data',
                        improvement: 0,
                        dataPoints: records.length,
                        recentScores: records.map(r => ({ score: r.score, date: r.quizDate }))
                    };
                }

                // æŒ‰æ—¶é—´æ’åº
                records.sort((a, b) => new Date(a.quizDate) - new Date(b.quizDate));

                // è®¡ç®—æœ€è¿‘3æ¬¡å’Œä¹‹å‰3æ¬¡çš„å¹³å‡åˆ†ï¼ˆç”¨äºè®¡ç®—è¿›åº¦ï¼‰
                const recentCount = Math.min(3, records.length);
                const previousCount = Math.min(3, records.length - recentCount);

                const recentScoresForProgress = records.slice(-recentCount);
                const previousScores = previousCount > 0 ? records.slice(-recentCount - previousCount, -recentCount) : [];

                const recentAvg = recentScoresForProgress.reduce((sum, r) => sum + r.score, 0) / recentScoresForProgress.length;
                const previousAvg = previousScores.length > 0 ?
                    previousScores.reduce((sum, r) => sum + r.score, 0) / previousScores.length : recentAvg;

                // è®¡ç®—å¢é•¿ç‡
                const improvement = recentAvg - previousAvg;
                const growthRate = previousAvg > 0 ? ((improvement / previousAvg) * 100) : 0;

                // è®¡ç®—è¶‹åŠ¿
                let trend = 'stable';
                if (growthRate > 10) trend = 'improving';
                else if (growthRate < -10) trend = 'declining';

                return {
                    trend,
                    improvement: Math.round(improvement * 10) / 10,
                    growthRate: Math.round(growthRate * 10) / 10,
                    dataPoints: records.length,
                    recentAvg: Math.round(recentAvg * 10) / 10,
                    previousAvg: Math.round(previousAvg * 10) / 10,
                    // è¿”å›æ‰€æœ‰ç­”é¢˜è®°å½•ç”¨äºæŠ˜çº¿å›¾æ˜¾ç¤º
                    recentScores: records.map(r => ({ score: r.score, date: r.quizDate })),
                    bestScore: Math.max(...records.map(r => r.score)),
                    worstScore: Math.min(...records.map(r => r.score))
                };
            } catch (error) {
                console.error('Error analyzing category progress:', error);
                return {
                    trend: 'error',
                    improvement: 0,
                    dataPoints: 0,
                    error: error.message
                };
            }
        }

        // æ˜¾ç¤ºåˆ†ç±»åˆ—è¡¨
        async function showCategoryList() {
            try {
                const categories = await getAllCategories();
                const selectElement = document.getElementById('category-select');

                if (!selectElement) {
                    console.error('category-select element not found');
                    return;
                }

                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹ï¼‰
                selectElement.innerHTML = '<option value="">-- è¯·é€‰æ‹©é¢˜åº“åˆ†ç±» --</option>';

                if (categories.length === 0) {
                    selectElement.innerHTML = '<option value="">æš‚æ— é¢˜åº“ï¼Œè¯·å…ˆå¯¼å…¥</option>';
                    selectElement.disabled = true;
                    console.log('No categories found');
                    return;
                }

                selectElement.disabled = false;

                // æ·»åŠ åˆ†ç±»é€‰é¡¹
                categories.forEach(category => {
                    const date = new Date(category.createdAt).toLocaleString('zh-CN');
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.name} (${category.count}é¢˜ | ${date})`;
                    selectElement.appendChild(option);
                });

                // éšè—æ“ä½œæŒ‰é’®
                const categoryActions = document.getElementById('category-actions');
                if (categoryActions) {
                    categoryActions.style.display = 'none';
                }

                console.log(`Loaded ${categories.length} categories`);
            } catch (error) {
                console.error('Error in showCategoryList:', error);
                const selectElement = document.getElementById('category-select');
                if (selectElement) {
                    selectElement.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</option>';
                    selectElement.disabled = true;
                }
            }
        }

        // å¤„ç†åˆ†ç±»é€‰æ‹©
        function handleCategorySelect() {
            const selectElement = document.getElementById('category-select');
            const selectedValue = selectElement.value;

            if (selectedValue) {
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                document.getElementById('category-actions').style.display = 'block';
            } else {
                // éšè—æ“ä½œæŒ‰é’®
                document.getElementById('category-actions').style.display = 'none';
            }
        }

        // å¼€å§‹é€‰ä¸­çš„åˆ†ç±»
        function startSelectedCategory() {
            const selectElement = document.getElementById('category-select');
            const categoryId = parseInt(selectElement.value);

            if (categoryId) {
                loadCategoryQuestions(categoryId);
            }
        }

        // ç¡®è®¤åˆ é™¤é€‰ä¸­çš„åˆ†ç±»
        async function confirmDeleteSelectedCategory() {
            const selectElement = document.getElementById('category-select');
            const categoryId = parseInt(selectElement.value);

            if (!categoryId) {
                return;
            }

            // è·å–åˆ†ç±»åç§°
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const categoryName = selectedOption.textContent;

            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢˜åº“ã€Œ${categoryName}ã€å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
                try {
                    await deleteCategory(categoryId);
                    await showCategoryList();
                    alert('åˆ é™¤æˆåŠŸï¼');
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ç¡®è®¤åˆ é™¤åˆ†ç±»ï¼ˆä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹ï¼‰
        async function confirmDeleteCategory(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜åº“å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                try {
                    await deleteCategory(id);
                    await showCategoryList();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ä¸ºé¢˜ç›®ç”Ÿæˆå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆåŸºäºé¢˜ç›®å†…å®¹ï¼‰
        function getQuestionKey(question, index) {
            // ä½¿ç”¨é¢˜ç›®å†…å®¹å’Œç±»å‹ç”Ÿæˆå”¯ä¸€é”®ï¼Œé˜²æ­¢é¢˜ç›®é‡æ–°æ’åºæ—¶å‡ºç°é—®é¢˜
            if (!question) {
                return `${index}_unknown_nodata`;
            }
            const questionText = question.question ? question.question.substring(0, 50) : 'notext';
            const questionType = question.type || 'unknown';
            return `${index}_${questionType}_${questionText}`;
        }

        // éšæœºæ‰“ä¹±é€‰é¡¹å¹¶åˆ›å»ºæ˜ å°„
        function shuffleOptions(originalOptions) {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿optionsä¸ä¸ºnullæˆ–undefined
            if (!originalOptions || typeof originalOptions !== 'object') {
                return { newOptions: {}, mapping: {} };
            }

            // è·å–æ‰€æœ‰é€‰é¡¹çš„é”®å€¼å¯¹
            const entries = Object.entries(originalOptions);

            // å¦‚æœæ²¡æœ‰é€‰é¡¹ï¼Œç›´æ¥è¿”å›ç©ºå¯¹è±¡
            if (entries.length === 0) {
                return { newOptions: {}, mapping: {} };
            }

            // Fisher-Yates æ´—ç‰Œç®—æ³•
            for (let i = entries.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [entries[i], entries[j]] = [entries[j], entries[i]];
            }

            // åˆ›å»ºæ–°çš„é€‰é¡¹å¯¹è±¡å’Œæ˜ å°„
            const newOptions = {};
            const mapping = {};
            const labels = ['A', 'B', 'C', 'D', 'E'];

            entries.forEach(([originalKey, value], index) => {
                const newKey = labels[index];
                newOptions[newKey] = value;
                mapping[newKey] = originalKey; // æ–°æ ‡ç­¾ -> åŸå§‹æ ‡ç­¾
            });

            return { newOptions, mapping };
        }

        // åˆå§‹åŒ–é¢˜ç›®çš„é€‰é¡¹æ˜ å°„ - åªä¸ºæ–°é¢˜ç›®åˆå§‹åŒ–ï¼Œå·²ç­”é¢˜ç›®ä¿ç•™åŸæ¥çš„æ˜ å°„
        function initializeQuestionMappings() {
            optionMappings = questions.map((question, index) => {
                // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœquestionä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›null
                if (!question) {
                    return null;
                }

                const questionKey = getQuestionKey(question, index);

                // å¦‚æœè¿™é“é¢˜å·²ç»æœ‰æ°¸ä¹…æ˜ å°„ï¼Œå°±ä½¿ç”¨å®ƒ
                if (permanentMappings[questionKey]) {
                    return permanentMappings[questionKey];
                }

                // å¦åˆ™ç”Ÿæˆæ–°çš„æ˜ å°„
                let result;
                if (question.type === 'å•é€‰é¢˜') {
                    const { newOptions, mapping } = shuffleOptions(question.options);
                    result = {
                        type: 'å•é€‰é¢˜',
                        newOptions,
                        mapping,
                        originalAnswer: question.answer,
                        // ä¿å­˜åŸå§‹é€‰é¡¹ï¼ˆé¢˜åº“ä¸­çš„å›ºå®šé€‰é¡¹ï¼‰
                        originalOptions: question.options
                    };
                } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜') {
                    // é…ä¼é€‰æ‹©é¢˜çš„é€‰é¡¹æ˜¯å…±äº«çš„ï¼Œåªæ‰“ä¹±ä¸€æ¬¡
                    const { newOptions, mapping } = shuffleOptions(question.options);
                    result = {
                        type: 'é…ä¼é€‰æ‹©é¢˜',
                        newOptions,
                        mapping,
                        originalAnswers: question.sub_questions ? question.sub_questions.map(sq => sq.answer) : [],
                        // ä¿å­˜åŸå§‹é€‰é¡¹
                        originalOptions: question.options
                    };
                } else {
                    result = null;
                }

                // ä¿å­˜åˆ°æ°¸ä¹…æ˜ å°„ï¼Œè¿™æ ·å³ä½¿é‡æ–°åˆå§‹åŒ–ä¹Ÿä¸ä¼šæ”¹å˜
                if (result) {
                    permanentMappings[questionKey] = result;
                }

                return result;
            });
        }

        // è·å–æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
        function getShuffledAnswer(questionIndex) {
            const mapping = optionMappings[questionIndex];
            if (!mapping) return null;

            if (mapping.type === 'å•é€‰é¢˜') {
                // æ‰¾åˆ°åŸå§‹ç­”æ¡ˆå¯¹åº”çš„æ–°æ ‡ç­¾
                for (const [newKey, originalKey] of Object.entries(mapping.mapping)) {
                    if (originalKey === mapping.originalAnswer) {
                        return newKey;
                    }
                }
            }
            return null;
        }

        // è·å–é…ä¼é¢˜æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
        function getShuffledSubAnswer(questionIndex, subIndex) {
            const mapping = optionMappings[questionIndex];
            if (!mapping || mapping.type !== 'é…ä¼é€‰æ‹©é¢˜') return null;

            const originalAnswer = mapping.originalAnswers[subIndex];
            for (const [newKey, originalKey] of Object.entries(mapping.mapping)) {
                if (originalKey === originalAnswer) {
                    return newKey;
                }
            }
            return null;
        }

        // åŠ è½½åˆ†ç±»é¢˜ç›®
        async function loadCategoryQuestions(categoryId) {
            try {
                // éšè—æ‰€æœ‰é¡µé¢
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                document.getElementById('loading').style.display = 'block';

                const category = await getCategoryById(categoryId);

                if (!category || !category.questions || category.questions.length === 0) {
                    throw new Error('No questions found in this category');
                }

                currentCategory = category;

                // ä½¿ç”¨æ™ºèƒ½é€‰é¢˜ï¼šä¼˜å…ˆé€‰æ‹©æœªç­”è¿‡çš„é¢˜ç›®
                const allQuestions = category.questions;
                const targetCount = allQuestions.length; // æ™®é€šæ¨¡å¼é€‰æ‹©å…¨éƒ¨é¢˜ç›®

                questions = await smartSelectQuestions(categoryId, allQuestions, targetCount);

                // æ˜¾ç¤ºé€‰é¢˜ç»Ÿè®¡ä¿¡æ¯
                if (questions._selectionInfo) {
                    showSelectionInfo(questions._selectionInfo, category.name);
                }

                userAnswers = new Array(questions.length).fill(null);
                wrongQuestionIds = []; // é‡ç½®é”™é¢˜IDåˆ—è¡¨
                permanentMappings = {}; // é‡ç½®æ°¸ä¹…æ˜ å°„ï¼Œå¼€å§‹æ–°çš„ç­”é¢˜ä¼šè¯

                // åˆå§‹åŒ–é€‰é¡¹æ˜ å°„ï¼ˆéšæœºæ‰“ä¹±é€‰é¡¹ï¼‰
                initializeQuestionMappings();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('question-container').style.display = 'block';
                document.getElementById('quiz-navigation').style.display = 'block';
                document.getElementById('total-questions').textContent = questions.length;
                document.getElementById('reimport-btn').style.display = 'block';

                // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºå½“å‰åˆ†ç±»
                document.querySelector('.header h1').textContent = `ä¸­è¯ç­”é¢˜ç³»ç»Ÿ - ${category.name}`;

                // è®°å½•å¼€å§‹æ—¶é—´
                quizStartTime = Date.now();
                console.log('ç­”é¢˜å¼€å§‹æ—¶é—´:', new Date(quizStartTime).toLocaleString('zh-CN'));

                displayQuestion(0);
            } catch (error) {
                console.error('Error loading category questions:', error);
                document.getElementById('loading').style.display = 'none';
                alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•');
                // è¿”å›åˆ°é¦–é¡µ
                navigateTo('home');
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const categoryName = document.getElementById('category-input').value.trim();
            if (!categoryName) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼');
                return;
            }

            const statusDiv = document.getElementById('upload-status');
            statusDiv.textContent = 'æ­£åœ¨å¯¼å…¥...';
            statusDiv.style.color = '#667eea';

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('JSON æ ¼å¼ä¸æ­£ç¡®');
                }

                // ä¿å­˜åˆ°æ•°æ®åº“
                await saveCategoryToDB(categoryName, data);

                statusDiv.textContent = `æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®åˆ°åˆ†ç±»ã€Œ${categoryName}ã€ï¼`;
                statusDiv.style.color = '#4caf50';

                // å»¶è¿Ÿåè¿”å›é¦–é¡µ
                setTimeout(() => {
                    document.getElementById('category-input').value = '';
                    document.getElementById('file-input').value = '';
                    navigateTo('home');
                }, 1500);

            } catch (error) {
                console.error('Error uploading file:', error);
                statusDiv.textContent = 'å¯¼å…¥å¤±è´¥ï¼š' + error.message;
                statusDiv.style.color = '#f44336';
            }
        }

        // æ˜¾ç¤ºé”™é¢˜åˆ†ç±»åˆ—è¡¨
        async function showWrongQuestionCategories() {
            const wrongQuestionsGrouped = await getAllWrongQuestionsGrouped();
            const listDiv = document.getElementById('wrong-question-list');

            if (wrongQuestionsGrouped.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— é”™é¢˜è®°å½•</p>';
                return;
            }

            let html = '';
            wrongQuestionsGrouped.forEach(group => {
                html += `
                    <div class="category-item">
                        <div class="category-info" onclick="loadWrongQuestions(${group.categoryId})">
                            <div class="category-name">${group.categoryName} - é”™é¢˜</div>
                            <div class="category-count">
                                ${group.count} é“é”™é¢˜
                            </div>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-small btn-delete" onclick="event.stopPropagation(); confirmClearWrongQuestions(${group.categoryId}, '${group.categoryName}')">
                                æ¸…ç©º
                            </button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // ç¡®è®¤æ¸…ç©ºé”™é¢˜
        async function confirmClearWrongQuestions(categoryId, categoryName) {
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºã€Œ${categoryName}ã€çš„æ‰€æœ‰é”™é¢˜å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
                try {
                    await clearWrongQuestionsByCategory(categoryId);
                    await showWrongQuestionCategories();
                } catch (error) {
                    console.error('Error clearing wrong questions:', error);
                    alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function confirmClearAllData() {
            const confirmationMessage = `âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ä»¥ä¸‹æ‰€æœ‰æ•°æ®ï¼š

ğŸ“š æ‰€æœ‰é¢˜åº“åˆ†ç±»å’Œé¢˜ç›®
ğŸ“ æ‰€æœ‰ç­”é¢˜è®°å½•å’Œç»Ÿè®¡æ•°æ®
âŒ æ‰€æœ‰é”™é¢˜è®°å½•

æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ

å¦‚æœæ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œè¯·è¾“å…¥"æ¸…é™¤æ‰€æœ‰æ•°æ®"è¿›è¡Œç¡®è®¤ï¼š`;

            const userInput = prompt(confirmationMessage);

            if (userInput === 'æ¸…é™¤æ‰€æœ‰æ•°æ®') {
                try {
                    await clearAllData();

                    // åˆ·æ–°ç»Ÿè®¡é¡µé¢æ˜¾ç¤º
                    await showStatisticsPage();

                    alert('âœ… æ‰€æœ‰æ•°æ®å·²æˆåŠŸæ¸…é™¤ï¼ç³»ç»Ÿå°†é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚');

                    // é‡ç½®åˆ°é¦–é¡µ
                    navigateTo('home');

                } catch (error) {
                    console.error('Error clearing all data:', error);
                    alert('âŒ æ¸…é™¤æ•°æ®å¤±è´¥ï¼š' + error.message + '\nè¯·é‡è¯•æˆ–åˆ·æ–°é¡µé¢ã€‚');
                }
            } else if (userInput !== null) {
                alert('âŒ ç¡®è®¤æ–‡å­—ä¸æ­£ç¡®ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            const transaction = db.transaction(['categories', 'quizRecords', 'wrongQuestions'], 'readwrite');

            const categoriesStore = transaction.objectStore('categories');
            const quizRecordsStore = transaction.objectStore('quizRecords');
            const wrongQuestionsStore = transaction.objectStore('wrongQuestions');

            categoriesStore.clear();
            quizRecordsStore.clear();
            wrongQuestionsStore.clear();

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log('All data cleared successfully');

                    // é‡ç½®å†…å­˜ä¸­çš„æ•°æ®
                    questions = [];
                    currentQuestionIndex = 0;
                    userAnswers = [];
                    showingResults = false;
                    currentCategory = null;
                    optionMappings = [];
                    permanentMappings = {}; // æ¸…ç©ºæ°¸ä¹…æ˜ å°„
                    wrongQuestionIds = [];
                    isRestoringAnswer = false;

                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // æ˜¾ç¤ºç»Ÿè®¡é¡µé¢
        async function showStatisticsPage() {
            try {
                const categories = await getAllCategories();
                const categorySelect = document.getElementById('progress-category-select');

                // æ¸…ç©ºä¸‹æ‹‰æ¡†
                categorySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©åˆ†ç±» --</option>';

                if (categories.length === 0) {
                    categorySelect.innerHTML = '<option value="">æš‚æ— é¢˜åº“åˆ†ç±»</option>';
                    document.getElementById('progress-data-display').innerHTML =
                        '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥é¢˜åº“å¹¶å¼€å§‹ç­”é¢˜</p>';
                    document.getElementById('overall-stats').innerHTML = '';
                    return;
                }

                // æ·»åŠ åˆ†ç±»é€‰é¡¹
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `${category.name} (${category.count || 0}é¢˜)`;
                    categorySelect.appendChild(option);
                });

                // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
                await showOverallStats();

                // åˆå§‹åŒ–è¿›åº¦æ•°æ®æ˜¾ç¤º
                document.getElementById('progress-data-display').innerHTML =
                    '<p style="text-align: center; color: #999; padding: 40px;">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æŸ¥çœ‹è¯¦ç»†çš„è¿›æ­¥æ•°æ®</p>';

            } catch (error) {
                console.error('Error showing statistics page:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById('progress-data-display').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #f44336; font-weight: bold; margin-bottom: 10px;">âŒ ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥</p>
                        <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        <button onclick="showStatisticsPage()" style="margin-top: 15px; background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
        async function showOverallStats() {
            try {
                const allRecords = await getAllQuizRecords();
                const categories = await getAllCategories();

                let totalQuizzes = allRecords.length;
                let avgScore = 0;
                let bestScore = 0;
                let worstScore = 100;
                let recentActivity = 0;

                if (totalQuizzes > 0) {
                    const scores = allRecords.map(r => r.score);
                    avgScore = Math.round((scores.reduce((a, b) => a + b, 0) / totalQuizzes) * 10) / 10;
                    bestScore = Math.max(...scores);
                    worstScore = Math.min(...scores);

                    // æœ€è¿‘7å¤©çš„æ´»åŠ¨æ¬¡æ•°
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    recentActivity = allRecords.filter(r => new Date(r.quizDate) >= sevenDaysAgo).length;
                }

                let html = `
                    <h3 style="color: #333; margin-bottom: 20px; text-align: center;">ğŸ“ˆ æ€»ä½“å­¦ä¹ ç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalQuizzes}</div>
                            <div style="color: #666; font-size: 14px;">æ€»ç­”é¢˜æ¬¡æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${avgScore}%</div>
                            <div style="color: #666; font-size: 14px;">å¹³å‡å¾—åˆ†</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${bestScore}%</div>
                            <div style="color: #666; font-size: 14px;">æœ€é«˜åˆ†</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #2196f3;">${recentActivity}</div>
                            <div style="color: #666; font-size: 14px;">è¿‘7å¤©æ´»è·ƒ</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-delete" onclick="confirmClearAllData()" style="padding: 12px 30px; font-size: 16px; background: #f44336; color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);"
                                onmouseover="this.style.background='#d32f2f'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(244, 67, 54, 0.4)';"
                                onmouseout="this.style.background='#f44336'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(244, 67, 54, 0.3)';">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                        </button>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">å°†åˆ é™¤æ‰€æœ‰é¢˜åº“ã€ç­”é¢˜è®°å½•å’Œé”™é¢˜ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€</p>
                    </div>
                `;

                document.getElementById('overall-stats').innerHTML = html;

            } catch (error) {
                console.error('Error showing overall stats:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById('overall-stats').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <p style="color: #f44336; font-weight: bold; margin-bottom: 10px;">âŒ æ€»ä½“ç»Ÿè®¡åŠ è½½å¤±è´¥</p>
                        <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
            }
        }

        // æ¯”è¾ƒç­”æ¡ˆæ˜¯å¦æ­£ç¡®
        function compareAnswers(userAnswer, correctAnswers) {
            if (!userAnswer || !correctAnswers) return false;

            // å¤„ç†å­—ç¬¦ä¸²æ¯”è¾ƒ
            if (typeof userAnswer === 'string' && typeof correctAnswers === 'string') {
                // å»é™¤ç©ºæ ¼åæ¯”è¾ƒ
                return userAnswer.trim() === correctAnswers.trim();
            }

            // å¤„ç†æ•°ç»„æ¯”è¾ƒï¼ˆå¤šé€‰é¢˜ï¼‰
            const userAnswerArray = Array.isArray(userAnswer) ? userAnswer : [userAnswer];
            const correctAnswerArray = Array.isArray(correctAnswers) ? correctAnswers : [correctAnswers];

            // æ£€æŸ¥é•¿åº¦æ˜¯å¦ç›¸åŒ
            if (userAnswerArray.length !== correctAnswerArray.length) return false;

            // æ£€æŸ¥æ‰€æœ‰ç­”æ¡ˆæ˜¯å¦éƒ½åŒ¹é…
            return userAnswerArray.every(ans => correctAnswerArray.includes(ans));
        }

        // æ˜¾ç¤ºç­”é¢˜è®°å½•çš„è¯¦ç»†ä¿¡æ¯
        async function showQuizRecordDetailsByCategory(categoryId, recordIndex) {
            try {
                // è·å–è¯¥åˆ†ç±»çš„æ‰€æœ‰ç­”é¢˜è®°å½•
                const records = await getQuizRecordsByCategory(categoryId);

                if (!records || records.length === 0) {
                    alert('æœªæ‰¾åˆ°ç­”é¢˜è®°å½•');
                    return;
                }

                // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
                records.sort((a, b) => new Date(b.quizDate) - new Date(a.quizDate));
                const record = records[recordIndex];

                if (!record) {
                    alert('æœªæ‰¾åˆ°æŒ‡å®šçš„ç­”é¢˜è®°å½•');
                    return;
                }

                // åˆ›å»ºè¯¦æƒ…å¼¹çª—
                const detailsModal = document.createElement('div');
                detailsModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease-out;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    max-width: 90%;
                    max-height: 90%;
                    overflow-y: auto;
                    padding: 30px;
                    box-shadow: 0 5px 30px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                `;

                const date = new Date(record.quizDate).toLocaleString('zh-CN');
                let htmlContent = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                        <div>
                            <h2 style="margin: 0 0 10px 0; color: #333;">ğŸ“Š ç­”é¢˜è¯¦æƒ…</h2>
                            <p style="margin: 0; color: #666; font-size: 14px;">ç­”é¢˜æ—¶é—´ï¼š${date}</p>
                        </div>
                        <button onclick="document.body.removeChild(document.body.lastChild)" style="background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">å…³é—­</button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold;">${record.totalQuestions}</div>
                            <div style="font-size: 14px; margin-top: 5px;">æ€»é¢˜æ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50, #45a049); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold;">${record.correctAnswers}</div>
                            <div style="font-size: 14px; margin-top: 5px;">ç­”å¯¹é¢˜æ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f44336, #da190b); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold;">${record.totalQuestions - record.correctAnswers}</div>
                            <div style="font-size: 14px; margin-top: 5px;">ç­”é”™é¢˜æ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ff9800, #e68900); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: bold;">${record.score}%</div>
                            <div style="font-size: 14px; margin-top: 5px;">å¾—åˆ†</div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 30px; font-size: 14px; color: #666;">
                        <strong>â±ï¸ ç­”é¢˜ç”¨æ—¶ï¼š</strong> ${Math.floor(record.timeSpent / 60)}åˆ†${record.timeSpent % 60}ç§’
                    </div>
                `;

                // å¦‚æœæœ‰è¯¦ç»†ç­”é¢˜ä¿¡æ¯
                if (record.userAnswers && record.userAnswers.length > 0) {
                    // ç»Ÿè®¡ç­”å¯¹å’Œç­”é”™çš„é¢˜
                    const correctQuestions = [];
                    const wrongQuestions = [];

                    record.userAnswers.forEach((item, idx) => {
                        const question = item.question;
                        const userAnswer = item.userAnswer;
                        const isCorrect = compareAnswers(userAnswer, question.answer);

                        if (isCorrect) {
                            correctQuestions.push({ ...item, index: idx + 1 });
                        } else {
                            wrongQuestions.push({ ...item, index: idx + 1 });
                        }
                    });

                    // æ˜¾ç¤ºç­”å¯¹çš„é¢˜
                    if (correctQuestions.length > 0) {
                        htmlContent += `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #4caf50; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #4caf50;">
                                    âœ… ç­”å¯¹çš„é¢˜ (${correctQuestions.length}é¢˜)
                                </h3>
                                <div>
                        `;

                        correctQuestions.forEach(item => {
                            const question = item.question;
                            const userAnswer = item.userAnswer;
                            const correctAnswer = question.answer; // æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                            const originalAnswer = item.originalAnswer; // åŸå§‹ç­”æ¡ˆ

                            // è·å–é€‰é¡¹æ–‡æœ¬
                            let userAnswerText = '';
                            let correctAnswerText = '';
                            let originalAnswerText = '';

                            // ä½¿ç”¨æ‰“ä¹±åçš„é€‰é¡¹è·å–ç”¨æˆ·ç­”æ¡ˆå’Œæ‰“ä¹±åæ­£ç¡®ç­”æ¡ˆçš„æ–‡æœ¬
                            const shuffledOpts = question.shuffledOptions || [];
                            if (shuffledOpts.length > 0 || (question.options && typeof question.options === 'object')) {
                                const options = shuffledOpts.length > 0 ? shuffledOpts : Object.values(question.options || {});

                                // å¤„ç†ç”¨æˆ·ç­”æ¡ˆ
                                if (userAnswer && typeof userAnswer === 'string') {
                                    const answerChar = userAnswer.trim().charAt(0).toUpperCase();
                                    const userOptIdx = answerChar.charCodeAt(0) - 65;
                                    if (userOptIdx >= 0 && userOptIdx < options.length) {
                                        userAnswerText = options[userOptIdx] || '';
                                    }
                                }

                                // å¤„ç†æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                                if (correctAnswer) {
                                    let answerChar = '';
                                    if (Array.isArray(correctAnswer)) {
                                        answerChar = String(correctAnswer[0]).trim().charAt(0).toUpperCase();
                                    } else if (typeof correctAnswer === 'string') {
                                        answerChar = correctAnswer.trim().charAt(0).toUpperCase();
                                    }

                                    const correctOptIdx = answerChar.charCodeAt(0) - 65;
                                    if (correctOptIdx >= 0 && correctOptIdx < options.length) {
                                        correctAnswerText = options[correctOptIdx] || '';
                                    }
                                }
                            }

                            // ä½¿ç”¨åŸå§‹é€‰é¡¹è·å–é¢˜åº“çš„æ ‡å‡†ç­”æ¡ˆæ–‡æœ¬
                            const originalOpts = question.originalOptions || [];
                            if ((originalOpts.length > 0 || (question.options && typeof question.options === 'object')) && originalAnswer) {
                                const options = originalOpts.length > 0 ? originalOpts : Object.values(question.options || {});

                                let answerChar = '';
                                if (Array.isArray(originalAnswer)) {
                                    answerChar = String(originalAnswer[0]).trim().charAt(0).toUpperCase();
                                } else if (typeof originalAnswer === 'string') {
                                    answerChar = originalAnswer.trim().charAt(0).toUpperCase();
                                }

                                const originalOptIdx = answerChar.charCodeAt(0) - 65;
                                if (originalOptIdx >= 0 && originalOptIdx < options.length) {
                                    originalAnswerText = options[originalOptIdx] || '';
                                }
                            }

                            htmlContent += `
                                <div style="background: #e8f5e9; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <div style="font-weight: bold; margin-bottom: 8px; color: #333;">ç¬¬ ${item.index} é¢˜</div>
                                    <div style="color: #666; margin-bottom: 8px; line-height: 1.6;">${question.text}</div>
                                    <div style="background: white; padding: 10px; border-radius: 5px;">
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;"><strong>ç±»å‹ï¼š</strong> ${question.type || 'å•é€‰é¢˜'}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                            <strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong> <span style="color: #4caf50; font-weight: bold;">${userAnswer || 'æœªä½œç­”'}</span>
                                            ${userAnswerText ? ` (${userAnswerText})` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                            <strong>æ ‡å‡†ç­”æ¡ˆï¼ˆç­”é¢˜æ—¶ï¼‰ï¼š</strong> <span style="color: #2196F3; font-weight: bold;">${correctAnswer || 'æœªçŸ¥'}</span>
                                            ${correctAnswerText ? ` (${correctAnswerText})` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #666;">
                                            <strong>æ ‡å‡†ç­”æ¡ˆï¼ˆé¢˜åº“ï¼‰ï¼š</strong> <span style="color: #2196F3; font-weight: bold;">${originalAnswer || 'æœªçŸ¥'}</span>
                                            ${originalAnswerText ? ` (${originalAnswerText})` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        htmlContent += `
                                </div>
                            </div>
                        `;
                    }

                    // æ˜¾ç¤ºç­”é”™çš„é¢˜
                    if (wrongQuestions.length > 0) {
                        htmlContent += `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #f44336; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #f44336;">
                                    âŒ ç­”é”™çš„é¢˜ (${wrongQuestions.length}é¢˜)
                                </h3>
                                <div>
                        `;

                        wrongQuestions.forEach(item => {
                            const question = item.question;
                            const userAnswer = item.userAnswer;
                            const correctAnswer = question.answer; // æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                            const originalAnswer = item.originalAnswer; // åŸå§‹ç­”æ¡ˆ

                            // è·å–é€‰é¡¹æ–‡æœ¬
                            let userAnswerText = '';
                            let correctAnswerText = '';
                            let originalAnswerText = '';

                            // ä½¿ç”¨æ‰“ä¹±åçš„é€‰é¡¹è·å–ç”¨æˆ·ç­”æ¡ˆå’Œæ‰“ä¹±åæ­£ç¡®ç­”æ¡ˆçš„æ–‡æœ¬
                            const shuffledOpts = question.shuffledOptions || [];
                            if (shuffledOpts.length > 0 || (question.options && typeof question.options === 'object')) {
                                const options = shuffledOpts.length > 0 ? shuffledOpts : Object.values(question.options || {});

                                // å¤„ç†ç”¨æˆ·ç­”æ¡ˆ
                                if (userAnswer && typeof userAnswer === 'string') {
                                    const answerChar = userAnswer.trim().charAt(0).toUpperCase();
                                    const userOptIdx = answerChar.charCodeAt(0) - 65;
                                    if (userOptIdx >= 0 && userOptIdx < options.length) {
                                        userAnswerText = options[userOptIdx] || '';
                                    }
                                }

                                // å¤„ç†æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                                if (correctAnswer) {
                                    let answerChar = '';
                                    if (Array.isArray(correctAnswer)) {
                                        answerChar = String(correctAnswer[0]).trim().charAt(0).toUpperCase();
                                    } else if (typeof correctAnswer === 'string') {
                                        answerChar = correctAnswer.trim().charAt(0).toUpperCase();
                                    }

                                    const correctOptIdx = answerChar.charCodeAt(0) - 65;
                                    if (correctOptIdx >= 0 && correctOptIdx < options.length) {
                                        correctAnswerText = options[correctOptIdx] || '';
                                    }
                                }
                            }

                            // ä½¿ç”¨åŸå§‹é€‰é¡¹è·å–é¢˜åº“çš„æ ‡å‡†ç­”æ¡ˆæ–‡æœ¬
                            const originalOpts = question.originalOptions || [];
                            if ((originalOpts.length > 0 || (question.options && typeof question.options === 'object')) && originalAnswer) {
                                const options = originalOpts.length > 0 ? originalOpts : Object.values(question.options || {});

                                let answerChar = '';
                                if (Array.isArray(originalAnswer)) {
                                    answerChar = String(originalAnswer[0]).trim().charAt(0).toUpperCase();
                                } else if (typeof originalAnswer === 'string') {
                                    answerChar = originalAnswer.trim().charAt(0).toUpperCase();
                                }

                                const originalOptIdx = answerChar.charCodeAt(0) - 65;
                                if (originalOptIdx >= 0 && originalOptIdx < options.length) {
                                    originalAnswerText = options[originalOptIdx] || '';
                                }
                            }

                            htmlContent += `
                                <div style="background: #ffebee; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #f44336;">
                                    <div style="font-weight: bold; margin-bottom: 8px; color: #333;">ç¬¬ ${item.index} é¢˜</div>
                                    <div style="color: #666; margin-bottom: 8px; line-height: 1.6;">${question.text}</div>
                                    <div style="background: white; padding: 10px; border-radius: 5px;">
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;"><strong>ç±»å‹ï¼š</strong> ${question.type || 'å•é€‰é¢˜'}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                            <strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong> <span style="color: #f44336; font-weight: bold;">${userAnswer || 'æœªä½œç­”'}</span>
                                            ${userAnswerText ? ` (${userAnswerText})` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                            <strong>æ ‡å‡†ç­”æ¡ˆï¼ˆç­”é¢˜æ—¶ï¼‰ï¼š</strong> <span style="color: #4caf50; font-weight: bold;">${correctAnswer || 'æœªçŸ¥'}</span>
                                            ${correctAnswerText ? ` (${correctAnswerText})` : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #666;">
                                            <strong>æ ‡å‡†ç­”æ¡ˆï¼ˆé¢˜åº“ï¼‰ï¼š</strong> <span style="color: #4caf50; font-weight: bold;">${originalAnswer || 'æœªçŸ¥'}</span>
                                            ${originalAnswerText ? ` (${originalAnswerText})` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        htmlContent += `
                                </div>
                            </div>
                        `;
                    }
                } else {
                    htmlContent += `
                        <div style="text-align: center; color: #999; padding: 40px;">
                            æš‚æ— è¯¦ç»†ç­”é¢˜ä¿¡æ¯
                        </div>
                    `;
                }

                // æ·»åŠ åŠ¨ç”»æ ·å¼
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from {
                            transform: translateY(-50px);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);

                modalContent.innerHTML = htmlContent;
                detailsModal.appendChild(modalContent);
                document.body.appendChild(detailsModal);

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                detailsModal.onclick = (e) => {
                    if (e.target === detailsModal) {
                        document.body.removeChild(detailsModal);
                    }
                };

            } catch (error) {
                console.error('Error loading quiz record details:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    categoryId: categoryId,
                    recordIndex: recordIndex
                });

                // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                const errorModal = document.createElement('div');
                errorModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                const errorContent = document.createElement('div');
                errorContent.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 500px;
                    box-shadow: 0 5px 30px rgba(0,0,0,0.3);
                    text-align: center;
                `;

                errorContent.innerHTML = `
                    <h2 style="color: #f44336; margin: 0 0 15px 0;">âŒ åŠ è½½å¤±è´¥</h2>
                    <p style="color: #666; margin: 0 0 10px 0;">é”™è¯¯ä¿¡æ¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    <p style="color: #999; font-size: 12px; margin: 0 0 20px 0;">å‚æ•°: categoryId=${categoryId}, recordIndex=${recordIndex}</p>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">å…³é—­</button>
                `;

                errorModal.appendChild(errorContent);
                document.body.appendChild(errorModal);

                errorModal.onclick = (e) => {
                    if (e.target === errorModal) {
                        document.body.removeChild(errorModal);
                    }
                };
            }
        }

        // æ˜¾ç¤ºé€‰ä¸­åˆ†ç±»çš„è¿›æ­¥æ•°æ®

        async function showProgressData() {
            const categorySelect = document.getElementById('progress-category-select');
            const selectedCategoryId = parseInt(categorySelect.value);
            const progressDisplay = document.getElementById('progress-data-display');

            if (!selectedCategoryId) {
                progressDisplay.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æŸ¥çœ‹è¯¦ç»†çš„è¿›æ­¥æ•°æ®</p>';
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                progressDisplay.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;">ğŸ”„ æ­£åœ¨åˆ†æè¿›æ­¥æ•°æ®...</div>';

                // è·å–åˆ†ç±»ä¿¡æ¯å’Œè¿›åº¦åˆ†æ
                const categories = await getAllCategories();
                const category = categories.find(c => c.id === selectedCategoryId);

                if (!category) {
                    progressDisplay.innerHTML = '<p style="text-align: center; color: #f44336; padding: 40px;">æœªæ‰¾åˆ°é€‰ä¸­çš„åˆ†ç±»</p>';
                    return;
                }

                const progressData = await analyzeCategoryProgress(selectedCategoryId);

                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (progressData.error) {
                    console.error('Progress data error:', progressData.error);
                    progressDisplay.innerHTML = `<p style="text-align: center; color: #f44336; padding: 40px;">åŠ è½½å¤±è´¥: ${progressData.error}</p>`;
                    return;
                }

                const records = await getQuizRecordsByCategory(selectedCategoryId);

                // è¶‹åŠ¿å›¾æ ‡å’Œé¢œè‰²
                let trendIcon = 'ğŸ“Š';
                let trendColor = '#666';
                let trendText = 'æ•°æ®ä¸è¶³';

                if (progressData.trend === 'improving') {
                    trendIcon = 'ğŸ“ˆ';
                    trendColor = '#4caf50';
                    trendText = `è¿›æ­¥ +${progressData.growthRate}%`;
                } else if (progressData.trend === 'declining') {
                    trendIcon = 'ğŸ“‰';
                    trendColor = '#f44336';
                    trendText = `ä¸‹é™ ${progressData.growthRate}%`;
                } else if (progressData.trend === 'stable') {
                    trendIcon = 'â¡ï¸';
                    trendColor = '#ff9800';
                    trendText = 'ç¨³å®š';
                }

                let html = `
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3 style="color: #333; margin: 0;">${category.name}</h3>
                                <p style="color: #666; margin: 5px 0;">å…± ${records.length} æ¬¡ç­”é¢˜è®°å½•</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 32px; color: ${trendColor};">${trendIcon}</div>
                                <div style="color: ${trendColor}; font-weight: bold; font-size: 16px;">${trendText}</div>
                            </div>
                        </div>
                `;

                if (progressData.dataPoints >= 2) {
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;">${progressData.recentAvg}%</div>
                                <div style="color: #666; font-size: 12px;">æœ€è¿‘å¹³å‡</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #999;">${progressData.previousAvg}%</div>
                                <div style="color: #666; font-size: 12px;">ä¹‹å‰å¹³å‡</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #4caf50;">${progressData.bestScore}%</div>
                                <div style="color: #666; font-size: 12px;">æœ€é«˜åˆ†</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: bold; color: #f44336;">${progressData.worstScore}%</div>
                                <div style="color: #666; font-size: 12px;">æœ€ä½åˆ†</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <p style="color: #856404; margin: 0;">
                                ğŸ’¡ éœ€è¦è‡³å°‘${2 - progressData.dataPoints}æ¬¡ç­”é¢˜è®°å½•æ¥åˆ†æå­¦ä¹ è¿›æ­¥è¶‹åŠ¿
                            </p>
                        </div>
                    `;
                }

                // æœ€è¿‘æˆç»©è¶‹åŠ¿å›¾ - æŸ±å½¢å›¾æ˜¾ç¤ºæ‰€æœ‰ç­”é¢˜ç»“æœ
                if (progressData.recentScores.length > 0) {
                    // å‡†å¤‡æ•°æ®
                    const scores = progressData.recentScores;
                    const maxScore = Math.max(...scores.map(s => s.score), 100);
                    const minScore = 0;

                    // SVG å°ºå¯¸é…ç½®
                    const svgWidth = Math.max(800, scores.length * 50 + 100);
                    const svgHeight = 350;
                    const padding = { top: 20, right: 30, bottom: 70, left: 50 };
                    const chartWidth = svgWidth - padding.left - padding.right;
                    const chartHeight = svgHeight - padding.top - padding.bottom;

                    // è®¡ç®—æŸ±å­ç›¸å…³å‚æ•°
                    const barWidth = Math.max(20, (chartWidth / scores.length) * 0.7);
                    const barSpacing = chartWidth / scores.length;
                    const yScale = chartHeight / (maxScore - minScore || 100);

                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #333; margin-bottom: 15px;">ğŸ“Š æˆç»©è¶‹åŠ¿ï¼ˆæ‰€æœ‰ç­”é¢˜è®°å½•ï¼‰</h4>
                            <div style="overflow-x: auto;">
                                <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px;">
                                    <!-- Y è½´ -->
                                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${svgHeight - padding.bottom}" stroke="#ddd" stroke-width="2"/>
                                    <!-- X è½´ -->
                                    <line x1="${padding.left}" y1="${svgHeight - padding.bottom}" x2="${svgWidth - padding.right}" y2="${svgHeight - padding.bottom}" stroke="#ddd" stroke-width="2"/>

                                    <!-- Y è½´åˆ»åº¦å’Œæ ‡ç­¾ -->
                                    <text x="${padding.left - 10}" y="${padding.top + 5}" text-anchor="end" font-size="12" fill="#666">${maxScore}%</text>
                                    <text x="${padding.left - 10}" y="${svgHeight - padding.bottom + 5}" text-anchor="end" font-size="12" fill="#666">0%</text>
                                    <line x1="${padding.left - 5}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top}" stroke="#ddd" stroke-width="1"/>
                                    <line x1="${padding.left - 5}" y1="${svgHeight - padding.bottom}" x2="${padding.left}" y2="${svgHeight - padding.bottom}" stroke="#ddd" stroke-width="1"/>

                                    <!-- ç½‘æ ¼çº¿å’Œä¸­é—´åˆ»åº¦ -->
                                    <line x1="${padding.left - 5}" y1="${padding.top + chartHeight / 2}" x2="${padding.left}" y2="${padding.top + chartHeight / 2}" stroke="#ddd" stroke-width="1"/>
                                    <text x="${padding.left - 10}" y="${padding.top + chartHeight / 2 + 5}" text-anchor="end" font-size="11" fill="#999">${Math.round(maxScore / 2)}%</text>

                                    <!-- æŸ±å­å’Œæ ‡ç­¾ -->
                                    ${scores.map((scoreData, index) => {
                                        const barHeight = (scoreData.score / maxScore) * chartHeight;
                                        const x = padding.left + index * barSpacing + (barSpacing - barWidth) / 2;
                                        const y = svgHeight - padding.bottom - barHeight;
                                        const date = new Date(scoreData.date).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                                        const scoreColor = scoreData.score >= 80 ? '#4caf50' : scoreData.score >= 60 ? '#ff9800' : '#f44336';

                                        return `
                                            <!-- æŸ±å­ -->
                                            <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${scoreColor}" rx="3" opacity="0.8"/>
                                            <!-- æŸ±å­è¾¹æ¡† -->
                                            <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="none" stroke="${scoreColor}" stroke-width="1" rx="3"/>
                                            <!-- åˆ†æ•°æ ‡ç­¾ -->
                                            <text x="${x + barWidth / 2}" y="${y - 5}" text-anchor="middle" font-size="12" fill="${scoreColor}" font-weight="bold">
                                                ${scoreData.score}%
                                            </text>
                                            <!-- æ—¥æœŸæ ‡ç­¾ -->
                                            <text x="${x + barWidth / 2}" y="${svgHeight - padding.bottom + 20}" text-anchor="middle" font-size="10" fill="#666">
                                                ${date}
                                            </text>
                                        `;
                                    }).join('')}
                                </svg>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 12px; color: #666;">
                                ğŸ“Š å…± ${scores.length} æ¬¡ç­”é¢˜ï¼Œæœ€é«˜åˆ† ${Math.max(...scores.map(s => s.score))}%ï¼Œæœ€ä½åˆ† ${Math.min(...scores.map(s => s.score))}%ï¼Œå¹³å‡åˆ† ${Math.round(scores.reduce((a, b) => a + b.score, 0) / scores.length)}%
                            </div>
                        </div>
                    `;
                }

                // è¯¦ç»†ç­”é¢˜è®°å½•
                if (records.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #333; margin-bottom: 15px;">ğŸ“ ç­”é¢˜è®°å½•è¯¦æƒ…</h4>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                    `;

                    records.sort((a, b) => new Date(b.quizDate) - new Date(a.quizDate)).forEach((record, index) => {
                        const date = new Date(record.quizDate).toLocaleString('zh-CN');
                        const scoreColor = record.score >= 80 ? '#4caf50' : record.score >= 60 ? '#ff9800' : '#f44336';
                        const recordId = `quiz-record-${selectedCategoryId}-${index}`;

                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #333;">${date}</div>
                                    <div style="font-size: 12px; color: #666;">ç­”å¯¹ ${record.correctAnswers}/${record.totalQuestions} é¢˜</div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div style="color: ${scoreColor}; font-weight: bold; font-size: 16px;">${record.score}%</div>
                                    <button class="btn btn-primary btn-small"
                                            onclick="showQuizRecordDetailsByCategory(${selectedCategoryId}, ${index})"
                                            style="padding: 6px 12px; font-size: 12px;">
                                        æŸ¥è¯¢
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                progressDisplay.innerHTML = html;

            } catch (error) {
                console.error('Error showing progress data:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                progressDisplay.innerHTML = `<div style="text-align: center; padding: 40px;">
                    <p style="color: #f44336; font-weight: bold; margin-bottom: 10px;">âŒ è¿›æ­¥æ•°æ®åŠ è½½å¤±è´¥</p>
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">é”™è¯¯è¯¦æƒ…: ${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    <button onclick="showProgressData()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">é‡è¯•</button>
                </div>`;
            }
        }

        // åŠ è½½é”™é¢˜
        async function loadWrongQuestions(categoryId) {
            try {
                // éšè—æ‰€æœ‰é¡µé¢
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                document.getElementById('loading').style.display = 'block';

                const wrongQuestions = await getAllWrongQuestionsByCategory(categoryId);

                if (!wrongQuestions || wrongQuestions.length === 0) {
                    throw new Error('No wrong questions found in this category');
                }

                // æå–é¢˜ç›®æ•°æ®å’Œé”™é¢˜ID
                questions = wrongQuestions.map(wq => wq.question);
                wrongQuestionIds = wrongQuestions.map(wq => wq.id); // ä¿å­˜é”™é¢˜ID

                currentCategory = {
                    id: categoryId,
                    name: wrongQuestions[0].categoryName,
                    isWrongQuestionMode: true // æ ‡è®°ä¸ºé”™é¢˜æ¨¡å¼
                };

                userAnswers = new Array(questions.length).fill(null);
                permanentMappings = {}; // é‡ç½®æ°¸ä¹…æ˜ å°„ï¼Œå¼€å§‹æ–°çš„ç­”é¢˜ä¼šè¯

                // åˆå§‹åŒ–é€‰é¡¹æ˜ å°„ï¼ˆéšæœºæ‰“ä¹±é€‰é¡¹ï¼‰
                initializeQuestionMappings();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('question-container').style.display = 'block';
                document.getElementById('quiz-navigation').style.display = 'block';
                document.getElementById('total-questions').textContent = questions.length;
                document.getElementById('reimport-btn').style.display = 'block';

                // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºå½“å‰åˆ†ç±»
                document.querySelector('.header h1').textContent = `é”™é¢˜ç»ƒä¹  - ${currentCategory.name}`;

                // è®°å½•å¼€å§‹æ—¶é—´
                quizStartTime = Date.now();
                console.log('é”™é¢˜ç»ƒä¹ å¼€å§‹æ—¶é—´:', new Date(quizStartTime).toLocaleString('zh-CN'));

                displayQuestion(0);
            } catch (error) {
                console.error('Error loading wrong questions:', error);
                document.getElementById('loading').style.display = 'none';
                alert('åŠ è½½é”™é¢˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                // è¿”å›åˆ°é”™é¢˜åˆ—è¡¨
                navigateTo('wrong-questions');
            }
        }

        // ä¿®æ”¹è¿”å›æŒ‰é’®è¡Œä¸ºï¼ˆåœ¨é”™é¢˜æ¨¡å¼ä¸‹è¿”å›é”™é¢˜åˆ—è¡¨ï¼‰
        function backToCategoryList() {
            // éšè—ç­”é¢˜ç•Œé¢å’Œå¯¼èˆªæŒ‰é’®
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('quiz-navigation').style.display = 'none';
            document.getElementById('result-summary').classList.remove('show');
            document.getElementById('reimport-btn').style.display = 'none';

            // éšè—ç­”é¢˜è¿›åº¦æ¡
            const quizHeader = document.getElementById('quiz-header');
            if (quizHeader) {
                quizHeader.style.display = 'none';
            }

            // é‡ç½®é¡µé¢æ ‡é¢˜
            document.querySelector('.header h1').textContent = 'ä¸­è¯ç­”é¢˜ç³»ç»Ÿ';

            // æ£€æŸ¥æ˜¯å¦æ˜¯é”™é¢˜æ¨¡å¼
            if (currentCategory && currentCategory.isWrongQuestionMode) {
                // è¿”å›é”™é¢˜åˆ—è¡¨é¡µé¢
                navigateTo('wrong-questions');
                // é‡ç½®é”™é¢˜æ¨¡å¼æ ‡è®°
                if (currentCategory) {
                    currentCategory.isWrongQuestionMode = false;
                }
            } else {
                // è¿”å›é¢˜åº“åˆ—è¡¨é¡µé¢
                navigateTo('home');
            }
        }

        // æ‰“å¼€é€‰é¢˜å¡
        function openQuestionSelector() {
            updateQuestionSelector();
            document.getElementById('question-selector-overlay').classList.add('show');
        }

        // å…³é—­é€‰é¢˜å¡
        function closeQuestionSelector(event) {
            // å¦‚æœæ˜¯ç‚¹å‡»overlayèƒŒæ™¯ï¼Œæˆ–è€…æ˜¯ç‚¹å‡»å…³é—­æŒ‰é’®
            if (event && event.target.id !== 'question-selector-overlay' && event.type === 'click') {
                return;
            }
            document.getElementById('question-selector-overlay').classList.remove('show');
        }

        // æ›´æ–°é€‰é¢˜å¡
        function updateQuestionSelector() {
            const grid = document.getElementById('question-selector-grid');
            let html = '';

            for (let i = 0; i < questions.length; i++) {
                const status = getQuestionStatus(i);
                const isCurrent = i === currentQuestionIndex;
                const currentClass = isCurrent ? 'current' : '';

                html += `
                    <button class="question-selector-item ${status} ${currentClass}"
                            onclick="jumpToQuestion(${i})">
                        ${i + 1}
                    </button>
                `;
            }

            grid.innerHTML = html;
        }

        // è·å–é¢˜ç›®çŠ¶æ€
        function getQuestionStatus(index) {
            const userAnswer = userAnswers[index];

            // å¦‚æœæ²¡æœ‰å›ç­”ï¼Œè¿”å›æœªç­”çŠ¶æ€
            if (!userAnswer) {
                return 'unanswered';
            }

            const question = questions[index];

            // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
            if (question.type === 'å•é€‰é¢˜') {
                const correctAnswer = getShuffledAnswer(index);
                return userAnswer === correctAnswer ? 'correct' : 'wrong';
            } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions) {
                let allCorrect = true;
                question.sub_questions.forEach((subQ, subIndex) => {
                    const correctAnswer = getShuffledSubAnswer(index, subIndex);
                    if (userAnswer[subIndex] !== correctAnswer) {
                        allCorrect = false;
                    }
                });
                return allCorrect ? 'correct' : 'wrong';
            }

            return 'unanswered';
        }

        // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
        function jumpToQuestion(index) {
            closeQuestionSelector();
            displayQuestion(index);
        }

        // æ‰“å¼€ä¿®æ”¹ç­”æ¡ˆå¼¹çª—
        function openEditAnswer() {
            const question = questions[currentQuestionIndex];
            const contentDiv = document.getElementById('edit-answer-content');

            let html = '';

            // æ·»åŠ é¢˜ç›®ç¼–è¾‘åŒºåŸŸ
            html += `
                <div class="question-edit-section">
                    <div class="question-label">
                        âœï¸ é¢˜ç›®å†…å®¹
                    </div>
                    <textarea id="question-text-textarea" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹...">${question.question || ''}</textarea>
                </div>
            `;

            if (question.type === 'å•é€‰é¢˜') {
                html += '<div style="margin-bottom: 15px; color: #666;">è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆï¼š</div>';
                html += '<div id="edit-options-list">';

                for (const [key, value] of Object.entries(question.options)) {
                    const isCurrentAnswer = question.answer === key;
                    html += `
                        <div class="edit-answer-option ${isCurrentAnswer ? 'selected' : ''}" onclick="selectEditOption(this)">
                            <input type="radio" name="edit_answer" value="${key}" ${isCurrentAnswer ? 'checked' : ''} id="edit_${key}">
                            <label for="edit_${key}" style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <strong style="flex-shrink: 0;">${key}.</strong>
                                <input type="text"
                                       id="edit_option_text_${key}"
                                       value="${value}"
                                       style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                       placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹">
                            </label>
                            <button type="button"
                                    class="btn btn-small btn-delete"
                                    onclick="event.stopPropagation(); removeOption('${key}')"
                                    style="flex-shrink: 0; padding: 4px 8px; font-size: 12px; margin-left: 5px;">
                                åˆ é™¤
                            </button>
                        </div>
                    `;
                }

                html += '</div>';

                // æ·»åŠ æ–°é€‰é¡¹åŒºåŸŸ
                html += `
                    <div class="add-option-section">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">â• æ·»åŠ æ–°é€‰é¡¹</div>
                        <div class="add-option-inputs">
                            <input type="text" id="new-option-key" placeholder="é€‰é¡¹ï¼ˆå¦‚Eï¼‰" maxlength="1">
                            <input type="text" id="new-option-value" placeholder="é€‰é¡¹å†…å®¹">
                            <button class="btn-add-option" onclick="addNewOption()">æ·»åŠ </button>
                        </div>
                    </div>
                `;

                // æ·»åŠ è§£æç¼–è¾‘åŒºåŸŸ
                const currentExplanation = question.explanation || '';
                html += `
                    <div class="explanation-edit-section">
                        <div class="explanation-label">
                            ğŸ“ é¢˜ç›®è§£æ
                            <span style="font-size: 12px; color: #999; font-weight: normal;">(å¯é€‰)</span>
                        </div>
                        <textarea id="explanation-textarea" placeholder="è¯·è¾“å…¥é¢˜ç›®è§£æå†…å®¹ï¼Œå¸®åŠ©ç†è§£æ­£ç¡®ç­”æ¡ˆ..." oninput="updateCharCount()">${currentExplanation}</textarea>
                        <div class="char-count">
                            <span id="char-count">${currentExplanation.length}</span> å­—ç¬¦
                        </div>
                    </div>
                `;
            } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜') {
                html += '<div style="margin-bottom: 15px; color: #666;">è¯·ä¸ºæ¯ä¸ªå°é¢˜é€‰æ‹©æ­£ç¡®ç­”æ¡ˆï¼š</div>';

                // æ˜¾ç¤ºå…±ç”¨é€‰é¡¹
                html += '<div style="background: #f0f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;" id="shared-options-display">';
                html += '<div style="font-weight: bold; margin-bottom: 10px; color: #667eea;">å…±ç”¨é€‰é¡¹ï¼ˆå¯ç¼–è¾‘ï¼‰ï¼š</div>';
                html += '<div id="edit-options-list">';
                for (const [key, value] of Object.entries(question.options)) {
                    html += `
                        <div class="edit-answer-option" style="background: white; border: 1px solid #ddd;" data-option-key="${key}">
                            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                <strong style="flex-shrink: 0;">${key}.</strong>
                                <input type="text"
                                       id="edit_option_text_${key}"
                                       value="${value}"
                                       style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                       placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹">
                                <button type="button"
                                        class="btn btn-small btn-delete"
                                        onclick="event.stopPropagation(); removeOption('${key}')"
                                        style="flex-shrink: 0; padding: 4px 8px; font-size: 12px;">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                html += '</div>';

                // æ·»åŠ æ–°é€‰é¡¹åŒºåŸŸï¼ˆé…ä¼é¢˜ï¼‰
                html += `
                    <div class="add-option-section">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">â• æ·»åŠ æ–°é€‰é¡¹ï¼ˆå°†åº”ç”¨åˆ°æ‰€æœ‰å°é¢˜ï¼‰</div>
                        <div class="add-option-inputs">
                            <input type="text" id="new-option-key" placeholder="é€‰é¡¹ï¼ˆå¦‚Eï¼‰" maxlength="1">
                            <input type="text" id="new-option-value" placeholder="é€‰é¡¹å†…å®¹">
                            <button class="btn-add-option" onclick="addNewOption()">æ·»åŠ </button>
                        </div>
                    </div>
                `;

                // ä¸ºæ¯ä¸ªå­é—®é¢˜åˆ›å»ºé€‰é¡¹
                if (question.sub_questions && question.sub_questions.length > 0) {
                    html += '<div id="sub-questions-container">';
                    question.sub_questions.forEach((subQ, subIndex) => {
                        html += `
                            <div class="sub-question-edit">
                                <div class="sub-question-edit-title">(${subQ.number || subIndex + 1}) ${subQ.question}</div>
                                <div class="sub-question-text-edit">
                                    <input type="text" id="sub-question-text-${subIndex}" placeholder="ç¼–è¾‘å°é¢˜å†…å®¹..." value="${subQ.question || ''}">
                                </div>
                                <div id="sub-question-options-${subIndex}">
                        `;

                        for (const key of Object.keys(question.options)) {
                            const isCurrentAnswer = subQ.answer === key;
                            html += `
                                <div class="edit-answer-option ${isCurrentAnswer ? 'selected' : ''}" onclick="selectEditOption(this)">
                                    <input type="radio" name="edit_sub_${subIndex}" value="${key}" ${isCurrentAnswer ? 'checked' : ''} id="edit_sub_${subIndex}_${key}">
                                    <label for="edit_sub_${subIndex}_${key}" style="flex: 1; cursor: pointer;">
                                        <strong>${key}</strong>
                                    </label>
                                </div>
                            `;
                        }

                        html += `
                                </div>
                                <div class="sub-question-explanation-edit" style="margin-top: 10px;">
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å°é¢˜è§£æï¼ˆå¯é€‰ï¼‰</label>
                                    <textarea id="sub-explanation-${subIndex}" placeholder="ä¸ºè¯¥å°é¢˜æ·»åŠ è§£æ..." style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">${subQ.explanation || ''}</textarea>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            // ä¸ºé…ä¼é¢˜ä¹Ÿæ·»åŠ è§£æç¼–è¾‘åŒºåŸŸ
            if (question.type === 'é…ä¼é€‰æ‹©é¢˜') {
                const currentExplanation = question.explanation || '';
                html += `
                    <div class="explanation-edit-section">
                        <div class="explanation-label">
                            ğŸ“ é¢˜ç›®è§£æ
                            <span style="font-size: 12px; color: #999; font-weight: normal;">(å¯é€‰)</span>
                        </div>
                        <textarea id="explanation-textarea" placeholder="è¯·è¾“å…¥é¢˜ç›®è§£æå†…å®¹ï¼Œå¸®åŠ©ç†è§£æ­£ç¡®ç­”æ¡ˆ..." oninput="updateCharCount()">${currentExplanation}</textarea>
                        <div class="char-count">
                            <span id="char-count">${currentExplanation.length}</span> å­—ç¬¦
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            document.getElementById('edit-answer-overlay').classList.add('show');
        }

        // åˆ é™¤é€‰é¡¹
        function removeOption(optionKey) {
            const question = questions[currentQuestionIndex];

            // å¯¹äºé…ä¼é€‰æ‹©é¢˜ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰å­é—®é¢˜ä½¿ç”¨äº†è¿™ä¸ªé€‰é¡¹
            if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions) {
                const usedInSubQuestions = question.sub_questions.some(subQ => subQ.answer === optionKey);
                if (usedInSubQuestions) {
                    alert('è¯¥é€‰é¡¹æ­£åœ¨è¢«å­é¢˜ä½¿ç”¨ï¼Œè¯·å…ˆä¿®æ”¹ç›¸å…³å­é¢˜çš„ç­”æ¡ˆï¼');
                    return;
                }
            }

            // å¯¹äºå•é€‰é¢˜ï¼Œä¸èƒ½åˆ é™¤å½“å‰é€‰ä¸­çš„æ­£ç¡®ç­”æ¡ˆ
            if (question.type === 'å•é€‰é¢˜' && question.answer === optionKey) {
                alert('ä¸èƒ½åˆ é™¤å½“å‰é€‰ä¸­çš„æ­£ç¡®ç­”æ¡ˆï¼è¯·å…ˆé€‰æ‹©å…¶ä»–ç­”æ¡ˆã€‚');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰é¡¹ ${optionKey} å—ï¼Ÿ`)) {
                delete question.options[optionKey];

                // é‡æ–°æ¸²æŸ“ç¼–è¾‘ç•Œé¢
                openEditAnswer();

                alert(`é€‰é¡¹ ${optionKey} å·²åˆ é™¤ï¼`);
            }
        }

        // æ·»åŠ æ–°é€‰é¡¹
        function addNewOption() {
            const keyInput = document.getElementById('new-option-key');
            const valueInput = document.getElementById('new-option-value');
            const key = keyInput.value.trim().toUpperCase();
            const value = valueInput.value.trim();

            if (!key || !value) {
                alert('è¯·è¾“å…¥é€‰é¡¹æ ‡ç­¾å’Œå†…å®¹ï¼');
                return;
            }

            // éªŒè¯é€‰é¡¹æ ‡ç­¾æ ¼å¼ï¼ˆåªå…è®¸å•ä¸ªå­—æ¯ï¼‰
            if (!/^[A-Z]$/.test(key)) {
                alert('é€‰é¡¹æ ‡ç­¾å¿…é¡»æ˜¯å•ä¸ªè‹±æ–‡å­—æ¯ï¼ˆA-Zï¼‰ï¼');
                return;
            }

            const question = questions[currentQuestionIndex];

            // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å·²å­˜åœ¨
            if (question.options[key]) {
                alert(`é€‰é¡¹ ${key} å·²å­˜åœ¨ï¼`);
                return;
            }

            // æ·»åŠ åˆ°é¢˜ç›®é€‰é¡¹ä¸­
            question.options[key] = value;

            // é‡æ–°æ¸²æŸ“ç¼–è¾‘ç•Œé¢ä»¥æ˜¾ç¤ºæ–°é€‰é¡¹
            openEditAnswer();

            // æç¤ºæˆåŠŸ
            alert(`é€‰é¡¹ ${key} æ·»åŠ æˆåŠŸï¼`);
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const textarea = document.getElementById('explanation-textarea');
            const charCount = document.getElementById('char-count');
            if (textarea && charCount) {
                charCount.textContent = textarea.value.length;
            }
        }

        // é€‰æ‹©ç¼–è¾‘é€‰é¡¹
        function selectEditOption(element) {
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            // ç§»é™¤åŒç»„å…¶ä»–é€‰é¡¹çš„é€‰ä¸­æ ·å¼
            const parent = element.parentElement;
            parent.querySelectorAll('.edit-answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            element.classList.add('selected');
        }

        // å…³é—­ä¿®æ”¹ç­”æ¡ˆå¼¹çª—
        function closeEditAnswer(event) {
            if (event && event.target.id !== 'edit-answer-overlay' && event.type === 'click') {
                return;
            }
            document.getElementById('edit-answer-overlay').classList.remove('show');
        }

        // ä¿å­˜ä¿®æ”¹çš„ç­”æ¡ˆ
        async function saveEditedAnswer() {
            const question = questions[currentQuestionIndex];

            // è·å–é¢˜ç›®å†…å®¹
            const questionTextarea = document.getElementById('question-text-textarea');
            const newQuestionText = questionTextarea ? questionTextarea.value.trim() : '';

            if (!newQuestionText) {
                alert('é¢˜ç›®å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            // æ›´æ–°é¢˜ç›®å†…å®¹
            question.question = newQuestionText;

            // è·å–è§£æå†…å®¹
            const explanationTextarea = document.getElementById('explanation-textarea');
            const newExplanation = explanationTextarea ? explanationTextarea.value.trim() : '';

            if (question.type === 'å•é€‰é¢˜') {
                const selectedOption = document.querySelector('input[name="edit_answer"]:checked');
                if (!selectedOption) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                    return;
                }

                const newAnswer = selectedOption.value;
                question.answer = newAnswer;

                // æ›´æ–°é€‰é¡¹å†…å®¹
                const updatedOptions = {};
                const optionInputs = document.querySelectorAll('[id^="edit_option_text_"]');
                optionInputs.forEach(input => {
                    const key = input.id.replace('edit_option_text_', '');
                    const value = input.value.trim();
                    if (value) {
                        updatedOptions[key] = value;
                    }
                });

                // ç¡®ä¿æ­£ç¡®ç­”æ¡ˆä»ç„¶å­˜åœ¨äºé€‰é¡¹ä¸­
                if (!updatedOptions[newAnswer]) {
                    alert('æ­£ç¡®ç­”æ¡ˆå¯¹åº”çš„é€‰é¡¹å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                    return;
                }

                question.options = updatedOptions;
                question.explanation = newExplanation; // ä¿å­˜è§£æ

            } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions) {
                // æ›´æ–°å­é—®é¢˜å†…å®¹å’Œè§£æ
                question.sub_questions.forEach((subQ, subIndex) => {
                    const subQuestionInput = document.getElementById(`sub-question-text-${subIndex}`);
                    if (subQuestionInput) {
                        subQ.question = subQuestionInput.value.trim();
                    }

                    const subExplanationTextarea = document.getElementById(`sub-explanation-${subIndex}`);
                    if (subExplanationTextarea) {
                        subQ.explanation = subExplanationTextarea.value.trim();
                    }
                });

                // æ›´æ–°é€‰é¡¹å†…å®¹
                const updatedOptions = {};
                const optionInputs = document.querySelectorAll('[id^="edit_option_text_"]');
                optionInputs.forEach(input => {
                    const key = input.id.replace('edit_option_text_', '');
                    const value = input.value.trim();
                    if (value) {
                        updatedOptions[key] = value;
                    }
                });

                // éªŒè¯æ‰€æœ‰å­é—®é¢˜çš„ç­”æ¡ˆä»ç„¶å­˜åœ¨äºé€‰é¡¹ä¸­
                let validAnswers = true;
                for (let subIndex = 0; subIndex < question.sub_questions.length; subIndex++) {
                    const selectedOption = document.querySelector(`input[name="edit_sub_${subIndex}"]:checked`);
                    if (selectedOption && !updatedOptions[selectedOption.value]) {
                        validAnswers = false;
                        break;
                    }
                }

                if (!validAnswers) {
                    alert('æŸäº›å­é—®é¢˜é€‰æ‹©çš„æ­£ç¡®ç­”æ¡ˆå¯¹åº”çš„é€‰é¡¹å†…å®¹ä¸ºç©ºï¼');
                    return;
                }

                question.options = updatedOptions;

                // æ›´æ–°å­é—®é¢˜ç­”æ¡ˆ
                for (let subIndex = 0; subIndex < question.sub_questions.length; subIndex++) {
                    const selectedOption = document.querySelector(`input[name="edit_sub_${subIndex}"]:checked`);
                    if (selectedOption) {
                        question.sub_questions[subIndex].answer = selectedOption.value;
                    }
                }
                question.explanation = newExplanation; // ä¿å­˜æ•´ä½“è§£æ
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            await updateQuestionInDB(currentCategory.id, currentQuestionIndex, question);

            // é‡æ–°åˆå§‹åŒ–é€‰é¡¹æ˜ å°„
            initializeQuestionMappings();

            // å…³é—­å¼¹çª—
            closeEditAnswer();

            // é‡æ–°æ˜¾ç¤ºå½“å‰é¢˜ç›®
            displayQuestion(currentQuestionIndex);

            alert('é¢˜ç›®ã€ç­”æ¡ˆå’Œè§£æå·²æ›´æ–°ï¼');
        }

        // æ›´æ–°æ•°æ®åº“ä¸­çš„é¢˜ç›®
        async function updateQuestionInDB(categoryId, questionIndex, updatedQuestion) {
            try {
                // è·å–å®Œæ•´çš„åˆ†ç±»æ•°æ®
                const category = await getCategoryById(categoryId);

                if (!category) {
                    throw new Error('Category not found');
                }

                // æ›´æ–°é¢˜ç›®
                category.questions[questionIndex] = updatedQuestion;

                // æ›´æ–°æ•°æ®åº“
                const transaction = db.transaction(['categories'], 'readwrite');
                const store = transaction.objectStore('categories');
                await store.put(category);

                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => {
                        console.log('Question updated successfully');
                        // åŒæ­¥æ›´æ–°å½“å‰å†…å­˜ä¸­çš„é¢˜ç›®
                        questions[questionIndex] = updatedQuestion;
                        resolve();
                    };
                    transaction.onerror = () => reject(transaction.error);
                });
            } catch (error) {
                console.error('Error updating question:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        async function displayQuestion(index) {
            if (index >= questions.length) {
                await showResults();
                return;
            }

            // æ˜¾ç¤ºç­”é¢˜è¿›åº¦æ¡
            const quizHeader = document.getElementById('quiz-header');
            if (quizHeader) {
                quizHeader.style.display = 'block';
            }

            currentQuestionIndex = index;
            isRestoringAnswer = false; // é‡ç½®æ¢å¤ç­”æ¡ˆæ ‡å¿—
            const question = questions[index];
            const container = document.getElementById('question-container');

            // å…ˆæ¸…é™¤å®¹å™¨å†…å®¹ï¼Œç¡®ä¿ç§»é™¤ä¸Šä¸€é¢˜çš„æ‰€æœ‰çŠ¶æ€
            container.innerHTML = '';

            // é¢å¤–ç¡®ä¿æ¸…é™¤æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„é€‰ä¸­çŠ¶æ€ï¼ˆé˜²æ­¢ç§»åŠ¨ç«¯å‡ºç°é€‰ä¸­æ ·å¼ï¼‰
            document.querySelectorAll('.option').forEach(el => {
                el.classList.remove('selected');
                el.classList.remove('correct');
                el.classList.remove('wrong');
                const radio = el.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = false;
                }
            });

            let html = `
                <div class="question-card">
                    <span class="question-type">${question.type}</span>
            `;

            // å¦‚æœæœ‰ææ–™é¢˜å†…å®¹ï¼Œæ˜¾ç¤ºåœ¨é¢˜ç›®ä¹‹å‰
            if (question.material && question.material.trim() !== '') {
                html += `
                    <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 14px;">ğŸ“‹ ææ–™é¢˜</div>
                        <div style="color: #333; line-height: 1.8; font-size: 15px;">${question.material}</div>
                    </div>
                `;
            }

            html += `<div class="question-title">${index + 1}. ${question.question}</div>
            `;

            if (question.type === 'å•é€‰é¢˜') {
                html += renderSingleChoice(question, index);
            } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜') {
                html += renderMatchingChoice(question, index);
            }

            html += `
                    <div class="explanation" id="explanation-${index}">
                    </div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="backToCategoryList()">è¿”å›åˆ†ç±»</button>
                        <button class="btn btn-secondary" onclick="openEditAnswer()" style="background: #ff9800; color: white; border-color: #ff9800;">ä¿®æ”¹ç­”æ¡ˆ</button>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // æ¢å¤ç”¨æˆ·ä¹‹å‰çš„ç­”æ¡ˆ
            if (userAnswers[index]) {
                // åœ¨æ¢å¤ç­”æ¡ˆå‰ï¼Œå†æ¬¡ç¡®ä¿æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ®‹ç•™æ ·å¼ï¼ˆé˜²æ­¢ç§»åŠ¨ç«¯å‡ºç°é€‰ä¸­æ ·å¼ï¼‰
                document.querySelectorAll('.option').forEach(el => {
                    el.classList.remove('selected');
                    el.classList.remove('correct');
                    el.classList.remove('wrong');
                    const radio = el.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = false;
                    }
                });

                restoreAnswer(index);
            } else {
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·ç­”æ¡ˆï¼Œç¡®ä¿æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€å’Œcheckedå±æ€§ï¼ˆé˜²æ­¢ç§»åŠ¨ç«¯å‡ºç°é€‰ä¸­æ ·å¼ï¼‰
                setTimeout(() => {
                    document.querySelectorAll('.option').forEach(el => {
                        el.classList.remove('selected');
                        el.classList.remove('correct');
                        el.classList.remove('wrong');
                        const radio = el.querySelector('input[type="radio"]');
                        if (radio) {
                            radio.checked = false;
                        }
                    });
                }, 0);
            }

            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            updateNavigationButtons();

            updateProgress();
        }

        // æ¸²æŸ“å•é€‰é¢˜
        function renderSingleChoice(question, questionIndex) {
            let html = '<div class="options">';

            // ä½¿ç”¨æ‰“ä¹±åçš„é€‰é¡¹
            const mapping = optionMappings[questionIndex];
            const optionsToRender = mapping ? mapping.newOptions : question.options;

            for (const [key, value] of Object.entries(optionsToRender)) {
                html += `
                    <div class="option" onclick="selectOption(this, '${key}', ${questionIndex})">
                        <input type="radio" name="q${questionIndex}" value="${key}" id="q${questionIndex}_${key}">
                        <label class="option-label" for="q${questionIndex}_${key}">
                            <strong>${key}.</strong> ${value}
                        </label>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // æ¸²æŸ“é…ä¼é€‰æ‹©é¢˜
        function renderMatchingChoice(question, questionIndex) {
            let html = '<div class="options" style="margin-bottom: 20px;">';
            html += '<div style="font-weight: bold; margin-bottom: 10px; color: #667eea;">å…±ç”¨é€‰é¡¹ï¼š</div>';

            // ä½¿ç”¨æ‰“ä¹±åçš„é€‰é¡¹
            const mapping = optionMappings[questionIndex];
            const optionsToRender = mapping ? mapping.newOptions : question.options;

            for (const [key, value] of Object.entries(optionsToRender)) {
                html += `
                    <div style="padding: 8px 15px; background: #f0f3ff; margin: 5px 0; border-radius: 5px;">
                        <strong>${key}.</strong> ${value}
                    </div>
                `;
            }
            html += '</div>';

            // æ¸²æŸ“å­é—®é¢˜
            if (question.sub_questions && question.sub_questions.length > 0) {
                question.sub_questions.forEach((subQ, subIndex) => {
                    html += `
                        <div class="sub-question">
                            <div class="sub-question-title">(${subQ.number || subIndex + 1}) ${subQ.question}</div>
                            <div class="options">
                    `;

                    for (const key of Object.keys(optionsToRender)) {
                        html += `
                            <div class="option" onclick="selectOption(this, '${key}', ${questionIndex}, ${subIndex})">
                                <input type="radio" name="q${questionIndex}_sub${subIndex}" value="${key}" id="q${questionIndex}_sub${subIndex}_${key}">
                                <label class="option-label" for="q${questionIndex}_sub${subIndex}_${key}">
                                    <strong>${key}</strong>
                                </label>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                });
            } else {
                // å¦‚æœæ²¡æœ‰sub_questionsï¼Œæ˜¾ç¤ºå…±ç”¨é€‰é¡¹ä¾›é€‰æ‹©
                html += '<div class="options">';
                for (const key of Object.keys(optionsToRender)) {
                    html += `
                        <div class="option" onclick="selectOption(this, '${key}', ${questionIndex})">
                            <input type="radio" name="q${questionIndex}" value="${key}" id="q${questionIndex}_${key}">
                            <label class="option-label" for="q${questionIndex}_${key}">
                                <strong>${key}</strong>
                            </label>
                        </div>
                    `;
                }
                html += '</div>';
            }

            return html;
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(element, value, questionIndex, subIndex) {
            const question = questions[questionIndex];

            // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å·²è¢«ç¦ç”¨ï¼ˆå·²ç»å›ç­”è¿‡ï¼‰
            const radio = element.querySelector('input[type="radio"]');
            if (radio.disabled) {
                return; // å·²ç»å›ç­”è¿‡ï¼Œä¸å…è®¸å†æ¬¡é€‰æ‹©
            }

            // è®¾ç½®radioé€‰ä¸­
            radio.checked = true;

            // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
            if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions && question.sub_questions.length > 0) {
                if (!userAnswers[questionIndex]) {
                    userAnswers[questionIndex] = {};
                }
                userAnswers[questionIndex][subIndex] = value;

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­é—®é¢˜éƒ½å·²å›ç­”
                const allAnswered = question.sub_questions.every((_, idx) => {
                    return userAnswers[questionIndex] && userAnswers[questionIndex][idx];
                });

                if (allAnswered) {
                    // ç«‹å³æ˜¾ç¤ºç­”æ¡ˆ
                    showAnswerImmediate();
                }
            } else {
                userAnswers[questionIndex] = value;
                // ç«‹å³æ˜¾ç¤ºç­”æ¡ˆ
                showAnswerImmediate();
            }

            updateProgress();
        }

        // ç«‹å³æ˜¾ç¤ºç­”æ¡ˆå’Œè§£æ
        async function showAnswerImmediate() {
            const question = questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const mapping = optionMappings[currentQuestionIndex];

            let isCorrect = false;
            let correctAnswerText = '';
            let hasAnswer = false;

            // é¦–å…ˆæ¸…é™¤æ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€ï¼ˆä»…ç”¨äºæ¸…ç†ï¼Œé˜²æ­¢ç§»åŠ¨ç«¯å‡ºç°é€‰ä¸­æ ·å¼ï¼‰
            const allOptionElements = document.querySelectorAll('.option');
            allOptionElements.forEach(opt => {
                opt.classList.remove('selected');
                opt.classList.remove('correct');
                opt.classList.remove('wrong');
            });

            // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
            if (question.type === 'å•é€‰é¢˜') {
                const correctAnswer = getShuffledAnswer(currentQuestionIndex);
                hasAnswer = correctAnswer && correctAnswer.trim() !== '';

                if (hasAnswer) {
                    const allOptions = document.querySelectorAll(`input[name="q${currentQuestionIndex}"]`);

                    allOptions.forEach(option => {
                        const optionDiv = option.closest('.option');
                        if (option.value === correctAnswer) {
                            optionDiv.classList.add('correct');
                            correctAnswerText = `<strong>${correctAnswer}</strong>. ${mapping.newOptions[correctAnswer]}`;
                        } else if (option.value === userAnswer && userAnswer !== correctAnswer) {
                            optionDiv.classList.add('wrong');
                        }
                        option.disabled = true;
                        optionDiv.style.cursor = 'not-allowed';
                    });

                    isCorrect = userAnswer === correctAnswer;

                    // å¦‚æœç­”é”™äº†ï¼Œä¿å­˜åˆ°é”™é¢˜åº“ï¼ˆé”™é¢˜æ¨¡å¼ä¸‹ä¸ä¿å­˜ï¼‰
                    if (!isCorrect && currentCategory && !currentCategory.isWrongQuestionMode) {
                        // ç»„åˆç­”é¢˜æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨é¢˜ç›®çš„åŸå§‹åˆ†ç±»ä¿¡æ¯
                        if (currentCategory.isCombinedMode && question._categoryId) {
                            await saveWrongQuestionToDB(
                                question._categoryId,
                                question._categoryName,
                                question,
                                currentQuestionIndex
                            );
                        } else {
                            await saveWrongQuestionToDB(
                                currentCategory.id,
                                currentCategory.name,
                                question,
                                currentQuestionIndex
                            );
                        }
                    }

                    // å¦‚æœæ˜¯é”™é¢˜æ¨¡å¼ä¸”ç­”å¯¹äº†ï¼Œä»é”™é¢˜åº“ä¸­åˆ é™¤
                    if (isCorrect && currentCategory && currentCategory.isWrongQuestionMode) {
                        await removeCorrectWrongQuestion(currentQuestionIndex);
                    }
                } else {
                    const allOptions = document.querySelectorAll(`input[name="q${currentQuestionIndex}"]`);
                    allOptions.forEach(option => {
                        option.disabled = true;
                        option.closest('.option').style.cursor = 'not-allowed';
                    });
                    correctAnswerText = '<span style="color: #999;">æœ¬é¢˜æš‚æ— æ ‡å‡†ç­”æ¡ˆ</span>';
                }
            } else if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions) {
                let allSubCorrect = true;
                let correctAnswers = [];
                hasAnswer = true;

                question.sub_questions.forEach((subQ, subIndex) => {
                    const correctAnswer = getShuffledSubAnswer(currentQuestionIndex, subIndex);
                    const userSubAnswer = userAnswer[subIndex];
                    const allOptions = document.querySelectorAll(`input[name="q${currentQuestionIndex}_sub${subIndex}"]`);

                    if (correctAnswer && correctAnswer.trim() !== '') {
                        correctAnswers.push(`<div style="margin: 5px 0;"><strong>(${subQ.number || subIndex + 1})</strong> ${correctAnswer}. ${mapping.newOptions[correctAnswer]}</div>`);

                        allOptions.forEach(option => {
                            const optionDiv = option.closest('.option');
                            if (option.value === correctAnswer) {
                                optionDiv.classList.add('correct');
                            } else if (option.value === userSubAnswer && userSubAnswer !== correctAnswer) {
                                optionDiv.classList.add('wrong');
                                allSubCorrect = false;
                            }
                            option.disabled = true;
                            optionDiv.style.cursor = 'not-allowed';
                        });

                        if (userSubAnswer !== correctAnswer) {
                            allSubCorrect = false;
                        }
                    } else {
                        allOptions.forEach(option => {
                            option.disabled = true;
                            option.closest('.option').style.cursor = 'not-allowed';
                        });
                        correctAnswers.push(`<div style="margin: 5px 0; color: #999;"><strong>(${subQ.number || subIndex + 1})</strong> æš‚æ— æ ‡å‡†ç­”æ¡ˆ</div>`);
                        hasAnswer = false;
                    }
                });

                isCorrect = allSubCorrect;
                correctAnswerText = correctAnswers.join('');

                // å¦‚æœç­”é”™äº†ï¼Œä¿å­˜åˆ°é”™é¢˜åº“ï¼ˆé”™é¢˜æ¨¡å¼ä¸‹ä¸ä¿å­˜ï¼‰
                if (!isCorrect && currentCategory && !currentCategory.isWrongQuestionMode) {
                    // ç»„åˆç­”é¢˜æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨é¢˜ç›®çš„åŸå§‹åˆ†ç±»ä¿¡æ¯
                    if (currentCategory.isCombinedMode && question._categoryId) {
                        await saveWrongQuestionToDB(
                            question._categoryId,
                            question._categoryName,
                            question,
                            currentQuestionIndex
                        );
                    } else {
                        await saveWrongQuestionToDB(
                            currentCategory.id,
                            currentCategory.name,
                            question,
                            currentQuestionIndex
                        );
                    }
                }

                // å¦‚æœæ˜¯é”™é¢˜æ¨¡å¼ä¸”ç­”å¯¹äº†ï¼Œä»é”™é¢˜åº“ä¸­åˆ é™¤
                if (isCorrect && currentCategory && currentCategory.isWrongQuestionMode) {
                    await removeCorrectWrongQuestion(currentQuestionIndex);
                }
            }

            // æ›´æ–°è§£æåŒºåŸŸ
            const explanationDiv = document.getElementById(`explanation-${currentQuestionIndex}`);
            let explanationHTML = '';

            if (hasAnswer) {
                const resultIcon = isCorrect ? 'âœ…' : 'âŒ';
                const resultText = isCorrect
                    ? '<span style="color: #4caf50; font-weight: bold;">å›ç­”æ­£ç¡®ï¼</span>'
                    : '<span style="color: #f44336; font-weight: bold;">å›ç­”é”™è¯¯ï¼</span>';

                explanationHTML += `
                    <div style="margin-bottom: 15px; font-size: 18px;">
                        ${resultIcon} ${resultText}
                    </div>
                `;

                // å¦‚æœæ˜¯é”™é¢˜æ¨¡å¼ä¸”ç­”å¯¹äº†ï¼Œæ˜¾ç¤ºæç¤º
                if (isCorrect && currentCategory && currentCategory.isWrongQuestionMode) {
                    explanationHTML += `
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                            <span style="color: #2e7d32; font-weight: 500;">âœ¨ å¤ªæ£’äº†ï¼è¯¥é¢˜å·²ä»é”™é¢˜æœ¬ä¸­ç§»é™¤</span>
                        </div>
                    `;
                }
            }

            explanationHTML += `
                <div style="background: #f0f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #4caf50; margin-bottom: 8px;">æ­£ç¡®ç­”æ¡ˆï¼š</div>
                    <div style="color: #333; line-height: 1.8;">${correctAnswerText}</div>
                </div>
            `;

            // ä¸ºé…ä¼é¢˜æ˜¾ç¤ºå„å­é—®é¢˜çš„è§£æ
            if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions) {
                question.sub_questions.forEach((subQ, subIndex) => {
                    if (subQ.explanation && subQ.explanation.trim() !== '') {
                        explanationHTML += `
                            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #2196F3;">
                                <div style="font-weight: bold; color: #1976D2; margin-bottom: 8px; font-size: 13px;">å°é¢˜(${subQ.number || subIndex + 1})è§£æ</div>
                                <div style="color: #555; line-height: 1.6; font-size: 14px;">${subQ.explanation}</div>
                            </div>
                        `;
                    }
                });
            }

            if (question.explanation && question.explanation.trim() !== '') {
                explanationHTML += `
                    <div style="background: #fff9e6; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <div style="font-weight: bold; color: #f57c00; margin-bottom: 10px;">æ•´ä½“è§£æ</div>
                        <div style="color: #555; line-height: 1.8;">${question.explanation}</div>
                    </div>
                `;
            }

            explanationDiv.innerHTML = explanationHTML;
            explanationDiv.classList.add('show');

            // ç§»é™¤è‡ªåŠ¨è·³è½¬åŠŸèƒ½ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"ä¸‹ä¸€é¢˜"æŒ‰é’®
            // ä¹‹å‰çš„è‡ªåŠ¨è·³è½¬ä»£ç å·²æ³¨é‡Šæ‰
            /*
            // å¦‚æœç­”å¯¹äº†ï¼Œä¸”ä¸æ˜¯åœ¨æ¢å¤ç­”æ¡ˆï¼ˆæŸ¥çœ‹å·²ç­”é¢˜ï¼‰ï¼Œå»¶è¿Ÿåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
            if (hasAnswer && isCorrect && !isRestoringAnswer) {
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨å½“å‰é¢˜ï¼ˆç”¨æˆ·å¯èƒ½å·²ç»æ‰‹åŠ¨åˆ‡æ¢äº†ï¼‰
                    if (currentQuestionIndex === getCurrentQuestionIndexFromDOM()) {
                        nextQuestion();
                    }
                }, 1500); // å»¶è¿Ÿ1.5ç§’è®©ç”¨æˆ·çœ‹åˆ°"å›ç­”æ­£ç¡®"æç¤º
            }
            */
        }

        // è·å–å½“å‰æ˜¾ç¤ºçš„é¢˜ç›®ç´¢å¼•ï¼ˆä»DOMåˆ¤æ–­ï¼‰
        function getCurrentQuestionIndexFromDOM() {
            // é€šè¿‡æ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„é¢˜ç›®ç´¢å¼•æ¥åˆ¤æ–­
            return currentQuestionIndex;
        }

        // ä»é”™é¢˜åº“ä¸­åˆ é™¤ç­”å¯¹çš„é¢˜ç›®
        async function removeCorrectWrongQuestion(questionIndex) {
            try {
                const wrongQuestionId = wrongQuestionIds[questionIndex];
                if (wrongQuestionId) {
                    await deleteWrongQuestion(wrongQuestionId);
                    console.log('Correct answer! Removed from wrong questions.');
                }
            } catch (error) {
                console.error('Error removing wrong question:', error);
            }
        }

        // æ¢å¤ç­”æ¡ˆ
        function restoreAnswer(index) {
            const answer = userAnswers[index];
            const question = questions[index];

            if (!answer) return;

            // è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºæ­£åœ¨æ¢å¤ç­”æ¡ˆï¼Œé¿å…è§¦å‘è‡ªåŠ¨è·³è½¬
            isRestoringAnswer = true;

            if (question.type === 'é…ä¼é€‰æ‹©é¢˜' && question.sub_questions && question.sub_questions.length > 0) {
                // é…ä¼é¢˜å¤šä¸ªå­é—®é¢˜
                Object.keys(answer).forEach(subIndex => {
                    const value = answer[subIndex];
                    const radio = document.getElementById(`q${index}_sub${subIndex}_${value}`);
                    if (radio) {
                        radio.checked = true;
                        // ä¸æ·»åŠ  selected ç±»ï¼Œå› ä¸ºå·²ç»å›ç­”è¿‡çš„é¢˜ç›®åº”è¯¥æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯çŠ¶æ€
                    }
                });

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­é—®é¢˜éƒ½å·²å›ç­”
                const allAnswered = question.sub_questions.every((_, idx) => {
                    return answer[idx];
                });

                if (allAnswered) {
                    showAnswerImmediate();
                }
            } else {
                // å•é€‰é¢˜æˆ–é…ä¼é¢˜å•ä¸ªé—®é¢˜
                const radio = document.getElementById(`q${index}_${answer}`);
                if (radio) {
                    radio.checked = true;
                    // ä¸æ·»åŠ  selected ç±»ï¼Œå› ä¸ºå·²ç»å›ç­”è¿‡çš„é¢˜ç›®åº”è¯¥æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯çŠ¶æ€
                }
                showAnswerImmediate();
            }

            // é‡ç½®æ ‡å¿—
            isRestoringAnswer = false;
        }

        // ä¸‹ä¸€é¢˜
        async function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                await displayQuestion(currentQuestionIndex + 1);
            } else {
                await showResults();
            }
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // æ§åˆ¶ä¸Šä¸€é¢˜æŒ‰é’®çš„æ˜¾ç¤º
            if (currentQuestionIndex > 0) {
                prevBtn.style.display = 'inline-block';
            } else {
                prevBtn.style.display = 'none';
            }

            // æ›´æ–°ä¸‹ä¸€é¢˜æŒ‰é’®çš„æ–‡æœ¬
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.textContent = 'å®Œæˆ';
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
            }
        }

        // ä¸Šä¸€é¢˜
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const answered = userAnswers.filter(a => a !== null).length;
            const total = questions.length;
            const progress = (answered / total) * 100;

            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('answered-count').textContent = answered;
            document.getElementById('progress-bar').style.width = progress + '%';

            // è®¡ç®—æ­£ç¡®ç‡
            let correctCount = 0;
            let totalAnswered = 0;

            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (!userAnswer) return;

                totalAnswered++;

                if (q.type === 'å•é€‰é¢˜') {
                    const correctAnswer = getShuffledAnswer(index);
                    if (userAnswer === correctAnswer) correctCount++;
                } else if (q.type === 'é…ä¼é€‰æ‹©é¢˜' && q.sub_questions) {
                    let allCorrect = true;
                    q.sub_questions.forEach((subQ, subIndex) => {
                        const correctAnswer = getShuffledSubAnswer(index, subIndex);
                        if (userAnswer[subIndex] !== correctAnswer) {
                            allCorrect = false;
                        }
                    });
                    if (allCorrect) correctCount++;
                }
            });

            const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // æ˜¾ç¤ºç»“æœ
        async function showResults() {
            let correctCount = 0;
            const total = questions.length;

            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (!userAnswer) return;

                if (q.type === 'å•é€‰é¢˜') {
                    const correctAnswer = getShuffledAnswer(index);
                    if (userAnswer === correctAnswer) correctCount++;
                } else if (q.type === 'é…ä¼é€‰æ‹©é¢˜' && q.sub_questions) {
                    let allCorrect = true;
                    q.sub_questions.forEach((subQ, subIndex) => {
                        const correctAnswer = getShuffledSubAnswer(index, subIndex);
                        if (userAnswer[subIndex] !== correctAnswer) {
                            allCorrect = false;
                        }
                    });
                    if (allCorrect) correctCount++;
                }
            });

            const score = Math.round((correctCount / total) * 100);

            // è®¡ç®—ç­”é¢˜ç”¨æ—¶
            let timeDisplay = '';
            if (quizStartTime) {
                quizEndTime = Date.now();
                const timeSpent = Math.floor((quizEndTime - quizStartTime) / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                timeDisplay = `<p style="margin-top: 15px; font-size: 18px; color: #667eea;">
                    <strong>â±ï¸ ç­”é¢˜ç”¨æ—¶ï¼š${minutes}åˆ†${seconds}ç§’</strong>
                </p>`;
            }

            document.getElementById('question-container').style.display = 'none';
            document.getElementById('quiz-navigation').style.display = 'none';
            document.getElementById('final-score').textContent = score;
            document.getElementById('result-total').textContent = total;
            document.getElementById('result-correct').textContent = correctCount;
            document.getElementById('result-wrong').textContent = total - correctCount;

            // å¦‚æœæ˜¯é”™é¢˜æ¨¡å¼ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            const resultSummary = document.getElementById('result-summary');
            const resultDetails = resultSummary.querySelector('.result-details');

            // æ·»åŠ ç”¨æ—¶æ˜¾ç¤º
            if (timeDisplay) {
                // ç§»é™¤æ—§çš„ç”¨æ—¶æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                const oldTimeDisplay = resultDetails.querySelector('.time-display');
                if (oldTimeDisplay) oldTimeDisplay.remove();

                // æ·»åŠ æ–°çš„ç”¨æ—¶æ˜¾ç¤º
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-display';
                timeDiv.innerHTML = timeDisplay;
                resultDetails.appendChild(timeDiv);
            }

            if (currentCategory && currentCategory.isWrongQuestionMode) {
                const resultTitle = resultSummary.querySelector('.result-title');
                resultTitle.textContent = 'é”™é¢˜ç»ƒä¹ å®Œæˆï¼';

                // åœ¨ç»“æœè¯¦æƒ…åæ·»åŠ ç§»é™¤æç¤º
                const removedCount = correctCount;
                if (removedCount > 0) {
                    const removedInfo = document.createElement('p');
                    removedInfo.style.color = '#4caf50';
                    removedInfo.style.fontWeight = 'bold';
                    removedInfo.style.marginTop = '15px';
                    removedInfo.innerHTML = `âœ¨ å·²ä»é”™é¢˜æœ¬ä¸­ç§»é™¤ ${removedCount} é“é¢˜`;

                    // ç§»é™¤æ—§çš„æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                    const oldInfo = resultDetails.querySelector('.removed-info');
                    if (oldInfo) oldInfo.remove();

                    removedInfo.className = 'removed-info';
                    resultDetails.appendChild(removedInfo);
                }
            } else {
                // é‡ç½®æ ‡é¢˜ä¸ºæ­£å¸¸æ¨¡å¼
                const resultTitle = resultSummary.querySelector('.result-title');
                resultTitle.textContent = 'ç­”é¢˜å®Œæˆï¼';

                // ç§»é™¤é”™é¢˜æ¨¡å¼çš„æç¤º
                const oldInfo = resultDetails.querySelector('.removed-info');
                if (oldInfo) oldInfo.remove();
            }

            // ä¿å­˜ç­”é¢˜è®°å½•åˆ°æ•°æ®åº“ï¼ˆéé”™é¢˜æ¨¡å¼ï¼‰
            if (currentCategory && !currentCategory.isWrongQuestionMode) {
                try {
                    // è®¡ç®—ç­”é¢˜ç”¨æ—¶ï¼ˆç§’ï¼‰
                    quizEndTime = Date.now();
                    const timeSpent = quizStartTime ? Math.floor((quizEndTime - quizStartTime) / 1000) : 0;
                    console.log(`ç­”é¢˜ç”¨æ—¶: ${Math.floor(timeSpent / 60)}åˆ†${timeSpent % 60}ç§’`);

                    // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°ï¼Œæ”¯æŒç»„åˆç­”é¢˜æ¨¡å¼
                    await saveQuizRecordToDBWithCombined(
                        currentCategory.id,
                        currentCategory.name,
                        total,
                        correctCount,
                        score,
                        timeSpent // ä¼ å…¥å®é™…ç”¨æ—¶
                    );
                    console.log('Quiz record saved successfully');

                    // è®°å½•é¢˜ç›®ç­”é¢˜å†å²
                    if (currentCategory.isCombinedMode) {
                        // ç»„åˆç­”é¢˜æ¨¡å¼ï¼šåˆ†åˆ«è®°å½•æ¯ä¸ªåˆ†ç±»çš„é¢˜ç›®
                        const categorizedQuestions = {};
                        questions.forEach(q => {
                            const catId = q._categoryId || currentCategory.id;
                            if (!categorizedQuestions[catId]) {
                                categorizedQuestions[catId] = [];
                            }
                            categorizedQuestions[catId].push(q);
                        });

                        // åˆ†åˆ«è®°å½•æ¯ä¸ªåˆ†ç±»
                        for (let catId in categorizedQuestions) {
                            await recordQuestionHistory(parseInt(catId), categorizedQuestions[catId]);
                        }
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼šç›´æ¥è®°å½•
                        await recordQuestionHistory(currentCategory.id, questions);
                    }
                    console.log('Question history recorded');

                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
                    const successNotification = document.createElement('div');
                    successNotification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4caf50;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        z-index: 10000;
                        animation: slideIn 0.3s ease-out;
                        font-weight: 500;
                    `;
                    successNotification.innerHTML = 'âœ… ç­”é¢˜è®°å½•å·²ä¿å­˜';
                    document.body.appendChild(successNotification);

                    // æ·»åŠ åŠ¨ç”»
                    const style = document.createElement('style');
                    style.innerHTML = `
                        @keyframes slideIn {
                            from {
                                transform: translateX(400px);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        @keyframes slideOut {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }
                            to {
                                transform: translateX(400px);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);

                    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        successNotification.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => {
                            document.body.removeChild(successNotification);
                        }, 300);
                    }, 3000);

                } catch (error) {
                    console.error('Error saving quiz record:', error);

                    // æ˜¾ç¤ºä¿å­˜å¤±è´¥çš„æç¤º
                    const errorNotification = document.createElement('div');
                    errorNotification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #f44336;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        z-index: 10000;
                        animation: slideIn 0.3s ease-out;
                        font-weight: 500;
                    `;
                    errorNotification.innerHTML = 'âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
                    document.body.appendChild(errorNotification);

                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        errorNotification.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => {
                            document.body.removeChild(errorNotification);
                        }, 300);
                    }, 5000);
                }
            }

            resultSummary.classList.add('show');
            showingResults = true;
        }

        // é‡æ–°å¼€å§‹
        function restartQuiz() {
            userAnswers = new Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            showingResults = false;

            // é‡æ–°æ‰“ä¹±é€‰é¡¹
            initializeQuestionMappings();

            document.getElementById('result-summary').classList.remove('show');
            document.getElementById('question-container').style.display = 'block';
            document.getElementById('quiz-navigation').style.display = 'block';

            // é‡æ–°è®°å½•å¼€å§‹æ—¶é—´
            quizStartTime = Date.now();
            console.log('é‡æ–°ç­”é¢˜å¼€å§‹æ—¶é—´:', new Date(quizStartTime).toLocaleString('zh-CN'));

            displayQuestion(0);
        }

        // æŸ¥çœ‹ç­”æ¡ˆ
        function reviewAnswers() {
            showingResults = false;
            document.getElementById('result-summary').classList.remove('show');
            document.getElementById('question-container').style.display = 'block';
            document.getElementById('quiz-navigation').style.display = 'block';
            displayQuestion(0);
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        async function exportAllData() {
            try {
                // è·å–æ‰€æœ‰åˆ†ç±»å’Œé”™é¢˜
                const categories = await getAllCategories();
                const wrongQuestions = await getAllWrongQuestions();

                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    categories: categories,
                    wrongQuestions: wrongQuestions
                };

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ä¸­è¯ç­”é¢˜ç³»ç»Ÿå¤‡ä»½_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // è·å–æ‰€æœ‰é”™é¢˜ï¼ˆä¸åˆ†ç»„ï¼‰
        async function getAllWrongQuestions() {
            const transaction = db.transaction(['wrongQuestions'], 'readonly');
            const store = transaction.objectStore('wrongQuestions');
            const request = store.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // å¯¼å…¥æ•°æ®
        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importData = JSON.parse(text);

                // éªŒè¯æ•°æ®æ ¼å¼
                if (!importData.version || !importData.categories) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–ç°æœ‰æ•°æ®
                const shouldMerge = confirm('æ˜¯å¦åˆå¹¶æ•°æ®ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ï¼šåˆå¹¶å¯¼å…¥çš„æ•°æ®å’Œç°æœ‰æ•°æ®\nç‚¹å‡»"å–æ¶ˆ"ï¼šæ¸…ç©ºç°æœ‰æ•°æ®å¹¶å¯¼å…¥ï¼ˆä¼šåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼‰');

                if (!shouldMerge) {
                    // æ¸…ç©ºç°æœ‰æ•°æ®
                    await clearAllData();
                }

                // å¯¼å…¥åˆ†ç±»æ•°æ®
                let categoriesImported = 0;
                for (const category of importData.categories) {
                    // ç§»é™¤è‡ªåŠ¨ç”Ÿæˆçš„IDï¼Œè®©æ•°æ®åº“é‡æ–°ç”Ÿæˆ
                    const categoryData = {
                        name: category.name,
                        questions: category.questions,
                        createdAt: category.createdAt || new Date().toISOString(),
                        count: category.count
                    };

                    try {
                        await saveCategoryToDB(categoryData.name, categoryData.questions);
                        categoriesImported++;
                    } catch (error) {
                        console.error('Error importing category:', error);
                    }
                }

                // å¯¼å…¥é”™é¢˜æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                let wrongQuestionsImported = 0;
                if (importData.wrongQuestions && importData.wrongQuestions.length > 0) {
                    const transaction = db.transaction(['wrongQuestions'], 'readwrite');
                    const store = transaction.objectStore('wrongQuestions');

                    for (const wq of importData.wrongQuestions) {
                        try {
                            // ç§»é™¤è‡ªåŠ¨ç”Ÿæˆçš„ID
                            const wrongQuestionData = {
                                categoryId: wq.categoryId,
                                categoryName: wq.categoryName,
                                question: wq.question,
                                questionIndex: wq.questionIndex,
                                addedAt: wq.addedAt || new Date().toISOString()
                            };

                            store.add(wrongQuestionData);
                            wrongQuestionsImported++;
                        } catch (error) {
                            console.error('Error importing wrong question:', error);
                        }
                    }

                    await new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                }

                // é‡ç½®æ–‡ä»¶è¾“å…¥
                event.target.value = '';

                // åˆ·æ–°åˆ†ç±»åˆ—è¡¨å¹¶è¿”å›é¦–é¡µ
                navigateTo('home');

                alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå¯¼å…¥äº† ${categoriesImported} ä¸ªé¢˜åº“åˆ†ç±»\nå¯¼å…¥äº† ${wrongQuestionsImported} é“é”™é¢˜`);
            } catch (error) {
                console.error('Error importing data:', error);
                alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                event.target.value = '';
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            const transaction = db.transaction(['categories', 'wrongQuestions'], 'readwrite');

            const categoriesStore = transaction.objectStore('categories');
            const wrongQuestionsStore = transaction.objectStore('wrongQuestions');

            categoriesStore.clear();
            wrongQuestionsStore.clear();

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ==================== ç»„åˆç­”é¢˜åŠŸèƒ½ ====================

        let combinedQuizSelection = {}; // å­˜å‚¨é€‰ä¸­çš„åˆ†ç±»å’Œæ¯”ä¾‹
        let combinedQuizQuestions = []; // å­˜å‚¨ç»„åˆåçš„é¢˜ç›®
        let isCombinedQuizMode = false; // æ ‡è®°æ˜¯å¦ä¸ºç»„åˆç­”é¢˜æ¨¡å¼
        let categorySelectorCount = 0; // åˆ†ç±»é€‰æ‹©å™¨è®¡æ•°
        let availableCategories = []; // å¯ç”¨çš„é¢˜åº“åˆ†ç±»åˆ—è¡¨
        let quizStartTime = null; // ç­”é¢˜å¼€å§‹æ—¶é—´
        let quizEndTime = null; // ç­”é¢˜ç»“æŸæ—¶é—´
        let currentCombinationName = null; // å½“å‰ä½¿ç”¨çš„ç»„åˆåç§°

        // æ˜¾ç¤ºç»„åˆç­”é¢˜é¡µé¢
        async function showCombinedQuizPage() {
            try {
                const categories = await getAllCategories();
                availableCategories = categories;

                if (categories.length === 0) {
                    document.getElementById('category-selection-area').innerHTML =
                        '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— é¢˜åº“ï¼Œè¯·å…ˆå¯¼å…¥é¢˜åº“</p>';
                    return;
                }

                // åŠ è½½ä¿å­˜çš„ç»„åˆé…ç½®
                await loadSavedCombinations();

                // æ£€æŸ¥æ˜¯å¦æœ‰å¾…åŠ è½½çš„é…ç½®ï¼ˆä»ç»„åˆé…ç½®é¡µé¢è·³è½¬è¿‡æ¥ï¼‰
                const pendingConfig = sessionStorage.getItem('pendingConfigLoad');
                if (pendingConfig) {
                    const configData = JSON.parse(pendingConfig);
                    sessionStorage.removeItem('pendingConfigLoad'); // æ¸…é™¤ä¸´æ—¶å­˜å‚¨

                    // ä¿å­˜ç»„åˆåç§°
                    currentCombinationName = configData.name;

                    // ç›´æ¥åº”ç”¨é…ç½®ï¼Œè€Œä¸æ˜¯é€šè¿‡selectå…ƒç´ 
                    applyConfigurationDirectly(configData);

                    // æ›´æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„é…ç½®
                    setTimeout(() => {
                        const combinedSelect = document.getElementById('saved-combinations-select');
                        if (combinedSelect) {
                            combinedSelect.value = configData.id;
                        }
                    }, 100);
                } else {
                    // å¦‚æœæ²¡æœ‰å¾…åŠ è½½çš„é…ç½®ï¼Œæ‰‹åŠ¨é‡ç½®é€‰æ‹©
                    combinedQuizSelection = {};
                    categorySelectorCount = 0;
                    currentCombinationName = null;

                    // æ¸…ç©ºé€‰æ‹©åŒºåŸŸ
                    const categoryArea = document.getElementById('category-selection-area');
                    if (categoryArea) {
                        categoryArea.innerHTML = '';
                    }

                    // æ·»åŠ ç¬¬ä¸€ä¸ªåˆ†ç±»é€‰æ‹©å™¨
                    addCategorySelector();
                }

            } catch (error) {
                console.error('Error showing combined quiz page:', error);
                document.getElementById('category-selection-area').innerHTML =
                    '<p style="text-align: center; color: #f44336; padding: 40px;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // æ·»åŠ åˆ†ç±»é€‰æ‹©å™¨
        function addCategorySelector() {
            if (availableCategories.length === 0) {
                alert('æš‚æ— å¯ç”¨é¢˜åº“');
                return;
            }

            const selectionArea = document.getElementById('category-selection-area');
            if (!selectionArea) {
                console.error('Cannot find category-selection-area element');
                return;
            }

            const selectorId = `selector-${++categorySelectorCount}`;

            const selectorDiv = document.createElement('div');
            selectorDiv.id = selectorId;
            selectorDiv.style.cssText = 'padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;';

            let html = `
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select class="category-dropdown" id="category-${selectorId}"
                            style="flex: 2; min-width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;"
                            onchange="updateCategorySelection('${selectorId}')">
                        <option value="">-- é€‰æ‹©é¢˜åº“ --</option>
            `;

            availableCategories.forEach(category => {
                html += `<option value="${category.id}" data-count="${category.count}">${category.name} (${category.count}é¢˜)</option>`;
            });

            html += `
                    </select>
                    <div style="flex: 1; min-width: 100px; display: flex; align-items: center; gap: 5px;">
                        <label style="font-size: 14px; color: #666;">é¢˜æ•°ï¼š</label>
                        <input type="number" class="question-count-input" id="count-${selectorId}"
                               min="0" max="150" value="0"
                               style="width: 70px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; text-align: center;"
                               onchange="updateQuestionDistribution()">
                        <span style="font-size: 14px; color: #666;">é¢˜</span>
                    </div>
                    <button class="btn btn-delete btn-small"
                            onclick="removeCategorySelector('${selectorId}')"
                            style="padding: 8px 15px; flex-shrink: 0;">
                        åˆ é™¤
                    </button>
                </div>
                <div id="preview-${selectorId}" style="margin-top: 10px; padding: 8px; background: white; border-radius: 6px; font-size: 14px; color: #667eea; display: none;">
                    å¯ç”¨ï¼š0é¢˜
                </div>
            `;

            selectorDiv.innerHTML = html;
            selectionArea.appendChild(selectorDiv);
        }

        // ç§»é™¤åˆ†ç±»é€‰æ‹©å™¨
        function removeCategorySelector(selectorId) {
            const selector = document.getElementById(selectorId);
            if (selector) {
                const categorySelect = document.getElementById(`category-${selectorId}`);
                if (categorySelect && categorySelect.value) {
                    delete combinedQuizSelection[categorySelect.value];
                }
                selector.remove();

                // è‡ªåŠ¨é‡æ–°åˆ†é…æ¯”ä¾‹
                autoDistributeRatios();

                updateQuestionDistribution();
            }

            // å¦‚æœæ²¡æœ‰é€‰æ‹©å™¨äº†ï¼Œè‡ªåŠ¨æ·»åŠ ä¸€ä¸ª
            if (document.querySelectorAll('.category-dropdown').length === 0) {
                addCategorySelector();
            }
        }

        // æ›´æ–°åˆ†ç±»é€‰æ‹©
        function updateCategorySelection(selectorId, skipAutoDistribute = false) {
            const categorySelect = document.getElementById(`category-${selectorId}`);
            const countInput = document.getElementById(`count-${selectorId}`);
            const previewDiv = document.getElementById(`preview-${selectorId}`);

            const categoryId = categorySelect.value;

            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            const previousValue = categorySelect.dataset.previousValue;
            if (previousValue) {
                delete combinedQuizSelection[previousValue];
            }

            if (categoryId) {
                // æ£€æŸ¥æ˜¯å¦é‡å¤é€‰æ‹©
                if (combinedQuizSelection[categoryId]) {
                    alert('è¯¥åˆ†ç±»å·²ç»è¢«é€‰æ‹©');
                    categorySelect.value = '';
                    previewDiv.style.display = 'none';
                    return;
                }

                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const count = parseInt(selectedOption.dataset.count);

                combinedQuizSelection[categoryId] = {
                    name: selectedOption.text.split(' (')[0],
                    count: count,
                    questionCount: 0,
                    selectorId: selectorId
                };

                // è®°å½•å½“å‰é€‰æ‹©
                categorySelect.dataset.previousValue = categoryId;

                // è®¾ç½®è¾“å…¥æ¡†çš„æœ€å¤§å€¼ä¸ºè¯¥åˆ†ç±»çš„å¯ç”¨é¢˜æ•°
                countInput.max = count;
                countInput.value = 0;

                // æ˜¾ç¤ºé¢„è§ˆ
                previewDiv.style.display = 'block';

                // å¦‚æœä¸æ˜¯åŠ è½½ä¿å­˜çš„é…ç½®ï¼Œæ‰è‡ªåŠ¨åˆ†é…é¢˜ç›®æ•°é‡
                if (!skipAutoDistribute) {
                    autoDistributeRatios();
                }
            } else {
                previewDiv.style.display = 'none';
            }

            updateQuestionDistribution();
        }

        // è‡ªåŠ¨åˆ†é…é¢˜ç›®æ•°é‡ï¼ˆå¹³å‡åˆ†é…ï¼‰
        function autoDistributeRatios() {
            const selectedCount = Object.keys(combinedQuizSelection).length;
            if (selectedCount === 0) return;

            const averageCount = Math.floor(150 / selectedCount);
            let remainingCount = 150 - (averageCount * selectedCount);

            let index = 0;
            for (let categoryId in combinedQuizSelection) {
                let count = averageCount;
                if (index === 0) {
                    count += remainingCount; // æŠŠä½™æ•°åŠ åˆ°ç¬¬ä¸€ä¸ªåˆ†ç±»
                }
                combinedQuizSelection[categoryId].questionCount = count;
                const selectorId = combinedQuizSelection[categoryId].selectorId;
                document.getElementById(`count-${selectorId}`).value = count;
                index++;
            }
        }

        // æ›´æ–°é¢˜ç›®åˆ†é…æ˜¾ç¤º
        function updateQuestionDistribution() {
            const targetTotal = 150;
            let totalQuestions = 0;
            let distributionHTML = '';

            // æ”¶é›†æ‰€æœ‰é¢˜ç›®æ•°é‡
            Object.keys(combinedQuizSelection).forEach(categoryId => {
                const selectorId = combinedQuizSelection[categoryId].selectorId;
                const countInput = document.getElementById(`count-${selectorId}`);
                if (countInput) {
                    let count = parseInt(countInput.value) || 0;
                    const available = combinedQuizSelection[categoryId].count;

                    // å¦‚æœè¾“å…¥è¶…è¿‡å¯ç”¨é¢˜æ•°ï¼Œè‡ªåŠ¨è°ƒæ•´
                    if (count > available) {
                        count = available;
                        countInput.value = count;
                    }

                    combinedQuizSelection[categoryId].questionCount = count;
                    totalQuestions += count;
                }
            });

            // è®¡ç®—æ¯ä¸ªåˆ†ç±»çš„ä¿¡æ¯å¹¶æ£€æŸ¥æ˜¯å¦è¶…è¿‡å¯ç”¨é¢˜æ•°
            Object.keys(combinedQuizSelection).forEach(categoryId => {
                const category = combinedQuizSelection[categoryId];
                const requested = category.questionCount || 0;
                const available = category.count;

                if (requested > 0) {
                    const previewDiv = document.getElementById(`preview-${category.selectorId}`);
                    if (previewDiv) {
                        // æ˜¾ç¤ºå¯ç”¨é¢˜æ•°
                        previewDiv.innerHTML = `å¯ç”¨ï¼š${available}é¢˜`;
                        previewDiv.style.color = '#667eea';

                        // å¦‚æœè¯·æ±‚æ•°ç­‰äºå¯ç”¨æ•°ï¼Œæ˜¾ç¤ºæç¤º
                        if (requested === available) {
                            previewDiv.innerHTML += ` <span style="color: #ff9800; font-size: 12px;">ï¼ˆå·²è¾¾ä¸Šé™ï¼‰</span>`;
                        }
                        previewDiv.style.display = 'block';
                    }

                    // æ„å»ºåˆ†é…è¯¦æƒ…HTML
                    distributionHTML += `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span>${category.name}</span>
                            <strong style="color: #667eea;">${requested}é¢˜</strong>
                        </div>
                    `;
                }
            });

            // æ›´æ–°åˆ†é…è¯¦æƒ…å’ŒæŒ‰é’®çŠ¶æ€
            const questionDistribution = document.getElementById('question-distribution');
            const totalCombinedQuestions = document.getElementById('total-combined-questions');
            const startBtn = document.getElementById('start-combined-quiz-btn');

            if (distributionHTML && questionDistribution && totalCombinedQuestions) {
                document.getElementById('distribution-details').innerHTML = distributionHTML;
                totalCombinedQuestions.textContent = totalQuestions;
                questionDistribution.style.display = 'block';

                // å¯ç”¨/ç¦ç”¨å¼€å§‹ç­”é¢˜æŒ‰é’®
                if (startBtn) {
                    if (totalQuestions === 150) {
                        startBtn.disabled = false;
                        startBtn.textContent = 'å¼€å§‹ç»„åˆç­”é¢˜';
                    } else if (totalQuestions < 150) {
                        startBtn.disabled = true;
                        startBtn.textContent = `é¢˜ç›®ä¸è¶³ (${totalQuestions}/150)`;
                    } else {
                        startBtn.disabled = true;
                        startBtn.textContent = `é¢˜ç›®è¶…å‡º (${totalQuestions}/150)`;
                    }
                }
            }

            // æ˜¾ç¤ºæ€»é¢˜æ•°ç»Ÿè®¡
            checkNewConfigName();
        }

        // é‡ç½®é€‰æ‹©
        function resetCombinedQuizSelection() {
            combinedQuizSelection = {};
            categorySelectorCount = 0;
            currentCombinationName = null; // æ¸…ç©ºç»„åˆåç§°

            // æ¸…ç©ºé€‰æ‹©åŒºåŸŸ
            const categoryArea = document.getElementById('category-selection-area');
            if (categoryArea) {
                categoryArea.innerHTML = '';
                // åªæœ‰åœ¨ç»„åˆç­”é¢˜é¡µé¢æ‰æ·»åŠ æ–°çš„é€‰æ‹©å™¨
                addCategorySelector();
            }

            // æ›´æ–°ç•Œé¢å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const distributionDiv = document.getElementById('question-distribution');
            if (distributionDiv) {
                distributionDiv.style.display = 'none';
            }

            const startBtn = document.getElementById('start-combined-quiz-btn');
            if (startBtn) {
                startBtn.disabled = true;
            }

            const saveBtn = document.getElementById('save-combination-btn');
            if (saveBtn) {
                saveBtn.disabled = true;
            }

            const nameInput = document.getElementById('combination-name-input');
            if (nameInput) {
                nameInput.value = '';
            }
        }

        // ä¿å­˜å½“å‰ç»„åˆé…ç½®
        function saveCurrentCombination() {
            const nameInput = document.getElementById('combination-name-input');
            if (!nameInput) {
                console.error('Cannot find combination-name-input element');
                return;
            }

            const name = nameInput.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥é…ç½®åç§°');
                return;
            }

            if (Object.keys(combinedQuizSelection).length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†ç±»');
                return;
            }

            // è·å–å·²ä¿å­˜çš„é…ç½®
            let savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');

            // æ£€æŸ¥åç§°æ˜¯å¦é‡å¤
            if (savedCombinations.some(c => c.name === name)) {
                if (!confirm(`é…ç½®"${name}"å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                    return;
                }
                savedCombinations = savedCombinations.filter(c => c.name !== name);
            }

            // æ·»åŠ æ–°é…ç½®
            const newCombination = {
                id: Date.now().toString(),
                name: name,
                selection: JSON.parse(JSON.stringify(combinedQuizSelection)),
                createdAt: new Date().toISOString()
            };

            savedCombinations.push(newCombination);

            // æœ€å¤šä¿å­˜20ä¸ªé…ç½®
            if (savedCombinations.length > 20) {
                savedCombinations = savedCombinations.slice(-20);
            }

            localStorage.setItem('savedCombinations', JSON.stringify(savedCombinations));

            alert(`é…ç½®"${name}"å·²ä¿å­˜`);
            nameInput.value = '';

            // åˆ·æ–°ä¿å­˜çš„é…ç½®åˆ—è¡¨
            loadSavedCombinations();
        }

        // åŠ è½½ä¿å­˜çš„ç»„åˆé…ç½®
        async function loadSavedCombinations() {
            const savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');
            const selectElement = document.getElementById('saved-combinations-select');

            selectElement.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ç»„åˆ --</option>';

            savedCombinations.forEach(combination => {
                const option = document.createElement('option');
                option.value = combination.id;
                option.textContent = combination.name;
                option.dataset.config = JSON.stringify(combination.selection);
                selectElement.appendChild(option);
            });
        }

        // ç›´æ¥åº”ç”¨é…ç½®ï¼ˆä»ç»„åˆé…ç½®é¡µé¢ä¼ é€’è¿‡æ¥çš„æƒ…å†µï¼‰
        function applyConfigurationDirectly(configData) {
            try {
                console.log('Applying configuration directly:', configData);

                // è§£æé…ç½® - config æ˜¯ JSON å­—ç¬¦ä¸²æ ¼å¼
                let config;
                if (typeof configData.config === 'string') {
                    try {
                        config = JSON.parse(configData.config);
                    } catch (parseError) {
                        console.error('Failed to parse config string:', parseError);
                        console.log('Config string:', configData.config);
                        throw new Error('é…ç½®æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } else {
                    config = configData.config;
                }

                console.log('Parsed config:', config);

                // ç›´æ¥é‡ç½®é€‰æ‹©ï¼Œä¸è°ƒç”¨ resetCombinedQuizSelection ä»¥é¿å…å…ƒç´ ä¸å­˜åœ¨çš„é—®é¢˜
                combinedQuizSelection = {};
                categorySelectorCount = 0;

                // æ¸…ç©ºé€‰æ‹©åŒºåŸŸ
                const categoryArea = document.getElementById('category-selection-area');
                if (categoryArea) {
                    categoryArea.innerHTML = '';
                }

                // æ ¹æ®é…ç½®åˆ›å»ºé€‰æ‹©å™¨
                for (let categoryId in config) {
                    console.log(`Processing category ${categoryId}:`, config[categoryId]);

                    addCategorySelector();
                    const selectorId = `selector-${categorySelectorCount}`;
                    const categorySelect = document.getElementById(`category-${selectorId}`);
                    const countInput = document.getElementById(`count-${selectorId}`);

                    if (!categorySelect || !countInput) {
                        console.error(`Failed to find selector elements for ${selectorId}`);
                        console.log('CategorySelect:', categorySelect);
                        console.log('CountInput:', countInput);
                        continue;
                    }

                    // è®¾ç½®åˆ†ç±»é€‰æ‹©
                    categorySelect.value = categoryId;

                    // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å­˜åœ¨
                    if (!categorySelect.value || categorySelect.value !== categoryId) {
                        console.error(`Category ${categoryId} not found in select options`);
                        console.log('Available options:', Array.from(categorySelect.options).map(opt => ({
                            value: opt.value,
                            text: opt.text
                        })));
                        continue;
                    }

                    // æ‰‹åŠ¨æ›´æ–° combinedQuizSelectionï¼Œé¿å…è§¦å‘è‡ªåŠ¨åˆ†é…
                    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                    const count = parseInt(selectedOption.dataset.count);

                    combinedQuizSelection[categoryId] = {
                        name: selectedOption.text.split(' (')[0],
                        count: count,
                        questionCount: config[categoryId].questionCount || 0,
                        selectorId: selectorId
                    };

                    categorySelect.dataset.previousValue = categoryId;

                    // è®¾ç½®é¢˜ç›®æ•°è¾“å…¥æ¡†
                    countInput.value = config[categoryId].questionCount || 0;

                    // æ˜¾ç¤ºé¢„è§ˆ
                    const previewDiv = document.getElementById(`preview-${selectorId}`);
                    if (previewDiv) {
                        previewDiv.style.display = 'block';
                    }
                }

                console.log('Final combinedQuizSelection:', combinedQuizSelection);

                updateQuestionDistribution();

                // å¯ç”¨åˆ é™¤æŒ‰é’®
                const deleteBtn = document.getElementById('delete-combination-btn');
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                }

                console.log('Configuration applied successfully');

            } catch (error) {
                console.error('Error applying configuration directly:', error);
                console.error('Stack trace:', error.stack);
                alert('åº”ç”¨é…ç½®å¤±è´¥ï¼š' + error.message);

                // å¦‚æœå¤±è´¥ï¼Œæ‰‹åŠ¨é‡ç½®è€Œä¸æ˜¯è°ƒç”¨ resetCombinedQuizSelection
                combinedQuizSelection = {};
                categorySelectorCount = 0;
                currentCombinationName = null;

                const categoryArea = document.getElementById('category-selection-area');
                if (categoryArea) {
                    categoryArea.innerHTML = '';
                    addCategorySelector();
                }
            }
        }

        // åŠ è½½é€‰ä¸­çš„ç»„åˆé…ç½®
        function loadSavedCombination() {
            const selectElement = document.getElementById('saved-combinations-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                document.getElementById('delete-combination-btn').disabled = true;
                currentCombinationName = null; // æ¸…ç©ºç»„åˆåç§°
                return;
            }

            document.getElementById('delete-combination-btn').disabled = false;

            // ä¿å­˜å½“å‰é€‰ä¸­çš„ç»„åˆåç§°
            currentCombinationName = selectedOption.textContent;

            const config = JSON.parse(selectedOption.dataset.config);

            // é‡ç½®å½“å‰é€‰æ‹©
            resetCombinedQuizSelection();

            // æ¸…ç©ºé€‰æ‹©åŒºåŸŸ
            document.getElementById('category-selection-area').innerHTML = '';

            // æ ¹æ®é…ç½®åˆ›å»ºé€‰æ‹©å™¨
            for (let categoryId in config) {
                addCategorySelector();
                const selectorId = `selector-${categorySelectorCount}`;
                const categorySelect = document.getElementById(`category-${selectorId}`);
                const countInput = document.getElementById(`count-${selectorId}`);

                // è®¾ç½®åˆ†ç±»é€‰æ‹©
                categorySelect.value = categoryId;

                // æ‰‹åŠ¨æ›´æ–° combinedQuizSelectionï¼Œé¿å…è§¦å‘è‡ªåŠ¨åˆ†é…
                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const count = parseInt(selectedOption.dataset.count);

                combinedQuizSelection[categoryId] = {
                    name: selectedOption.text.split(' (')[0],
                    count: count,
                    questionCount: config[categoryId].questionCount || 0,  // ä½¿ç”¨ä¿å­˜çš„é¢˜ç›®æ•°é‡
                    selectorId: selectorId
                };

                categorySelect.dataset.previousValue = categoryId;

                // è®¾ç½®é¢˜ç›®æ•°è¾“å…¥æ¡†
                countInput.value = config[categoryId].questionCount || 0;

                // æ˜¾ç¤ºé¢„è§ˆ
                const previewDiv = document.getElementById(`preview-${selectorId}`);
                if (previewDiv) {
                    previewDiv.style.display = 'block';
                }
            }

            updateQuestionDistribution();
        }

        // åˆ é™¤é€‰ä¸­çš„ç»„åˆé…ç½®
        function deleteSelectedCombination() {
            const selectElement = document.getElementById('saved-combinations-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                return;
            }

            const name = selectedOption.textContent;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${name}"å—ï¼Ÿ`)) {
                return;
            }

            let savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');
            savedCombinations = savedCombinations.filter(c => c.id !== selectedOption.value);
            localStorage.setItem('savedCombinations', JSON.stringify(savedCombinations));

            alert(`é…ç½®"${name}"å·²åˆ é™¤`);

            // åˆ·æ–°åˆ—è¡¨
            loadSavedCombinations();
            document.getElementById('delete-combination-btn').disabled = true;
        }

        // å¼€å§‹ç»„åˆç­”é¢˜
        async function startCombinedQuiz() {
            try {
                if (Object.keys(combinedQuizSelection).length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢˜åº“åˆ†ç±»');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('loading').style.display = 'block';

                // æ”¶é›†æ‰€æœ‰é¢˜ç›®
                combinedQuizQuestions = [];
                let totalCollected = 0;
                let combinedSelectionInfo = {
                    categories: [],
                    totalUnanswered: 0,
                    totalAnswered: 0,
                    selectedUnanswered: 0,
                    selectedAnswered: 0
                };

                for (let categoryId in combinedQuizSelection) {
                    const category = await getCategoryById(parseInt(categoryId));
                    const selection = combinedQuizSelection[categoryId];

                    // ä½¿ç”¨ç›´æ¥è¾“å…¥çš„é¢˜ç›®æ•°é‡
                    const requestedCount = selection.questionCount || 0;
                    const actualCount = Math.min(requestedCount, selection.count);

                    if (actualCount > 0) {
                        // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ™ºèƒ½é€‰é¢˜
                        const smartSelectEnabled = document.getElementById('smart-select-enabled').checked;

                        let selected;
                        if (smartSelectEnabled) {
                            // ä½¿ç”¨æ™ºèƒ½é€‰é¢˜ï¼šä¼˜å…ˆé€‰æ‹©æœªç­”è¿‡çš„é¢˜ç›®
                            selected = await smartSelectQuestions(
                                parseInt(categoryId),
                                category.questions,
                                actualCount
                            );

                            // æ”¶é›†é€‰é¢˜ä¿¡æ¯
                            if (selected._selectionInfo) {
                                combinedSelectionInfo.categories.push({
                                    name: category.name,
                                    ...selected._selectionInfo
                                });
                                combinedSelectionInfo.totalUnanswered += selected._selectionInfo.unansweredTotal;
                                combinedSelectionInfo.totalAnswered += selected._selectionInfo.answeredTotal;
                                combinedSelectionInfo.selectedUnanswered += selected._selectionInfo.unanswered;
                                combinedSelectionInfo.selectedAnswered += selected._selectionInfo.answered;
                            }
                        } else {
                            // ä½¿ç”¨éšæœºé€‰é¢˜
                            const shuffled = [...category.questions].sort(() => Math.random() - 0.5);
                            selected = shuffled.slice(0, Math.min(actualCount, shuffled.length));
                            console.log(`åˆ†ç±»${categoryId}: éšæœºé€‰æ‹©äº†${selected.length}é¢˜`);
                        }

                        // æ·»åŠ åˆ†ç±»ä¿¡æ¯åˆ°æ¯é“é¢˜
                        selected.forEach(question => {
                            const questionWithCategory = {
                                ...question,
                                _categoryId: category.id,
                                _categoryName: category.name
                            };
                            combinedQuizQuestions.push(questionWithCategory);
                        });

                        totalCollected += selected.length;
                    }
                }

                // æ‰“ä¹±æ‰€æœ‰é¢˜ç›®
                combinedQuizQuestions.sort(() => Math.random() - 0.5);

                // ç¡®ä¿æ­£å¥½æ˜¯150é¢˜
                if (combinedQuizQuestions.length > 150) {
                    combinedQuizQuestions = combinedQuizQuestions.slice(0, 150);
                }

                console.log(`ç»„åˆç­”é¢˜ï¼šæ€»å…±${combinedQuizQuestions.length}é¢˜`);

                // è®¾ç½®ä¸ºç»„åˆç­”é¢˜æ¨¡å¼
                isCombinedQuizMode = true;
                questions = combinedQuizQuestions;
                userAnswers = new Array(questions.length).fill(null);
                wrongQuestionIds = [];
                permanentMappings = {}; // é‡ç½®æ°¸ä¹…æ˜ å°„ï¼Œå¼€å§‹æ–°çš„ç­”é¢˜ä¼šè¯

                // è®¾ç½®å½“å‰åˆ†ç±»ä¿¡æ¯
                currentCategory = {
                    id: 'combined',
                    name: 'ç»„åˆç­”é¢˜',
                    isCombinedMode: true,
                    combinedInfo: { ...combinedQuizSelection }
                };

                // åˆå§‹åŒ–é€‰é¡¹æ˜ å°„
                initializeQuestionMappings();

                // éšè—æ‰€æœ‰é¡µé¢
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // æ˜¾ç¤ºç­”é¢˜ç•Œé¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('question-container').style.display = 'block';
                document.getElementById('quiz-navigation').style.display = 'block';
                document.getElementById('total-questions').textContent = questions.length;
                document.getElementById('reimport-btn').style.display = 'block';

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.querySelector('.header h1').textContent = 'ä¸­è¯ç­”é¢˜ç³»ç»Ÿ - ç»„åˆç­”é¢˜æ¨¡å¼';

                // ä¿å­˜ç»„åˆç­”é¢˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('lastCombinedQuizConfig', JSON.stringify({
                    selection: combinedQuizSelection,
                    date: new Date().toISOString()
                }));

                // è®°å½•å¼€å§‹æ—¶é—´
                quizStartTime = Date.now();
                console.log('ç»„åˆç­”é¢˜å¼€å§‹æ—¶é—´:', new Date(quizStartTime).toLocaleString('zh-CN'));

                // æ˜¾ç¤ºç»„åˆç­”é¢˜é€‰é¢˜ä¿¡æ¯
                const smartSelectEnabled = document.getElementById('smart-select-enabled').checked;
                if (smartSelectEnabled && combinedSelectionInfo.categories.length > 0) {
                    showCombinedSelectionInfo(combinedSelectionInfo);
                }

                // å¼€å§‹ç¬¬ä¸€é¢˜
                displayQuestion(0);

            } catch (error) {
                console.error('Error starting combined quiz:', error);
                document.getElementById('loading').style.display = 'none';
                alert('å¼€å§‹ç»„åˆç­”é¢˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½ç»„åˆç­”é¢˜å†å²è®°å½•
        async function loadCombinedQuizHistory() {
            try {
                const historySelect = document.getElementById('quiz-history-select');
                const statsDiv = document.getElementById('quiz-history-stats');
                const records = await getAllQuizRecords();

                // ç­›é€‰ç»„åˆç­”é¢˜è®°å½•
                const combinedRecords = records.filter(record =>
                    record.categoryId === 'combined' ||
                    (record.categoryName && record.categoryName.includes('ç»„åˆ'))
                );

                // é‡ç½®ä¸‹æ‹‰æ¡†
                historySelect.innerHTML = '<option value="">-- é€‰æ‹©å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ… --</option>';
                document.getElementById('selected-history-details').style.display = 'none';
                document.getElementById('delete-history-btn').disabled = true;

                if (combinedRecords.length === 0) {
                    statsDiv.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— ç»„åˆç­”é¢˜è®°å½•</p>';
                    return;
                }

                // æŒ‰æ—¥æœŸæ’åº
                combinedRecords.sort((a, b) => new Date(b.quizDate) - new Date(a.quizDate));

                // æ·»åŠ é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†ï¼ˆæœ€å¤šæ˜¾ç¤º50æ¡ï¼‰
                const displayRecords = combinedRecords.slice(0, 50);
                displayRecords.forEach(record => {
                    const date = new Date(record.quizDate);
                    const dateStr = date.toLocaleDateString('zh-CN');
                    const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

                    const option = document.createElement('option');
                    option.value = record.id;
                    option.dataset.record = JSON.stringify(record);

                    // ä¼˜å…ˆæ˜¾ç¤ºç»„åˆåç§°ï¼Œå¦åˆ™æ˜¾ç¤ºåˆ†ç±»ä¿¡æ¯
                    const displayName = record.combinationName || record.combinedCategories || 'ç»„åˆç­”é¢˜';
                    option.textContent = `${dateStr} ${timeStr} - ${displayName} - ${record.score}åˆ† (${record.correctAnswers}/${record.totalQuestions}é¢˜)`;

                    historySelect.appendChild(option);
                });

                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                const totalQuizzes = combinedRecords.length;
                const avgScore = Math.round(
                    combinedRecords.reduce((sum, r) => sum + r.score, 0) / totalQuizzes * 10
                ) / 10;
                const bestScore = Math.max(...combinedRecords.map(r => r.score));
                const worstScore = Math.min(...combinedRecords.map(r => r.score));

                // æœ€è¿‘7å¤©çš„è®°å½•
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const recentCount = combinedRecords.filter(r => new Date(r.quizDate) >= sevenDaysAgo).length;

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${totalQuizzes}</div>
                            <div style="font-size: 12px; color: #666;">æ€»ç­”é¢˜æ¬¡æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${avgScore}%</div>
                            <div style="font-size: 12px; color: #666;">å¹³å‡åˆ†</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${bestScore}%</div>
                            <div style="font-size: 12px; color: #666;">æœ€é«˜åˆ†</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f44336;">${worstScore}%</div>
                            <div style="font-size: 12px; color: #666;">æœ€ä½åˆ†</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #2196f3;">${recentCount}</div>
                            <div style="font-size: 12px; color: #666;">è¿‘7å¤©</div>
                        </div>
                    </div>
                `;

                // ä¿å­˜è®°å½•åˆ°å…¨å±€å˜é‡ä¾›åˆ é™¤ä½¿ç”¨
                window.combinedQuizRecords = combinedRecords;

            } catch (error) {
                console.error('Error loading combined quiz history:', error);
                document.getElementById('quiz-history-stats').innerHTML =
                    '<p style="text-align: center; color: #f44336;">åŠ è½½å†å²è®°å½•å¤±è´¥</p>';
            }
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„ç­”é¢˜è®°å½•è¯¦æƒ…
        function showSelectedQuizHistory() {
            const historySelect = document.getElementById('quiz-history-select');
            const selectedOption = historySelect.options[historySelect.selectedIndex];
            const detailsDiv = document.getElementById('selected-history-details');
            const deleteBtn = document.getElementById('delete-history-btn');

            if (!selectedOption || !selectedOption.value) {
                detailsDiv.style.display = 'none';
                deleteBtn.disabled = true;
                return;
            }

            deleteBtn.disabled = false;
            const record = JSON.parse(selectedOption.dataset.record);

            // è®¡ç®—æ—¶é•¿æ˜¾ç¤º
            let timeDisplay = 'æœªè®°å½•';
            if (record.timeSpent) {
                const minutes = Math.floor(record.timeSpent / 60);
                const seconds = record.timeSpent % 60;
                timeDisplay = `${minutes}åˆ†${seconds}ç§’`;
            }

            // åˆ¤æ–­æˆç»©ç­‰çº§
            let gradeIcon = 'ğŸ˜Š';
            let gradeText = 'åŠæ ¼';
            let gradeColor = '#4caf50';

            if (record.score >= 90) {
                gradeIcon = 'ğŸ†';
                gradeText = 'ä¼˜ç§€';
                gradeColor = '#4caf50';
            } else if (record.score >= 80) {
                gradeIcon = 'ğŸ˜„';
                gradeText = 'è‰¯å¥½';
                gradeColor = '#8bc34a';
            } else if (record.score >= 60) {
                gradeIcon = 'ğŸ˜Š';
                gradeText = 'åŠæ ¼';
                gradeColor = '#ff9800';
            } else {
                gradeIcon = 'ğŸ˜”';
                gradeText = 'ä¸åŠæ ¼';
                gradeColor = '#f44336';
            }

            // æ˜¾ç¤ºè¯¦æƒ…
            detailsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                    <div>
                        <strong style="color: #666;">ç­”é¢˜æ—¶é—´ï¼š</strong>
                    </div>
                    <div>${new Date(record.quizDate).toLocaleString('zh-CN')}</div>

                    <div>
                        <strong style="color: #666;">å¾—åˆ†ï¼š</strong>
                    </div>
                    <div style="font-size: 20px; font-weight: bold; color: ${gradeColor};">
                        ${gradeIcon} ${record.score}åˆ† (${gradeText})
                    </div>

                    <div>
                        <strong style="color: #666;">ç­”é¢˜æƒ…å†µï¼š</strong>
                    </div>
                    <div>
                        ç­”å¯¹ <span style="color: #4caf50; font-weight: bold;">${record.correctAnswers}</span> é¢˜ï¼Œ
                        ç­”é”™ <span style="color: #f44336; font-weight: bold;">${record.totalQuestions - record.correctAnswers}</span> é¢˜ï¼Œ
                        å…± ${record.totalQuestions} é¢˜
                    </div>

                    <div>
                        <strong style="color: #666;">æ­£ç¡®ç‡ï¼š</strong>
                    </div>
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                                <div style="width: ${record.score}%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.5s ease;"></div>
                            </div>
                            <span style="font-weight: bold; color: ${gradeColor};">${record.score}%</span>
                        </div>
                    </div>

                    ${record.combinationName ? `
                    <div>
                        <strong style="color: #666;">ç»„åˆåç§°ï¼š</strong>
                    </div>
                    <div style="font-weight: bold; color: #667eea;">${record.combinationName}</div>
                    ` : ''}

                    ${record.combinedCategories ? `
                    <div>
                        <strong style="color: #666;">åŒ…å«åˆ†ç±»ï¼š</strong>
                    </div>
                    <div>${record.combinedCategories}</div>
                    ` : ''}

                    <div>
                        <strong style="color: #666;">ç”¨æ—¶ï¼š</strong>
                    </div>
                    <div>${timeDisplay}</div>
                </div>
            `;

            detailsDiv.style.display = 'block';
        }

        // åˆ é™¤é€‰ä¸­çš„ç­”é¢˜è®°å½•
        async function deleteSelectedQuizHistory() {
            const historySelect = document.getElementById('quiz-history-select');
            const selectedOption = historySelect.options[historySelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                return;
            }

            const record = JSON.parse(selectedOption.dataset.record);
            const dateStr = new Date(record.quizDate).toLocaleString('zh-CN');

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${dateStr} çš„ç­”é¢˜è®°å½•å—ï¼Ÿ\nå¾—åˆ†ï¼š${record.score}åˆ†`)) {
                return;
            }

            try {
                // åˆ é™¤è®°å½•
                await deleteQuizRecord(parseInt(selectedOption.value));

                alert('ç­”é¢˜è®°å½•å·²åˆ é™¤');

                // é‡æ–°åŠ è½½å†å²è®°å½•
                await loadCombinedQuizHistory();

            } catch (error) {
                console.error('Error deleting quiz record:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤ç­”é¢˜è®°å½•
        async function deleteQuizRecord(recordId) {
            const transaction = db.transaction(['quizRecords'], 'readwrite');
            const store = transaction.objectStore('quizRecords');

            await store.delete(recordId);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ä¿å­˜ç»„åˆç­”é¢˜è®°å½•ï¼ˆè¦†ç›–åŸæœ‰çš„ä¿å­˜å‡½æ•°ï¼Œæ·»åŠ ç»„åˆç­”é¢˜å¤„ç†ï¼‰
        async function saveQuizRecordToDBWithCombined(categoryId, categoryName, totalQuestions, correctAnswers, score, timeSpent) {
            const transaction = db.transaction(['quizRecords'], 'readwrite');
            const store = transaction.objectStore('quizRecords');

            // æ„å»ºè¯¦ç»†ç­”é¢˜ä¿¡æ¯
            const userAnswersDetail = userAnswers.map((answer, index) => {
                const mapping = optionMappings[index];
                let shuffledAnswer = null;
                let originalAnswer = null;
                let shuffledOptions = questions[index]?.options || [];
                let originalOptions = questions[index]?.options || [];

                // å¦‚æœæœ‰æ˜ å°„ä¿¡æ¯ï¼Œè·å–æ‰“ä¹±åçš„é€‰é¡¹å’ŒåŸå§‹é€‰é¡¹
                if (mapping) {
                    // è·å–æ‰“ä¹±åçš„é€‰é¡¹
                    if (mapping.newOptions) {
                        shuffledOptions = mapping.newOptions;
                    }

                    // è·å–åŸå§‹é€‰é¡¹ï¼ˆé¢˜åº“ä¸­çš„å›ºå®šé€‰é¡¹ï¼‰
                    if (mapping.originalOptions) {
                        originalOptions = mapping.originalOptions;
                    }

                    // è·å–åŸå§‹ç­”æ¡ˆ
                    if (mapping.originalAnswer) {
                        originalAnswer = mapping.originalAnswer;
                    }
                }

                // è·å–æ‰“ä¹±åçš„æ­£ç¡®ç­”æ¡ˆ
                if (mapping && questions[index]?.answer) {
                    if (mapping.type === 'å•é€‰é¢˜' || mapping.type === 'å…¶ä»–é¢˜å‹') {
                        for (const [newKey, originalKey] of Object.entries(mapping.mapping || {})) {
                            if (originalKey === questions[index].answer) {
                                shuffledAnswer = newKey;
                                break;
                            }
                        }
                    } else if (mapping.type === 'é…ä¼é€‰æ‹©é¢˜' && questions[index]?.sub_questions) {
                        shuffledAnswer = questions[index].sub_questions.map((subQ, subIdx) => {
                            const originalAns = subQ.answer;
                            for (const [newKey, originalKey] of Object.entries(mapping.mapping || {})) {
                                if (originalKey === originalAns) {
                                    return newKey;
                                }
                            }
                            return originalAns;
                        });
                    }
                }

                return {
                    questionIndex: index,
                    userAnswer: answer,
                    // æ‰“ä¹±åçš„ç­”æ¡ˆï¼ˆç”¨äºæ¯”å¯¹ï¼Œå†³å®šå¯¹é”™ï¼‰
                    shuffledAnswer: shuffledAnswer || questions[index]?.answer,
                    // åŸå§‹ç­”æ¡ˆï¼ˆé¢˜åº“ä¸­çš„å›ºå®šç­”æ¡ˆï¼‰
                    originalAnswer: originalAnswer || questions[index]?.answer,
                    question: {
                        id: questions[index]?.id,
                        text: questions[index]?.question,
                        type: questions[index]?.type,
                        // ä¿å­˜æ‰“ä¹±åçš„é€‰é¡¹ï¼ˆç­”é¢˜æ—¶çš„é€‰é¡¹é¡ºåºï¼‰
                        shuffledOptions: typeof shuffledOptions === 'object' ? Object.values(shuffledOptions) : shuffledOptions,
                        // ä¿å­˜åŸå§‹é€‰é¡¹ï¼ˆé¢˜åº“ä¸­çš„æ ‡å‡†é€‰é¡¹é¡ºåºï¼‰
                        originalOptions: typeof originalOptions === 'object' ? Object.values(originalOptions) : originalOptions,
                        // ä¿å­˜ä¸¤ä¸ªç­”æ¡ˆç‰ˆæœ¬ï¼Œæ¸…æ¥šåœ°æ ‡è¯†å„è‡ªçš„å«ä¹‰
                        answer: shuffledAnswer || questions[index]?.answer,
                        sub_questions: questions[index]?.sub_questions,
                        categoryName: questions[index]?._categoryName || categoryName
                    }
                };
            });

            const quizRecord = {
                categoryId,
                categoryName,
                totalQuestions,
                correctAnswers,
                score,
                timeSpent,
                quizDate: new Date().toISOString(),
                // ä¿å­˜è¯¦ç»†ç­”é¢˜ä¿¡æ¯
                userAnswers: userAnswersDetail
            };

            // å¦‚æœæ˜¯ç»„åˆç­”é¢˜ï¼Œæ·»åŠ é¢å¤–ä¿¡æ¯
            if (categoryId === 'combined' && currentCategory && currentCategory.combinedInfo) {
                // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„ç»„åˆåç§°
                if (currentCombinationName) {
                    quizRecord.combinationName = currentCombinationName;
                }

                const categoryNames = [];
                // ä»é—®é¢˜ä¸­æå–åˆ†ç±»åç§°ï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
                const uniqueCategories = new Set();
                questions.forEach(q => {
                    if (q._categoryName) {
                        uniqueCategories.add(q._categoryName);
                    }
                });

                // å¦‚æœä»questionsä¸­è·å–ä¸åˆ°ï¼Œå°è¯•ä»combinedInfoè·å–
                if (uniqueCategories.size === 0) {
                    for (let catId in currentCategory.combinedInfo) {
                        const cat = availableCategories.find(c => c.id === parseInt(catId));
                        if (cat) {
                            uniqueCategories.add(cat.name);
                        }
                    }
                }

                quizRecord.combinedCategories = Array.from(uniqueCategories).join('ã€');
            }

            await store.add(quizRecord);

            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // ä¿®æ”¹è¿”å›æŒ‰é’®è¡Œä¸ºï¼ˆæ·»åŠ ç»„åˆç­”é¢˜æ¨¡å¼å¤„ç†ï¼‰
        function backToCategoryListWithCombined() {
            // éšè—ç­”é¢˜ç•Œé¢å’Œå¯¼èˆªæŒ‰é’®
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('quiz-navigation').style.display = 'none';
            document.getElementById('result-summary').classList.remove('show');
            document.getElementById('reimport-btn').style.display = 'none';

            // éšè—ç­”é¢˜è¿›åº¦æ¡
            const quizHeader = document.getElementById('quiz-header');
            if (quizHeader) {
                quizHeader.style.display = 'none';
            }

            // é‡ç½®é¡µé¢æ ‡é¢˜
            document.querySelector('.header h1').textContent = 'ä¸­è¯ç­”é¢˜ç³»ç»Ÿ';

            // æ£€æŸ¥ç­”é¢˜æ¨¡å¼
            if (currentCategory && currentCategory.isCombinedMode) {
                // è¿”å›ç»„åˆç­”é¢˜é¡µé¢
                navigateTo('combined-quiz');
                // é‡ç½®ç»„åˆç­”é¢˜æ¨¡å¼æ ‡è®°
                isCombinedQuizMode = false;
                if (currentCategory) {
                    currentCategory.isCombinedMode = false;
                }
            } else if (currentCategory && currentCategory.isWrongQuestionMode) {
                // è¿”å›é”™é¢˜åˆ—è¡¨é¡µé¢
                navigateTo('wrong-questions');
                // é‡ç½®é”™é¢˜æ¨¡å¼æ ‡è®°
                if (currentCategory) {
                    currentCategory.isWrongQuestionMode = false;
                }
            } else {
                // è¿”å›é¢˜åº“åˆ—è¡¨é¡µé¢
                navigateTo('home');
            }
        }

        // æ›¿æ¢åŸæœ‰çš„backToCategoryListå‡½æ•°
        window.backToCategoryList = backToCategoryListWithCombined;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            try {
                await initDB();

                // æ¢å¤æ™ºèƒ½é€‰é¢˜è®¾ç½®
                const smartSelectSetting = localStorage.getItem('smartSelectEnabled');
                if (smartSelectSetting !== null) {
                    const checkbox = document.getElementById('smart-select-enabled');
                    if (checkbox) {
                        checkbox.checked = smartSelectSetting === 'true';
                    }
                }

                // ä¿å­˜æ™ºèƒ½é€‰é¢˜è®¾ç½®
                setTimeout(() => {
                    const smartSelectCheckbox = document.getElementById('smart-select-enabled');
                    if (smartSelectCheckbox) {
                        smartSelectCheckbox.addEventListener('change', (e) => {
                            localStorage.setItem('smartSelectEnabled', e.target.checked);
                            console.log('æ™ºèƒ½é€‰é¢˜è®¾ç½®å·²ä¿å­˜ï¼š', e.target.checked);
                        });
                    }
                }, 100);

                // æ˜¾ç¤ºé¦–é¡µå¹¶åŠ è½½åˆ†ç±»åˆ—è¡¨
                navigateTo('home');

            } catch (error) {
                console.error('Error initializing app:', error);
                console.error('Stack trace:', error.stack);
                navigateTo('import');
            }
        };

        // ==================== ç»„åˆé…ç½®é¡µé¢åŠŸèƒ½ ====================

        let configCategorySelection = {}; // å­˜å‚¨é…ç½®é¡µé¢çš„åˆ†ç±»é€‰æ‹©
        let configCategorySelectorCount = 0; // é…ç½®é¡µé¢çš„é€‰æ‹©å™¨è®¡æ•°

        // æ˜¾ç¤ºç»„åˆé…ç½®é¡µé¢
        async function showCombinationConfigPage() {
            try {
                const categories = await getAllCategories();
                availableCategories = categories;

                if (categories.length === 0) {
                    document.getElementById('config-category-selection').innerHTML =
                        '<p style="text-align: center; color: #999;">æš‚æ— é¢˜åº“ï¼Œè¯·å…ˆå¯¼å…¥é¢˜åº“</p>';
                    return;
                }

                // åŠ è½½å·²ä¿å­˜çš„é…ç½®
                await loadConfigList();

                // åŠ è½½å†å²è®°å½•
                await loadCombinedQuizHistory();

                // é‡ç½®é…ç½®é€‰æ‹©
                configCategorySelection = {};
                configCategorySelectorCount = 0;
                document.getElementById('config-category-selection').innerHTML = '';

                // æ·»åŠ ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨
                addConfigCategorySelector();

            } catch (error) {
                console.error('Error showing combination config page:', error);
            }
        }

        // åŠ è½½é…ç½®åˆ—è¡¨
        async function loadConfigList() {
            const savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');
            const selectElement = document.getElementById('config-list-select');

            selectElement.innerHTML = '<option value="">-- é€‰æ‹©é…ç½®æŸ¥çœ‹è¯¦æƒ… --</option>';

            savedCombinations.forEach(combination => {
                const option = document.createElement('option');
                option.value = combination.id;
                option.textContent = combination.name;
                option.dataset.config = JSON.stringify(combination.selection);
                selectElement.appendChild(option);
            });
        }

        // æ˜¾ç¤ºé…ç½®è¯¦æƒ…
        async function showConfigDetails() {
            const selectElement = document.getElementById('config-list-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const detailsDiv = document.getElementById('config-details');
            const loadBtn = document.getElementById('load-config-btn');
            const deleteBtn = document.getElementById('delete-config-btn');

            if (!selectedOption || !selectedOption.value) {
                detailsDiv.style.display = 'none';
                loadBtn.disabled = true;
                deleteBtn.disabled = true;
                return;
            }

            loadBtn.disabled = false;
            deleteBtn.disabled = false;

            const config = JSON.parse(selectedOption.dataset.config);
            const categories = await getAllCategories();

            let detailsHTML = '<div style="display: grid; gap: 10px;">';
            let totalQuestionCount = 0;

            for (let categoryId in config) {
                const cat = categories.find(c => c.id === parseInt(categoryId));
                if (cat) {
                    // æ£€æŸ¥æ˜¯æ–°æ ¼å¼(questionCount)è¿˜æ˜¯æ—§æ ¼å¼(ratio)
                    const questionCount = config[categoryId].questionCount || config[categoryId].ratio || 0;
                    const isNewFormat = 'questionCount' in config[categoryId];

                    if (isNewFormat) {
                        // æ–°æ ¼å¼ï¼šç›´æ¥æ˜¾ç¤ºé¢˜ç›®æ•°é‡
                        totalQuestionCount += questionCount;
                        detailsHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                                <span><strong>${cat.name}</strong></span>
                                <span>${questionCount}é¢˜</span>
                            </div>
                        `;
                    } else {
                        // æ—§æ ¼å¼ï¼šæ˜¾ç¤ºç™¾åˆ†æ¯”å’Œä¼°è®¡é¢˜æ•°
                        const ratio = config[categoryId].ratio || 0;
                        const estimatedCount = Math.round(150 * ratio / 100);
                        totalQuestionCount += estimatedCount;
                        detailsHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                                <span><strong>${cat.name}</strong></span>
                                <span>${ratio}% (çº¦${estimatedCount}é¢˜)</span>
                            </div>
                        `;
                    }
                }
            }

            detailsHTML += `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <strong>æ€»é¢˜æ•°ï¼š${totalQuestionCount}é¢˜</strong>
                </div>
            </div>`;

            detailsDiv.innerHTML = detailsHTML;
            detailsDiv.style.display = 'block';
        }

        // åº”ç”¨é…ç½®åˆ°ç­”é¢˜
        function loadConfigToQuiz() {
            const selectElement = document.getElementById('config-list-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                return;
            }

            // ä¿å­˜é€‰ä¸­çš„é…ç½®ä¿¡æ¯åˆ° sessionStorageï¼Œä»¥ä¾¿é¡µé¢åˆ‡æ¢åä½¿ç”¨
            const configToLoad = {
                id: selectedOption.value,
                name: selectedOption.textContent,
                config: selectedOption.dataset.config
            };
            sessionStorage.setItem('pendingConfigLoad', JSON.stringify(configToLoad));

            // ä¿å­˜é€‰ä¸­çš„é…ç½®åç§°
            currentCombinationName = selectedOption.textContent;

            // è·³è½¬åˆ°ç»„åˆç­”é¢˜é¡µé¢
            navigateTo('combined-quiz');
        }

        // åˆ é™¤é€‰ä¸­çš„é…ç½®
        function deleteSelectedConfig() {
            const selectElement = document.getElementById('config-list-select');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                return;
            }

            const name = selectedOption.textContent;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${name}"å—ï¼Ÿ`)) {
                return;
            }

            let savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');
            savedCombinations = savedCombinations.filter(c => c.id !== selectedOption.value);
            localStorage.setItem('savedCombinations', JSON.stringify(savedCombinations));

            alert(`é…ç½®"${name}"å·²åˆ é™¤`);

            // é‡æ–°åŠ è½½åˆ—è¡¨
            loadConfigList();
            document.getElementById('config-details').style.display = 'none';
            document.getElementById('load-config-btn').disabled = true;
            document.getElementById('delete-config-btn').disabled = true;
        }

        // æ·»åŠ é…ç½®åˆ†ç±»é€‰æ‹©å™¨
        function addConfigCategorySelector() {
            const selectorId = `config-selector-${Date.now()}-${configCategorySelectorCount++}`;
            const selectorHTML = `
                <div id="${selectorId}" class="config-category-selector" style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                    <select onchange="onConfigCategorySelect(this, '${selectorId}')" style="flex: 2; min-width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                        <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                        ${availableCategories.map(cat => `
                            <option value="${cat.id}">${cat.name} (${cat.questions.length}é¢˜)</option>
                        `).join('')}
                    </select>
                    <input type="number" placeholder="é¢˜æ•°" min="0" max="150"
                           style="flex: 1; min-width: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;"
                           onchange="onConfigQuestionCountChange('${selectorId}')">
                    <button class="btn btn-delete btn-small" onclick="removeConfigSelector('${selectorId}')">åˆ é™¤</button>
                </div>
            `;

            document.getElementById('config-category-selection').insertAdjacentHTML('beforeend', selectorHTML);
        }

        // æ‰‹åŠ¨ä¿®æ”¹é¢˜ç›®æ•°é‡
        function onConfigQuestionCountChange(selectorId) {
            const questionCountInput = document.querySelector(`#${selectorId} input[type="number"]`);
            const selectElement = document.querySelector(`#${selectorId} select`);

            if (selectElement.value && configCategorySelection[selectorId]) {
                configCategorySelection[selectorId].questionCount = parseInt(questionCountInput.value) || 0;
            }

            updateConfigDistribution();
            checkNewConfigName();
        }

        // é…ç½®é¡µé¢çš„åˆ†ç±»é€‰æ‹©å¤„ç†
        function onConfigCategorySelect(selectElement, selectorId) {
            const categoryId = selectElement.value;
            const questionCountInput = document.querySelector(`#${selectorId} input[type="number"]`);

            if (!categoryId) {
                delete configCategorySelection[selectorId];
                questionCountInput.value = '';
            } else {
                configCategorySelection[selectorId] = {
                    categoryId: parseInt(categoryId),
                    questionCount: parseInt(questionCountInput.value) || 0
                };

                // è‡ªåŠ¨åˆ†é…é¢˜ç›®æ•°é‡
                autoDistributeConfigQuestionCounts();
            }

            updateConfigDistribution();
            checkNewConfigName();
        }

        // è‡ªåŠ¨åˆ†é…é…ç½®é¢˜ç›®æ•°é‡
        function autoDistributeConfigQuestionCounts() {
            const selectedCount = Object.keys(configCategorySelection).filter(
                key => configCategorySelection[key].categoryId
            ).length;

            if (selectedCount === 0) return;

            const averageCount = Math.floor(150 / selectedCount);
            let remainingCount = 150 - (averageCount * selectedCount);

            let index = 0;
            Object.keys(configCategorySelection).forEach(selectorId => {
                if (configCategorySelection[selectorId].categoryId) {
                    let count = averageCount;
                    if (index === 0) {
                        count += remainingCount; // æŠŠä½™æ•°åŠ åˆ°ç¬¬ä¸€ä¸ªåˆ†ç±»
                    }
                    configCategorySelection[selectorId].questionCount = count;

                    // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
                    const questionCountInput = document.querySelector(`#${selectorId} input[type="number"]`);
                    if (questionCountInput) {
                        questionCountInput.value = count;
                    }
                    index++;
                }
            });
        }

        // ç§»é™¤é…ç½®é€‰æ‹©å™¨
        function removeConfigSelector(selectorId) {
            document.getElementById(selectorId).remove();
            delete configCategorySelection[selectorId];

            // é‡æ–°è‡ªåŠ¨åˆ†é…é¢˜ç›®æ•°é‡
            autoDistributeConfigQuestionCounts();

            updateConfigDistribution();
            checkNewConfigName();
        }

        // æ›´æ–°é…ç½®åˆ†é…é¢„è§ˆ
        function updateConfigDistribution() {
            const previewDiv = document.getElementById('config-distribution-preview');
            const contentDiv = document.getElementById('config-distribution-content');

            // æ”¶é›†æ‰€æœ‰é€‰æ‹©çš„åˆ†ç±»å’Œé¢˜ç›®æ•°é‡
            let totalQuestionCount = 0;
            let distributionHTML = '';

            Object.values(configCategorySelection).forEach(selection => {
                if (selection.categoryId && selection.questionCount > 0) {
                    const cat = availableCategories.find(c => c.id === selection.categoryId);
                    if (cat) {
                        const questionCount = selection.questionCount;
                        totalQuestionCount += questionCount;
                        distributionHTML += `
                            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                <span>${cat.name}</span>
                                <span>${questionCount}é¢˜</span>
                            </div>
                        `;
                    }
                }
            });

            if (distributionHTML) {
                distributionHTML += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                        <strong>æ€»é¢˜æ•°ï¼š${totalQuestionCount}é¢˜</strong>
                        ${totalQuestionCount !== 150 ? '<span style="color: #f44336; margin-left: 10px;">éœ€è¦è°ƒæ•´ä¸º150é¢˜</span>' : ''}
                    </div>
                `;
                contentDiv.innerHTML = distributionHTML;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }

            // æ›´æ–°æ¯ä¸ªé€‰æ‹©å™¨çš„é¢˜ç›®æ•°è¾“å…¥
            document.querySelectorAll('.config-category-selector').forEach(selector => {
                const selectorId = selector.id;
                const questionCountInput = selector.querySelector('input[type="number"]');
                if (configCategorySelection[selectorId]) {
                    configCategorySelection[selectorId].questionCount = parseInt(questionCountInput.value) || 0;
                }
            });
        }

        // æ£€æŸ¥é…ç½®åç§°
        function checkNewConfigName() {
            const nameInput = document.getElementById('new-config-name');
            const saveBtn = document.getElementById('save-new-config-btn');

            const hasName = nameInput && nameInput.value.trim();
            const hasSelection = Object.values(configCategorySelection).some(s => s.categoryId && s.questionCount > 0);

            // è®¡ç®—æ€»é¢˜æ•°
            const totalQuestions = Object.values(configCategorySelection).reduce((sum, s) => sum + (s.questionCount || 0), 0);

            if (saveBtn) {
                saveBtn.disabled = !hasName || !hasSelection || totalQuestions !== 150;
            }
        }

        // ä¿å­˜æ–°é…ç½®
        function saveNewConfig() {
            const nameInput = document.getElementById('new-config-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥é…ç½®åç§°');
                return;
            }

            // æ„å»ºé…ç½®å¯¹è±¡
            const config = {};
            Object.values(configCategorySelection).forEach(selection => {
                if (selection.categoryId && selection.questionCount > 0) {
                    config[selection.categoryId] = { questionCount: selection.questionCount };
                }
            });

            // éªŒè¯æ€»é¢˜æ•°
            const totalQuestions = Object.values(config).reduce((sum, c) => sum + c.questionCount, 0);
            if (totalQuestions !== 150) {
                alert(`æ€»é¢˜æ•°å¿…é¡»ç­‰äº150é¢˜ï¼Œå½“å‰ä¸º${totalQuestions}é¢˜`);
                return;
            }

            // ä¿å­˜åˆ°localStorage
            let savedCombinations = JSON.parse(localStorage.getItem('savedCombinations') || '[]');

            // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
            if (savedCombinations.some(c => c.name === name)) {
                alert('è¯¥é…ç½®åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            const newCombination = {
                id: Date.now().toString(),
                name: name,
                selection: config,
                createdAt: new Date().toISOString()
            };

            savedCombinations.push(newCombination);
            localStorage.setItem('savedCombinations', JSON.stringify(savedCombinations));

            alert(`é…ç½®"${name}"å·²ä¿å­˜æˆåŠŸï¼`);

            // é‡ç½®è¡¨å•
            nameInput.value = '';
            configCategorySelection = {};
            configCategorySelectorCount = 0;
            document.getElementById('config-category-selection').innerHTML = '';
            document.getElementById('config-distribution-preview').style.display = 'none';
            addConfigCategorySelector();

            // åˆ·æ–°é…ç½®åˆ—è¡¨
            loadConfigList();
        }

        // æ˜¾ç¤º150é¢˜ç­”é¢˜è®°å½•é¡µé¢
        async function showComboRecordsPage() {
            try {
                // è·å–æ‰€æœ‰150é¢˜çš„ç­”é¢˜è®°å½•ï¼ˆç»„åˆç­”é¢˜æ¨¡å¼çš„è®°å½•ï¼‰
                const records = await getAllQuizRecords();
                const comboRecords = records.filter(record =>
                    record.categoryId === 'combined' ||
                    (record.categoryName && record.categoryName.includes('ç»„åˆ'))
                ).sort((a, b) => new Date(b.quizDate) - new Date(a.quizDate));

                // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                displayComboRecordsStats(comboRecords);

                // æ˜¾ç¤ºæˆç»©å¢é•¿è¶‹åŠ¿å›¾
                displayScoreTrendChart(comboRecords);

                // æ˜¾ç¤ºæˆç»©å¢é•¿åˆ†æ
                displayScoreGrowthAnalysis(comboRecords);

                // æ˜¾ç¤ºæˆç»©è®°å½•è¡¨æ ¼
                displayComboRecordsTable(comboRecords);

            } catch (error) {
                console.error('Error showing combo records page:', error);
                document.getElementById('combo-records-table-body').innerHTML =
                    '<tr><td colspan="6" style="text-align: center; color: #f44336;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            }
        }

        // æ˜¾ç¤º150é¢˜ç­”é¢˜è®°å½•çš„ç»Ÿè®¡æ•°æ®
        function displayComboRecordsStats(records) {
            const totalQuizzes = records.length;
            const avgScore = totalQuizzes > 0 ?
                Math.round(records.reduce((sum, r) => sum + r.score, 0) / totalQuizzes * 10) / 10 : 0;
            const bestScore = totalQuizzes > 0 ? Math.max(...records.map(r => r.score)) : 0;
            const latestScore = totalQuizzes > 0 ? records[0].score : '--';

            document.getElementById('total-combo-quizzes').textContent = totalQuizzes;
            document.getElementById('avg-combo-score').textContent = avgScore + '%';
            document.getElementById('best-combo-score').textContent = bestScore + '%';
            document.getElementById('latest-combo-score').textContent = latestScore === '--' ? '--' : latestScore + '%';
        }

        // æ˜¾ç¤ºæˆç»©å¢é•¿è¶‹åŠ¿å›¾
        function displayScoreTrendChart(records) {
            const chartContainer = document.getElementById('score-trend-chart');
            chartContainer.innerHTML = '';

            if (records.length === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #999; width: 100%;">æš‚æ— æ•°æ®</p>';
                return;
            }

            // å–æœ€è¿‘20æ¡è®°å½•ï¼ˆä»æ–°åˆ°æ—§ï¼‰
            const recentRecords = records.slice(0, 20).reverse();
            const maxScore = 100;
            const containerHeight = 300;
            const chartPadding = 40;

            recentRecords.forEach((record, index) => {
                const barHeight = (record.score / maxScore) * (containerHeight - chartPadding);
                const barColor = record.score >= 90 ? '#4caf50' : record.score >= 80 ? '#2196f3' : record.score >= 70 ? '#ff9800' : '#f44336';

                const barElement = document.createElement('div');
                barElement.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    flex: 1;
                    min-width: 40px;
                `;

                barElement.innerHTML = `
                    <div style="
                        width: 100%;
                        height: ${barHeight}px;
                        background: ${barColor};
                        border-radius: 4px 4px 0 0;
                        position: relative;
                        margin-bottom: 5px;
                    ">
                        <span style="
                            position: absolute;
                            top: -22px;
                            left: 50%;
                            transform: translateX(-50%);
                            font-size: 12px;
                            font-weight: bold;
                            color: ${barColor};
                            white-space: nowrap;
                        ">${record.score}%</span>
                    </div>
                    <span style="font-size: 11px; color: #666; text-align: center; width: 100%;">ç¬¬${recentRecords.length - index}æ¬¡</span>
                `;

                chartContainer.appendChild(barElement);
            });
        }

        // æ˜¾ç¤ºæˆç»©å¢é•¿åˆ†æ
        function displayScoreGrowthAnalysis(records) {
            const analysisContainer = document.getElementById('score-growth-analysis');

            if (records.length === 0) {
                analysisContainer.innerHTML = '<p style="color: #999;">æš‚æ— ç­”é¢˜è®°å½•ï¼Œå®Œæˆç»„åˆç­”é¢˜åå°†æ˜¾ç¤ºæˆç»©åˆ†æã€‚</p>';
                return;
            }

            const firstScore = records[records.length - 1].score;
            const lastScore = records[0].score;
            const avgScore = Math.round(records.reduce((sum, r) => sum + r.score, 0) / records.length * 10) / 10;
            const maxScore = Math.max(...records.map(r => r.score));
            const minScore = Math.min(...records.map(r => r.score));

            let growth = lastScore - firstScore;
            let growthPercentage = firstScore > 0 ? ((growth / firstScore) * 100).toFixed(1) : 0;
            let growthColor = growth >= 0 ? '#4caf50' : '#f44336';
            let growthIcon = growth >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            let growthText = growth >= 0 ? `ä¸Šå‡ ${growth.toFixed(1)} åˆ†` : `ä¸‹é™ ${Math.abs(growth).toFixed(1)} åˆ†`;

            analysisContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-size: 14px; color: #666;">é¦–æ¬¡æˆç»©</div>
                        <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-top: 5px;">${firstScore}%</div>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${growthColor};">
                        <div style="font-size: 14px; color: #666;">æˆç»©å˜åŒ–</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${growthColor}; margin-top: 5px;">
                            ${growthIcon} ${growthText}
                        </div>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div style="font-size: 14px; color: #666;">å¹³å‡æˆç»©</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2196f3; margin-top: 5px;">${avgScore}%</div>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="font-size: 14px; color: #666;">æœ€é«˜æˆç»©</div>
                        <div style="font-size: 24px; font-weight: bold; color: #4caf50; margin-top: 5px;">${maxScore}%</div>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <div style="font-size: 14px; color: #666;">æœ€ä½æˆç»©</div>
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800; margin-top: 5px;">${minScore}%</div>
                    </div>

                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <div style="font-size: 14px; color: #666;">æ€»ç­”é¢˜æ¬¡æ•°</div>
                        <div style="font-size: 24px; font-weight: bold; color: #9c27b0; margin-top: 5px;">${records.length}æ¬¡</div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤º150é¢˜ç­”é¢˜è®°å½•è¡¨æ ¼ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function displayComboRecordsTable(records) {
            const tableBody = document.getElementById('combo-records-table-body');
            const noRecordsMsg = document.getElementById('no-records-message');
            const paginationDiv = document.getElementById('combo-records-pagination');

            if (records.length === 0) {
                tableBody.innerHTML = '';
                noRecordsMsg.style.display = 'block';
                paginationDiv.style.display = 'none';
                return;
            }

            noRecordsMsg.style.display = 'none';

            // ä¿å­˜æ•°æ®å’Œé‡ç½®åˆ†é¡µ
            comboRecordsData = records;
            currentComboRecordsPage = 1;

            // è®¡ç®—æ€»é¡µæ•°
            const totalPages = Math.ceil(records.length / comboRecordsPageSize);

            // æ˜¾ç¤ºå½“å‰é¡µçš„æ•°æ®
            displayComboRecordsCurrentPage(totalPages);

            // æ˜¾ç¤ºåˆ†é¡µæ§åˆ¶
            if (totalPages > 1) {
                paginationDiv.style.display = 'block';
                updateComboPaginationUI(totalPages);
            } else {
                paginationDiv.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå½“å‰é¡µçš„æ•°æ®
        function displayComboRecordsCurrentPage(totalPages) {
            const tableBody = document.getElementById('combo-records-table-body');
            tableBody.innerHTML = '';

            const startIndex = (currentComboRecordsPage - 1) * comboRecordsPageSize;
            const endIndex = Math.min(startIndex + comboRecordsPageSize, comboRecordsData.length);
            const pageRecords = comboRecordsData.slice(startIndex, endIndex);

            pageRecords.forEach((record) => {
                const date = new Date(record.quizDate);
                const dateStr = date.toLocaleString('zh-CN');
                const correctRate = Math.round((record.correctAnswers / record.totalQuestions) * 100 * 10) / 10;

                let timeDisplay = 'æœªè®°å½•';
                if (record.timeSpent) {
                    const minutes = Math.floor(record.timeSpent / 60);
                    const seconds = record.timeSpent % 60;
                    timeDisplay = `${minutes}åˆ†${seconds}ç§’`;
                }

                let scoreColor = record.score >= 90 ? '#4caf50' : record.score >= 80 ? '#2196f3' : record.score >= 70 ? '#ff9800' : '#f44336';

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f0f0f0';
                row.innerHTML = `
                    <td style="padding: 15px; text-align: left;">${dateStr}</td>
                    <td style="padding: 15px; font-weight: bold; color: ${scoreColor}; font-size: 18px;">${record.score}åˆ†</td>
                    <td style="padding: 15px;">${correctRate}%</td>
                    <td style="padding: 15px;">${record.correctAnswers}/${record.totalQuestions}</td>
                    <td style="padding: 15px;">${timeDisplay}</td>
                    <td style="padding: 15px;">
                        <button class="btn btn-small" onclick="deleteComboRecord(${record.id})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            åˆ é™¤
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // æ›´æ–°é¡µç æ˜¾ç¤º
            document.getElementById('combo-current-page').textContent = currentComboRecordsPage;
            document.getElementById('combo-total-pages').textContent = totalPages;
        }

        // æ›´æ–°åˆ†é¡µUI
        function updateComboPaginationUI(totalPages) {
            const paginationNumbers = document.getElementById('combo-pagination-numbers');
            paginationNumbers.innerHTML = '';

            // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentComboRecordsPage - 2);
            let endPage = Math.min(totalPages, currentComboRecordsPage + 2);

            // å¦‚æœé¡µæ•°è¾ƒå°‘ï¼Œè°ƒæ•´èŒƒå›´
            if (totalPages <= 5) {
                startPage = 1;
                endPage = totalPages;
            } else if (startPage === 1) {
                endPage = Math.min(5, totalPages);
            } else if (endPage === totalPages) {
                startPage = Math.max(1, totalPages - 4);
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.style.cssText = `
                    padding: 8px 12px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    cursor: pointer;
                    background: ${i === currentComboRecordsPage ? '#667eea' : 'white'};
                    color: ${i === currentComboRecordsPage ? 'white' : '#333'};
                    font-weight: ${i === currentComboRecordsPage ? 'bold' : 'normal'};
                `;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToComboRecordsPage(i);
                paginationNumbers.appendChild(pageBtn);
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToComboRecordsPage(pageNum) {
            const totalPages = Math.ceil(comboRecordsData.length / comboRecordsPageSize);

            if (pageNum === 'last') {
                currentComboRecordsPage = totalPages;
            } else if (typeof pageNum === 'number') {
                if (pageNum >= 1 && pageNum <= totalPages) {
                    currentComboRecordsPage = pageNum;
                } else {
                    return;
                }
            }

            displayComboRecordsCurrentPage(totalPages);
            updateComboPaginationUI(totalPages);
        }

        // ä¸Šä¸€é¡µ
        function previousComboRecordsPage() {
            if (currentComboRecordsPage > 1) {
                goToComboRecordsPage(currentComboRecordsPage - 1);
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextComboRecordsPage() {
            const totalPages = Math.ceil(comboRecordsData.length / comboRecordsPageSize);
            if (currentComboRecordsPage < totalPages) {
                goToComboRecordsPage(currentComboRecordsPage + 1);
            }
        }

        // åˆ é™¤150é¢˜è®°å½•
        async function deleteComboRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const transaction = db.transaction(['quizRecords'], 'readwrite');
                const store = transaction.objectStore('quizRecords');
                await new Promise((resolve, reject) => {
                    const request = store.delete(recordId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });

                alert('è®°å½•å·²åˆ é™¤');
                showComboRecordsPage();

            } catch (error) {
                console.error('Error deleting combo record:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åº”ç”¨ç®€å•çš„ä¸‹æ‹‰æ¡†å¢å¼ºï¼ˆæœç´¢åŠŸèƒ½ï¼‰
        function applySimpleSelectEnhance() {
            if (typeof window.enhanceAllSelects === 'function') {
                window.enhanceAllSelects();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååº”ç”¨å¢å¼º
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(applySimpleSelectEnhance, 1500);
        });

        // éªŒè¯å‡½æ•°
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            
            // éªŒè¯zuoming
            if (username === 'zuoming' && password === '123456') {
                // æˆåŠŸï¼Œéšè—ç•Œé¢
                document.getElementById('loginOverlay').style.display = 'none';
                errorElement.classList.remove('show');
            } else {
                // å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                errorElement.classList.add('show');
            }
        }
    </script>

    <!-- å¼•å…¥ç®€åŒ–ç‰ˆä¸‹æ‹‰æ¡†å¢å¼ºç»„ä»¶ -->
    <script src="simple-select-enhance.js"></script>
</body>
</html>
